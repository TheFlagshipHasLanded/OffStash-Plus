<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="OffStash+" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192.svg" />
  <title>OffStash+</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,400&family=Space+Grotesk:wght@300;400;500;600;700&display=swap');

    :root {
      --bg: #0a0a0a;
      --bg2: #111111;
      --bg3: #1a1a1a;
      --border: #222222;
      --border2: #2a2a2a;
      --text: #e8e8e8;
      --text2: #888888;
      --text3: #444444;
      --accent: #c8ff00;
      --accent2: #ff6b35;
      --accent3: #00d4ff;
      --card: #111111;
      --input: #161616;
      --radius: 8px;
      --mono: 'DM Mono', monospace;
      --sans: 'Space Grotesk', sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--sans);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      overscroll-behavior: none;
      overflow-x: hidden;
      max-width: 100vw;
    }

    /* ADD MENU */
    .add-menu-wrap { position: relative; }
    .add-menu {
      position: fixed; top: auto; right: 12px;
      background: var(--bg2); border: 1px solid var(--border2);
      border-radius: var(--radius); overflow: hidden;
      min-width: 180px; z-index: 9999;
      box-shadow: 0 8px 32px rgba(0,0,0,0.8);
    }
    .add-menu-item {
      display: block; width: 100%; background: none; border: none;
      color: var(--text); padding: 11px 16px; text-align: left;
      cursor: pointer; font-family: var(--sans); font-size: 13px;
      transition: background 0.12s;
    }
    .add-menu-item:hover { background: var(--bg3); color: var(--accent); }

    /* FOLDER ROW */
    .folder-row {
      padding: 8px 20px;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
    }
    .folder-row-inner {
      display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
    }
    .folder-row-label {
      font-family: var(--mono); font-size: 10px;
      letter-spacing: 0.08em; text-transform: uppercase;
      color: var(--text3); flex-shrink: 0;
    }
    .folder-pills {
      display: flex; gap: 6px; flex-wrap: wrap; align-items: center;
    }
    .folder-pill {
      background: transparent; border: 1px solid var(--border);
      color: var(--text2); padding: 4px 10px;
      border-radius: 20px; cursor: pointer;
      font-family: var(--mono); font-size: 11px;
      letter-spacing: 0.04em; transition: all 0.15s;
      display: flex; align-items: center; gap: 6px; white-space: nowrap;
    }
    .folder-pill:hover { color: var(--text); border-color: var(--border2); }
    .folder-pill.active { background: #1a1a00; color: var(--accent); border-color: var(--accent); }
    .folder-pill.drag-target { border-color: var(--accent); background: #1a2000; }
    .folder-pill-del {
      background: none; border: none; color: var(--text3);
      cursor: pointer; font-size: 11px; padding: 0; line-height: 1;
    }
    .folder-pill-del:hover { color: #ff4444; }
    .btn-new-folder {
      background: transparent; border: 1px dashed var(--border2);
      color: var(--text3); padding: 4px 10px; border-radius: 20px;
      cursor: pointer; font-family: var(--mono); font-size: 11px;
      letter-spacing: 0.04em; transition: all 0.15s; white-space: nowrap;
    }
    .btn-new-folder:hover { color: var(--accent); border-color: var(--accent); }

    /* FOLDER CARD in grid */
    .folder-card {
      background: var(--bg3); border: 1px solid var(--border);
      border-radius: 10px; padding: 16px; cursor: pointer;
      transition: all 0.15s; position: relative;
      display: flex; flex-direction: column; gap: 8px;
      min-height: 100px;
    }
    .folder-card.drag-target { border-color: var(--accent); background: #1a2000; }
    .folder-card:hover { border-color: var(--border2); background: #1c1c1c; }
    .folder-card-icon { font-size: 28px; }
    .folder-card-name {
      font-size: 14px; font-weight: 600; color: var(--text);
    }
    .folder-card-count {
      font-family: var(--mono); font-size: 10px;
      color: var(--text3); letter-spacing: 0.05em;
    }
    .folder-card-actions {
      position: absolute; top: 10px; right: 10px;
      display: flex; gap: 6px;
    }
    .folder-card-btn {
      background: var(--bg); border: 1px solid var(--border);
      color: var(--text3); width: 26px; height: 26px;
      border-radius: 4px; cursor: pointer; font-size: 12px;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.12s;
    }
    .folder-card-btn:hover { color: var(--text); border-color: var(--border2); }
    .folder-card-btn.del:hover { color: #ff4444; border-color: #ff4444; }

    /* Draggable entry cards */
    .card[draggable="true"] { cursor: grab; }
    .card[draggable="true"]:active { cursor: grabbing; }
    .card.dragging { opacity: 0.4; }

    /* Folder badge on entry cards */
    .card-folder-badge {
      font-family: var(--mono); font-size: 9px;
      letter-spacing: 0.06em; text-transform: uppercase;
      color: var(--accent); background: #1a1a00;
      border: 1px solid #2a2a00; padding: 2px 6px;
      border-radius: 4px; margin-bottom: 4px; display: inline-block;
    }

    @media (min-width: 900px) {
      .folder-row { padding: 8px 32px; }
    }

    /* OFFLINE BANNER */
    #offline-banner {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0;
      background: #1a1200;
      border-bottom: 1px solid #ff6b35;
      color: #ff6b35;
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: 0.08em;
      padding: 6px 16px;
      text-align: center;
      z-index: 9999;
    }
    #offline-banner.show { display: block; }

    /* LAYOUT */
    #app {
      max-width: 1200px;
      margin: 0 auto;
      padding: env(safe-area-inset-top, 0) env(safe-area-inset-right, 0) env(safe-area-inset-bottom, 0) env(safe-area-inset-left, 0);
      padding-top: calc(env(safe-area-inset-top, 0px) + 0px);
    }

    /* HEADER */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 20px 16px;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      background: var(--bg);
      z-index: 9998;
      gap: 12px;
      width: 100%;
      box-sizing: border-box;
      overflow: visible;
    }

    .logo {
      display: flex;
      align-items: baseline;
      gap: 4px;
      flex-shrink: 0;
    }

    .logo-text {
      font-family: var(--mono);
      font-size: 18px;
      font-weight: 500;
      color: var(--text);
      letter-spacing: -0.02em;
    }

    .logo-plus {
      font-family: var(--mono);
      font-size: 18px;
      color: var(--accent);
    }

    .header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-shrink: 0;
    }

    .icon-btn {
      background: var(--bg3);
      border: 1px solid var(--border);
      color: var(--text2);
      height: 36px;
      padding: 0 12px;
      border-radius: var(--radius);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.15s;
      font-size: 13px;
      font-family: var(--sans);
      flex-shrink: 0;
      white-space: nowrap;
    }
    .icon-btn:hover { color: var(--text); border-color: var(--border2); background: #222; }
    .icon-btn:active { transform: scale(0.95); }
    .icon-btn .btn-icon { font-size: 14px; }
    /* Hide labels on very small screens */
    /* Mobile header ‚Äî hide labels, shrink buttons */
    @media (max-width: 699px) {
      .icon-btn .btn-label { display: none; }
      .icon-btn { padding: 0; width: 34px; height: 34px; }
      .btn-add { padding: 0 10px; height: 34px; font-size: 12px; }
      .header-actions { gap: 5px; }
      header { padding: 10px 12px; }
    }
    @media (max-width: 380px) {
      .icon-btn { width: 30px; height: 30px; }
      .btn-add { padding: 0 8px; font-size: 11px; }
      .header-actions { gap: 4px; }
    }

    .btn-add {
      background: var(--accent);
      color: #000;
      border: none;
      height: 36px;
      padding: 0 14px;
      border-radius: var(--radius);
      cursor: pointer;
      font-family: var(--sans);
      font-weight: 600;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s;
      flex-shrink: 0;
    }
    .btn-add:hover { background: #d4ff00; }
    .btn-add:active { transform: scale(0.95); }

    /* SEARCH */
    .search-wrap {
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
    }

    .search-input {
      width: 100%;
      background: var(--input);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 14px 10px 38px;
      border-radius: var(--radius);
      font-family: var(--sans);
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s;
      position: relative;
    }
    .search-input:focus { border-color: var(--border2); }
    .search-input::placeholder { color: var(--text3); }

    .search-wrap .search-icon {
      position: absolute;
      left: 33px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text3);
      font-size: 15px;
      pointer-events: none;
    }
    .search-container { position: relative; }

    /* TABS ‚Äî mobile: scrollable pills, desktop: dropdown */
    .tabs-wrap {
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
      box-sizing: border-box;
      width: 100%;
      overflow: hidden;
      position: relative;
      z-index: 1;
    }

    /* Mobile pill tabs */
    .tabs-mobile {
      display: flex;
      gap: 6px;
      overflow-x: auto;
      scrollbar-width: none;
    }
    .tabs-mobile::-webkit-scrollbar { display: none; }

    .tab {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text2);
      padding: 6px 12px;
      border-radius: 20px;
      cursor: pointer;
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      transition: all 0.15s;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .tab:hover { color: var(--text); border-color: var(--border2); }
    .tab.active {
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
      font-weight: 500;
    }

    /* Desktop dropdown */
    .tabs-desktop { display: none; align-items: center; gap: 10px; }

    .cat-dropdown {
      appearance: none;
      -webkit-appearance: none;
      background: var(--input);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 36px 8px 14px;
      border-radius: var(--radius);
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      cursor: pointer;
      outline: none;
      min-width: 220px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23666' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      transition: border-color 0.15s;
    }
    .cat-dropdown:focus { border-color: var(--accent); }
    .cat-dropdown option { background: var(--bg2); text-transform: uppercase; }

    .cat-dropdown-label {
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text3);
    }

    /* EMPTY DROP ZONE */
    .empty-drop-zone {
      border: 2px dashed var(--border2);
      border-radius: 16px;
      padding: 40px 30px;
      transition: all 0.2s;
      cursor: pointer;
    }
    .empty-drop-zone.drag-over {
      border-color: var(--accent);
      background: #1a2000;
    }
    .empty-drop-zone.drag-over .empty-icon { color: var(--accent); }
    .empty-drop-hint {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text3);
      margin-top: 10px;
      letter-spacing: 0.05em;
    }

    /* ATTACHMENTS & LINKS */
    .attach-zone {
      border: 1px dashed var(--border2);
      border-radius: var(--radius);
      padding: 14px;
      text-align: center;
      cursor: pointer;
      transition: all 0.15s;
      color: var(--text3);
      font-size: 12px;
      font-family: var(--mono);
      letter-spacing: 0.04em;
    }
    .attach-zone:hover { border-color: var(--accent); color: var(--accent); }

    .attach-list { display: flex; flex-direction: column; gap: 6px; margin-top: 8px; }
    .attach-item {
      display: flex; align-items: center; gap: 8px;
      background: var(--bg3); border: 1px solid var(--border);
      border-radius: 6px; padding: 8px 10px; font-size: 12px;
    }
    .attach-icon { font-size: 16px; flex-shrink: 0; }
    .attach-name { flex: 1; color: var(--text2); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .attach-size { font-family: var(--mono); font-size: 10px; color: var(--text3); flex-shrink: 0; }
    .attach-remove {
      background: none; border: none; color: var(--text3); cursor: pointer;
      font-size: 14px; padding: 0 2px; line-height: 1; flex-shrink: 0;
    }
    .attach-remove:hover { color: #ff4444; }
    .attach-warning { color: #ff6b35; font-family: var(--mono); font-size: 10px; margin-top: 4px; }

    /* DESKTOP 2-COL FORM */
    .form-desktop-cols {
      display: flex;
      flex-direction: column;
      gap: 0;
    }
    .form-col { display: flex; flex-direction: column; }

    @media (min-width: 700px) {
      .form-desktop-cols {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0 16px;
        align-items: start;
      }
      /* Make right col content fill height */
      .form-col:last-child {
        display: flex;
        flex-direction: column;
      }
      .form-col:last-child .form-group:first-child {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .form-col:last-child .form-group:first-child textarea {
        flex: 1;
        height: auto;
        min-height: 100px;
      }
    }

    /* SUGGESTED TAGS ‚Äî always 2 rows of 4 */
    .suggested-tags {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 4px;
      margin-top: 4px;
    }
    .suggested-tag {
      background: transparent; border: 1px dashed var(--border2);
      color: var(--text3); padding: 3px 6px; border-radius: 20px;
      cursor: pointer; font-family: var(--mono); font-size: 10px;
      letter-spacing: 0.04em; transition: all 0.15s;
      text-align: center; overflow: hidden;
      text-overflow: ellipsis; white-space: nowrap;
    }
    .suggested-tag:hover { border-color: var(--accent); color: var(--accent); background: #1a2000; }
    .suggested-tag.used { opacity: 0.3; pointer-events: none; text-decoration: line-through; }

    .link-row { display: flex; gap: 8px; margin-bottom: 6px; }
    .link-row input { flex: 1; }
    .link-row input:first-child { flex: 2; }
    .btn-add-link {
      background: var(--bg3); border: 1px solid var(--border); color: var(--text2);
      padding: 0 12px; border-radius: var(--radius); cursor: pointer; font-size: 18px;
      transition: all 0.15s; flex-shrink: 0; height: 40px;
    }
    .btn-add-link:hover { color: var(--accent); border-color: var(--accent); }

    .link-list { display: flex; flex-direction: column; gap: 6px; margin-top: 4px; }
    .link-item {
      display: flex; align-items: center; gap: 8px;
      background: var(--bg3); border: 1px solid var(--border);
      border-radius: 6px; padding: 8px 10px;
    }
    .link-anchor {
      flex: 1; color: var(--accent3); font-size: 12px; text-decoration: none;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .link-anchor:hover { text-decoration: underline; }
    .link-label-text { font-size: 12px; color: var(--text2); margin-right: 4px; }

    /* View modal sections */
    .view-section-title {
      font-family: var(--mono); font-size: 10px; letter-spacing: 0.08em;
      text-transform: uppercase; color: var(--text3); margin: 18px 0 8px;
    }
    .view-attach-item {
      display: flex; align-items: center; gap: 10px;
      background: var(--bg3); border: 1px solid var(--border);
      border-radius: 6px; padding: 10px 12px; margin-bottom: 6px;
    }
    .view-attach-btn {
      background: var(--bg); border: 1px solid var(--border);
      color: var(--text2); padding: 4px 10px; border-radius: 4px;
      font-family: var(--mono); font-size: 10px; cursor: pointer;
      text-decoration: none; transition: all 0.15s; flex-shrink: 0;
      display: inline-block;
    }
    .view-attach-btn:hover { color: var(--accent); border-color: var(--accent); }
    .view-attach-btn.view-btn { color: var(--accent3); border-color: #002a30; }
    .view-attach-btn.view-btn:hover { background: #001a20; }
    .attach-actions { display: flex; gap: 6px; margin-left: auto; flex-shrink: 0; }

    /* INLINE VIEWER */
    #viewer-modal { border-radius: 16px 16px 0 0; }
    #viewer-body img {
      max-width: 100%; max-height: 100%;
      object-fit: contain; border-radius: 4px;
    }
    #viewer-body iframe {
      width: 100%; height: 100%;
      border: none; border-radius: 4px; background: #fff;
    }
    #viewer-body .viewer-text {
      width: 100%; height: 100%; overflow: auto;
      font-family: var(--mono); font-size: 12px;
      color: var(--text2); white-space: pre-wrap;
      word-break: break-word; padding: 16px; line-height: 1.6;
    }
    #viewer-body .viewer-unsupported {
      text-align: center; color: var(--text3);
      font-family: var(--mono); font-size: 13px; padding: 40px;
    }
    #viewer-body .viewer-unsupported .big { font-size: 48px; display: block; margin-bottom: 16px; }

    /* CONTENT */
    .content {
      padding: 16px 20px;
      box-sizing: border-box;
      width: 100%;
      overflow-x: hidden;
    }

    /* STATS BAR */
    .stats-bar {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text3);
      letter-spacing: 0.05em;
    }

    /* GRID */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 12px;
    }

    /* CARD */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.15s;
      position: relative;
      overflow: hidden;
    }
    .card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 2px;
      background: var(--cat-color, var(--border));
    }
    .card:hover {
      border-color: var(--border2);
      background: #161616;
      transform: translateY(-1px);
    }
    .card:active { transform: scale(0.99); }

    .card-cat {
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--cat-color, var(--text3));
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 6px;
      line-height: 1.3;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .card-preview {
      font-size: 12px;
      color: var(--text2);
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .card-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 12px;
    }

    .card-date {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--text3);
    }

    .card-tags {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .tag {
      background: var(--bg3);
      border: 1px solid var(--border);
      color: var(--text3);
      font-family: var(--mono);
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 4px;
      letter-spacing: 0.04em;
    }

    /* EMPTY STATE */
    .empty {
      text-align: center;
      padding: 40px 16px;
      color: var(--text3);
      box-sizing: border-box;
      width: 100%;
      overflow: hidden;
    }
    .empty-icon { font-size: 40px; margin-bottom: 12px; }
    .empty-title {
      font-family: var(--mono);
      font-size: 13px;
      letter-spacing: 0.05em;
      margin-bottom: 6px;
      color: var(--text2);
    }
    .empty-sub { font-size: 12px; }

    /* MODAL OVERLAY */
    /* OVERLAY ‚Äî dim backdrop */
    .overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      z-index: 200;
    }
    .overlay.show { display: block; }

    /* MODAL ‚Äî fixed sheet anchored to bottom, never uses flexbox height tricks */
    /* Mobile: sheet from bottom */
    /* Modal ‚Äî auto height, scrolls only when content exceeds screen */
    .modal {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      z-index: 201;
      background: var(--bg2);
      border: 1px solid var(--border2);
      border-bottom: none;
      border-radius: 16px 16px 0 0;
      width: 100%;
      max-width: 680px;
      margin: 0 auto;
      height: auto;
      max-height: 95vh;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }
    .overlay.show + .modal,
    .modal.show {
      display: flex;
    }
    /* Desktop: centered dialog */
    @media (min-width: 700px) {
      .modal {
        top: 50%;
        bottom: auto;
        left: 50%;
        transform: translate(-50%, -50%);
        border-radius: 16px;
        border: 1px solid var(--border2);
        height: auto;
        max-height: 92vh;
        width: calc(100% - 48px);
        max-width: 820px;
      }
    }
    .modal-inner {
      overflow-y: auto;
      overflow-x: hidden;
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
      padding: 0 20px 8px;
    }
    .modal-header {
      padding: 6px 20px 4px;
      flex-shrink: 0;
    }

    .modal-handle {
      width: 36px;
      height: 4px;
      background: var(--border2);
      border-radius: 2px;
      margin: 0 auto 6px;
    }

    .modal-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 0;
    }

    .form-group {
      margin-bottom: 6px;
    }

    label {
      display: block;
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text2);
      margin-bottom: 4px;
    }

    input[type="text"], textarea, select {
      width: 100%;
      background: var(--input);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 6px 10px;
      border-radius: var(--radius);
      font-family: var(--sans);
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s;
    }
    input[type="text"]:focus,
    textarea:focus,
    select:focus { border-color: var(--accent); }
    textarea { resize: none; height: 90px; line-height: 1.5; }
    select option { background: var(--bg2); }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 6px;
    }

    .btn-save {
      flex: 1;
      background: var(--accent);
      color: #000;
      border: none;
      height: 38px;
      border-radius: var(--radius);
      cursor: pointer;
      font-family: var(--sans);
      font-weight: 700;
      font-size: 14px;
      transition: all 0.15s;
    }
    .btn-save:hover { background: #d4ff00; }

    .btn-cancel {
      background: var(--bg3);
      color: var(--text2);
      border: 1px solid var(--border);
      height: 38px;
      padding: 0 20px;
      border-radius: var(--radius);
      cursor: pointer;
      font-family: var(--sans);
      font-size: 14px;
      transition: all 0.15s;
    }
    .btn-cancel:hover { color: var(--text); }

    .btn-danger {
      background: #1a0000;
      color: #ff4444;
      border: 1px solid #330000;
      height: 38px;
      padding: 0 20px;
      border-radius: var(--radius);
      cursor: pointer;
      font-family: var(--sans);
      font-size: 14px;
      transition: all 0.15s;
    }
    .btn-danger:hover { background: #220000; }

    /* VIEW MODAL */
    .view-content {
      font-size: 14px;
      line-height: 1.7;
      color: var(--text2);
      white-space: pre-wrap;
      word-break: break-word;
    }

    .view-meta {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      align-items: center;
    }

    .view-cat-badge {
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      padding: 4px 8px;
      border-radius: 4px;
    }

    /* CATEGORY COLORS */
    .cat-finance  { --cat-color: #c8ff00; }
    .cat-health   { --cat-color: #ff6b9d; }
    .cat-recipes  { --cat-color: #ff6b35; }
    .cat-home     { --cat-color: #ffd166; }
    .cat-work     { --cat-color: #00d4ff; }
    .cat-travel   { --cat-color: #06ffa5; }
    .cat-learning { --cat-color: #a78bfa; }
    .cat-ideas    { --cat-color: #f97316; }
    .cat-notes    { --cat-color: #94a3b8; }
    .cat-photos   { --cat-color: #f472b6; }

    .cat-badge-finance  { background: #1a2000; color: #c8ff00; border: 1px solid #2a3800; }
    .cat-badge-health   { background: #1a0010; color: #ff6b9d; border: 1px solid #2a0020; }
    .cat-badge-recipes  { background: #1a0e00; color: #ff6b35; border: 1px solid #2a1800; }
    .cat-badge-home     { background: #1a1600; color: #ffd166; border: 1px solid #2a2200; }
    .cat-badge-work     { background: #001a20; color: #00d4ff; border: 1px solid #002a30; }
    .cat-badge-travel   { background: #001a10; color: #06ffa5; border: 1px solid #002a18; }
    .cat-badge-learning { background: #130020; color: #a78bfa; border: 1px solid #1e0030; }
    .cat-badge-ideas    { background: #1a0800; color: #f97316; border: 1px solid #2a1200; }
    .cat-badge-notes    { background: #111620; color: #94a3b8; border: 1px solid #1a2030; }
    .cat-badge-photos   { background: #1a0015; color: #f472b6; border: 1px solid #2a0025; }

    /* TOAST */
    #toast {
      position: fixed;
      bottom: calc(20px + env(safe-area-inset-bottom, 0px));
      left: 50%;
      transform: translateX(-50%) translateY(80px);
      background: var(--bg3);
      border: 1px solid var(--border2);
      color: var(--text);
      padding: 10px 18px;
      border-radius: 20px;
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing: 0.04em;
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 9999;
      white-space: nowrap;
    }
    #toast.show { transform: translateX(-50%) translateY(0); }

    /* SCROLLBAR */
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

    @media (max-width: 480px) {
      .grid { grid-template-columns: 1fr; }
      .form-row { grid-template-columns: 1fr; }
    }
    @media (min-width: 700px) {
      .tabs-mobile { display: none; }
      .tabs-desktop { display: flex; }
    }
    @media (max-width: 699px) {
      .tabs-mobile { display: flex; }
      .tabs-desktop { display: none; }
    }
    @media (min-width: 900px) {
      .grid { grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); }
      header { padding: 20px 32px 16px; }
      .search-wrap { padding: 14px 32px; }
      .tabs-wrap { padding: 12px 32px; }
      .content { padding: 20px 32px; }
    }
  </style>
</head>
<body>

<!-- CONFIRM MODAL -->
<div class="overlay" id="confirm-overlay"></div>
<div class="modal" id="confirm-modal" style="max-width:420px;">
  <div class="modal-header" style="padding-bottom:8px;">
    <div class="modal-handle"></div>
    <div class="modal-title" id="confirm-title" style="font-size:15px;">Are you sure?</div>
  </div>
  <div class="modal-inner" style="padding-top:4px;">
    <div id="confirm-message" style="font-size:13px;color:var(--text2);line-height:1.6;margin-bottom:16px;"></div>
    <div class="modal-actions">
      <button class="btn-cancel" id="confirm-cancel-btn">Cancel</button>
      <button class="btn-danger" id="confirm-ok-btn" style="flex:1;">Delete</button>
    </div>
  </div>
</div>

<!-- RENAME MODAL -->
<div class="overlay" id="rename-overlay"></div>
<div class="modal" id="rename-modal" style="max-width:420px;">
  <div class="modal-header" style="padding-bottom:8px;">
    <div class="modal-handle"></div>
    <div class="modal-title" style="font-size:15px;">Rename Folder</div>
  </div>
  <div class="modal-inner" style="padding-top:4px;">
    <div class="form-group">
      <label>New name</label>
      <input type="text" id="rename-input" placeholder="Folder name‚Ä¶" />
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" id="rename-cancel-btn">Cancel</button>
      <button class="btn-save" id="rename-ok-btn">Rename</button>
    </div>
  </div>
</div>

<!-- Full-page drag hint -->
<div id="drop-overlay-hint" style="display:none;position:fixed;inset:0;z-index:9998;background:rgba(0,0,0,0.85);align-items:center;justify-content:center;flex-direction:column;gap:16px;pointer-events:none;">
  <div style="font-size:64px;">üìÇ</div>
  <div style="font-family:var(--mono);font-size:16px;color:var(--accent);letter-spacing:0.08em;">DROP FILES TO IMPORT</div>
  <div style="font-family:var(--mono);font-size:12px;color:var(--text2);">PDFs, images, docs ‚Äî any file type</div>
</div>

<div id="offline-banner">‚ö° Offline Mode ‚Äî Viewing cached stash</div>
<div id="toast"></div>

<div id="app">
  <header>
    <div class="logo">
      <span class="logo-text">OffStash</span>
      <span class="logo-plus">+</span>
    </div>
    <div class="header-actions">
      <button class="icon-btn" id="import-files-btn" title="Import Files (PDF, images, docs)">
        <span class="btn-icon">üìÅ</span><span class="btn-label">Import Files</span>
      </button>
      <button class="icon-btn" id="import-btn" title="Import JSON backup">
        <span class="btn-icon">‚¨Ü</span><span class="btn-label">Import JSON</span>
      </button>
      <button class="icon-btn" id="export-btn" title="Export JSON backup">
        <span class="btn-icon">‚¨á</span><span class="btn-label">Export JSON</span>
      </button>
      <div class="add-menu-wrap" id="add-menu-wrap">
      <button class="btn-add" id="add-btn">+ Add ‚ñæ</button>
      <div class="add-menu" id="add-menu" style="display:none">
        <button class="add-menu-item" id="add-entry-btn">üìù New Entry</button>
        <button class="add-menu-item" id="add-folder-btn">üìÅ New Folder</button>
      </div>
    </div>
    </div>
  </header>

  <div class="search-wrap">
    <div class="search-container">
      <span class="search-icon">‚åï</span>
      <input type="text" class="search-input" id="search" placeholder="Search titles, content, tags‚Ä¶" autocomplete="off" autocorrect="off" />
    </div>
  </div>

  <div class="tabs-wrap">
    <!-- Mobile: scrollable pills -->
    <div class="tabs-mobile" id="tabs">
      <button class="tab active" data-cat="all">All</button>
      <button class="tab" data-cat="finance">Finance & Money</button>
      <button class="tab" data-cat="health">Health & Medical</button>
      <button class="tab" data-cat="recipes">Recipes & Food</button>
      <button class="tab" data-cat="home">Home & DIY</button>
      <button class="tab" data-cat="work">Work & Career</button>
      <button class="tab" data-cat="travel">Travel</button>
      <button class="tab" data-cat="learning">Learning & Research</button>
      <button class="tab" data-cat="ideas">Ideas & Projects</button>
      <button class="tab" data-cat="notes">Personal Notes</button>
      <button class="tab" data-cat="photos">Photos & Images</button>
    </div>
    <!-- Desktop: dropdown selector -->
    <div class="tabs-desktop">
      <span class="cat-dropdown-label">Category</span>
      <select class="cat-dropdown" id="cat-dropdown">
        <option value="all">All Categories</option>
        <option value="finance">Finance & Money</option>
        <option value="health">Health & Medical</option>
        <option value="recipes">Recipes & Food</option>
        <option value="home">Home & DIY</option>
        <option value="work">Work & Career</option>
        <option value="travel">Travel</option>
        <option value="learning">Learning & Research</option>
        <option value="ideas">Ideas & Projects</option>
        <option value="notes">Personal Notes</option>
        <option value="photos">Photos &amp; Images</option>
      </select>
    </div>
  </div>

  <!-- FOLDER ROW -->
  <div class="folder-row" id="folder-row" style="display:none">
    <div class="folder-row-inner">
      <span class="folder-row-label">üìÅ Folders</span>
      <div class="folder-pills" id="folder-pills"></div>
    </div>
  </div>

  <div class="content">
    <div class="stats-bar">
      <span id="count-text">0 entries</span>
      <span id="filter-text"></span>
    </div>
    <div class="grid" id="grid"></div>
    <div class="empty" id="empty" style="display:none">
      <div class="empty-drop-zone" id="empty-drop-zone">
        <div class="empty-icon" id="empty-icon">‚óª</div>
        <div class="empty-title" id="empty-title">Stash is empty</div>
        <div class="empty-sub">Tap <strong>+ Add</strong> to create an entry, or<br/>drop files here to import them</div>
        <div class="empty-drop-hint">üìÇ Drop PDFs, images, or any file</div>
      </div>
    </div>
  </div>
</div>

<!-- ADD/EDIT MODAL -->
<div class="overlay" id="form-overlay"></div>
<div class="modal" id="form-modal">
  <div class="modal-header">
    <div class="modal-handle"></div>
    <div class="modal-title" id="form-title">New Entry</div>
  </div>
  <div class="modal-inner">
    <!-- Title spans full width -->
    <div class="form-group">
      <label>Title</label>
      <input type="text" id="f-title" placeholder="Entry title‚Ä¶" />
    </div>
    <!-- Desktop 2-col layout -->
    <div class="form-desktop-cols">
      <!-- LEFT -->
      <div class="form-col">
        <div class="form-group">
          <label>Category</label>
          <select id="f-cat">
            <option value="finance">Finance &amp; Money</option>
            <option value="health">Health &amp; Medical</option>
            <option value="recipes">Recipes &amp; Food</option>
            <option value="home">Home &amp; DIY</option>
            <option value="work">Work &amp; Career</option>
            <option value="travel">Travel</option>
            <option value="learning">Learning &amp; Research</option>
            <option value="ideas">Ideas &amp; Projects</option>
            <option value="notes">Personal Notes</option>
            <option value="photos">Photos &amp; Images</option>
          </select>
        </div>
        <div class="form-group">
          <label>Tags (comma separated)</label>
          <input type="text" id="f-tags" placeholder="add tags‚Ä¶" />
          <div class="suggested-tags" id="suggested-tags"></div>
        </div>
        <div class="form-group">
          <label>Summary / Preview</label>
          <input type="text" id="f-summary" placeholder="Short description‚Ä¶" />
        </div>
        <div class="form-group">
          <label>Folder (optional)</label>
          <div style="display:flex;gap:8px;align-items:center;">
            <select id="f-folder" style="flex:1;"><option value="">‚Äî No folder ‚Äî</option></select>
            <span style="color:var(--text3);font-size:12px;white-space:nowrap;">or new:</span>
            <input type="text" id="f-folder-new" placeholder="Type new folder name‚Ä¶" style="flex:1;" />
          </div>
        </div>
        <div class="form-group">
          <label>Links</label>
          <div class="link-row">
            <input type="text" id="f-link-url" placeholder="https://‚Ä¶" />
            <input type="text" id="f-link-label" placeholder="Label (optional)" />
            <button class="btn-add-link" id="add-link-btn" type="button">+</button>
          </div>
          <div class="link-list" id="link-list"></div>
        </div>
      </div>
      <!-- RIGHT -->
      <div class="form-col">
        <div class="form-group" style="display:flex;flex-direction:column;flex:1;">
          <label>Content / Notes</label>
          <textarea id="f-content" placeholder="Paste your full notes, guide, recipe steps‚Ä¶" style="flex:1;height:100%;min-height:120px;"></textarea>
        </div>
        <div class="form-group">
          <label>Attachments</label>
          <div class="attach-zone" id="attach-zone" onclick="document.getElementById('attach-file-input').click()">
            üìé Tap to attach files (PDF, images, docs‚Ä¶)
          </div>
          <input type="file" id="attach-file-input" multiple style="display:none" />
          <div class="attach-list" id="attach-list"></div>
          <div class="attach-warning" id="attach-warning"></div>
        </div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" id="form-cancel">Cancel</button>
      <button class="btn-danger" id="form-delete" style="display:none">Delete</button>
      <button class="btn-save" id="form-save">Save Entry</button>
    </div>
  </div>
</div>

<!-- VIEW MODAL -->
<div class="overlay" id="view-overlay"></div>
<div class="modal" id="view-modal">
  <div class="modal-header">
    <div class="modal-handle"></div>
    <div class="view-meta">
      <span class="view-cat-badge" id="view-cat-badge"></span>
      <span class="card-date" id="view-date"></span>
    </div>
    <div class="modal-title" id="view-title"></div>
  </div>
  <div class="modal-inner">
    <div id="view-tags" class="card-tags" style="margin-bottom:16px"></div>
    <div id="view-summary" style="font-size:13px;color:var(--text2);margin-bottom:16px;font-style:italic;"></div>
    <div class="view-content" id="view-content"></div>
    <div id="view-attachments-section" style="display:none">
      <div class="view-section-title">üìé Attachments</div>
      <div id="view-attachments-list"></div>
    </div>
    <div id="view-links-section" style="display:none">
      <div class="view-section-title">üîó Links</div>
      <div id="view-links-list"></div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" id="view-close">Close</button>
      <button class="btn-danger" id="view-delete">Delete</button>
      <button class="btn-save" id="view-edit">Edit</button>
    </div>
  </div>
</div>

<!-- FILE VIEWER MODAL -->
<div class="overlay" id="viewer-overlay"></div>
<div class="modal" id="viewer-modal" style="height:88vh;">
  <div class="modal-header" style="display:flex;align-items:center;justify-content:space-between;">
    <div style="font-family:var(--mono);font-size:12px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;margin-right:12px;" id="viewer-filename"></div>
    <button class="btn-cancel" id="viewer-close" style="flex-shrink:0;">‚úï Close</button>
  </div>
  <div class="modal-inner" style="padding:0 12px 12px;display:flex;flex-direction:column;">
    <div id="viewer-body" style="flex:1;min-height:0;border-radius:6px;background:#000;display:flex;align-items:center;justify-content:center;overflow:auto;height:100%;"></div>
  </div>
</div>

<!-- Hidden import input -->
<input type="file" id="import-files-input" multiple accept="*/*" style="display:none" />

<!-- IMPORT FILES MODAL -->
<div class="overlay" id="import-files-overlay"></div>
<div class="modal" id="import-files-modal">
  <div class="modal-header">
    <div class="modal-handle"></div>
    <div class="modal-title">Import Files</div>
  </div>
  <div class="modal-inner">
    <div style="font-size:13px;color:var(--text2);margin-bottom:14px;">Choose a category for the imported files. Each file will become its own entry.</div>
    <div id="import-files-preview" style="margin-bottom:14px;display:flex;flex-direction:column;gap:6px;"></div>
    <div class="form-group">
      <label>Category</label>
      <select id="import-files-cat">
        <option value="finance">Finance &amp; Money</option>
        <option value="health">Health &amp; Medical</option>
        <option value="recipes">Recipes &amp; Food</option>
        <option value="home">Home &amp; DIY</option>
        <option value="work">Work &amp; Career</option>
        <option value="travel">Travel</option>
        <option value="learning">Learning &amp; Research</option>
        <option value="ideas">Ideas &amp; Projects</option>
        <option value="notes">Personal Notes</option>
        <option value="photos">Photos &amp; Images</option>
      </select>
    </div>
    <div class="form-group">
      <label>Tags (optional)</label>
      <input type="text" id="import-files-tags" placeholder="e.g. smoothie, recipe, 2026‚Ä¶" />
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" id="import-files-cancel">Cancel</button>
      <button class="btn-save" id="import-files-save">Import All</button>
    </div>
  </div>
</div>
<input type="file" id="import-file" accept=".json" style="display:none" />

<script>
// ============================
// INDEXEDDB SETUP
// ============================
const DB_NAME = 'offstash_db';
const DB_VERSION = 1;
const STORE = 'entries';
let db;

function openDB() {
  return new Promise((res, rej) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = e => {
      const d = e.target.result;
      if (!d.objectStoreNames.contains(STORE)) {
        const store = d.createObjectStore(STORE, { keyPath: 'id' });
        store.createIndex('cat', 'cat', { unique: false });
      }
    };
    req.onsuccess = e => { db = e.target.result; res(db); };
    req.onerror = e => rej(e.target.error);
  });
}

function dbAll() {
  return new Promise((res, rej) => {
    const tx = db.transaction(STORE, 'readonly');
    const req = tx.objectStore(STORE).getAll();
    req.onsuccess = e => res(e.target.result);
    req.onerror = e => rej(e.target.error);
  });
}

function dbPut(entry) {
  return new Promise((res, rej) => {
    const tx = db.transaction(STORE, 'readwrite');
    const req = tx.objectStore(STORE).put(entry);
    req.onsuccess = () => res();
    req.onerror = e => rej(e.target.error);
  });
}

function dbDelete(id) {
  return new Promise((res, rej) => {
    const tx = db.transaction(STORE, 'readwrite');
    const req = tx.objectStore(STORE).delete(id);
    req.onsuccess = () => res();
    req.onerror = e => rej(e.target.error);
  });
}

// ============================
// STATE
// ============================
let allEntries = [];
let activeTab = 'all';
let searchQuery = '';
let editingId = null;
let viewingId = null;

const CAT_LABELS = {
  finance:  'Finance & Money',
  health:   'Health & Medical',
  recipes:  'Recipes & Food',
  home:     'Home & DIY',
  work:     'Work & Career',
  travel:   'Travel',
  learning: 'Learning & Research',
  ideas:    'Ideas & Projects',
  notes:    'Personal Notes',
  photos:   'Photos & Images'
};

// ============================
// RENDER
// ============================
function getCatClass(cat) {
  const map = { finance:'cat-finance', health:'cat-health', recipes:'cat-recipes', home:'cat-home', work:'cat-work', travel:'cat-travel', learning:'cat-learning', ideas:'cat-ideas', notes:'cat-notes', photos:'cat-photos' };
  return map[cat] || 'cat-notes';
}
function getCatBadgeClass(cat) {
  const map = { finance:'cat-badge-finance', health:'cat-badge-health', recipes:'cat-badge-recipes', home:'cat-badge-home', work:'cat-badge-work', travel:'cat-badge-travel', learning:'cat-badge-learning', ideas:'cat-badge-ideas', notes:'cat-badge-notes', photos:'cat-badge-photos' };
  return map[cat] || 'cat-badge-notes';
}

function filteredEntries() {
  let list = allEntries;
  if (activeTab !== 'all') list = list.filter(e => e.cat === activeTab);
  if (activeFolder) list = list.filter(e => e.folder === activeFolder);
  if (searchQuery) {
    const q = searchQuery.toLowerCase();
    list = list.filter(e =>
      (e.title||'').toLowerCase().includes(q) ||
      (e.content||'').toLowerCase().includes(q) ||
      (e.summary||'').toLowerCase().includes(q) ||
      (e.tags||[]).some(t => t.toLowerCase().includes(q))
    );
  }
  return list;
}

function formatDate(ts) {
  if (!ts) return '';
  const d = new Date(ts);
  return d.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
}

function renderGrid() {
  const entries = filteredEntries();
  const grid = document.getElementById('grid');
  const empty = document.getElementById('empty');
  const countText = document.getElementById('count-text');
  const filterText = document.getElementById('filter-text');

  countText.textContent = `${allEntries.length} entr${allEntries.length===1?'y':'ies'}`;
  filterText.textContent = (searchQuery || activeTab !== 'all' || activeFolder)
    ? `‚Äî showing ${entries.length}`
    : '';

  // Show folder cards when a category is selected and no folder is active and no search
  const showFolderCards = activeTab !== 'all' && !activeFolder && !searchQuery;
  const folders = showFolderCards ? getFoldersForCat(activeTab) : [];

  renderFolderRow();

  if (entries.length === 0 && folders.length === 0) {
    grid.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  // Folder cards first, then entry cards
  const folderCards = folders.map(f => {
    const count = getEntryCountInFolder(activeTab, f);
    return `<div class="folder-card" data-folder="${esc(f)}"
      ondragover="folderCardDragOver(event,this)"
      ondragleave="folderCardDragLeave(this)"
      ondrop="folderCardDrop(event,'${esc(f)}')"
      ondblclick="openFolder('${esc(f)}')">
      <div class="folder-card-actions">
        <button class="folder-card-btn" onclick="event.stopPropagation();renameFolderAction('${activeTab}','${esc(f)}')" title="Rename">‚úè</button>
        <button class="folder-card-btn del" onclick="event.stopPropagation();deleteFolderAction('${activeTab}','${esc(f)}')" title="Delete">‚úï</button>
      </div>
      <div class="folder-card-icon">üìÅ</div>
      <div class="folder-card-name">${esc(f)}</div>
      <div class="folder-card-count">${count} entr${count===1?'y':'ies'} ‚Äî double-click to open</div>
    </div>`;
  }).join('');

  const entryCards = entries.slice().reverse().map(e => `
    <div class="card ${getCatClass(e.cat)}" data-id="${e.id}"
      draggable="true"
      ondragstart="draggedEntryId='${e.id}';event.dataTransfer.effectAllowed='move';this.classList.add('dragging')"
      ondragend="draggedEntryId=null;this.classList.remove('dragging')"
      onclick="openView('${e.id}')">
      ${e.folder ? `<div class="card-folder-badge">üìÅ ${esc(e.folder)}</div>` : ''}
      <div class="card-cat">${CAT_LABELS[e.cat]||e.cat}</div>
      <div class="card-title">${esc(e.title||'Untitled')}</div>
      <div class="card-preview">${esc(e.summary||e.content||'No content')}</div>
      <div class="card-footer">
        <div class="card-date">${formatDate(e.created)}</div>
        <div class="card-tags">${(e.tags||[]).slice(0,3).map(t=>`<span class="tag">${esc(t)}</span>`).join('')}</div>
      </div>
    </div>
  `).join('');

  grid.innerHTML = folderCards + entryCards;
}

function esc(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ============================
// MODALS
// ============================
// ============================
// SUGGESTED TAGS PER CATEGORY
// ============================
const CAT_SUGGESTED_TAGS = {
  finance:  ['budget', 'invoice', 'taxes', 'savings', 'expense', 'income', 'investment', 'debt', 'insurance', 'crypto', 'banking', 'loan', 'receipt', 'payroll', 'stocks'],
  health:   ['medication', 'appointment', 'symptoms', 'doctor', 'insurance', 'diet', 'exercise', 'mental health', 'prescription', 'allergy', 'surgery', 'lab results', 'vitals', 'therapy', 'emergency'],
  recipes:  ['breakfast', 'dinner', 'lunch', 'vegetarian', 'vegan', 'gluten-free', 'quick', 'meal prep', 'dessert', 'snack', 'baking', 'grilling', 'instant pot', 'slow cooker', 'healthy'],
  home:     ['repair', 'maintenance', 'plumbing', 'electrical', 'painting', 'cleaning', 'garden', 'HVAC', 'appliance', 'renovation', 'furniture', 'pest control', 'roof', 'flooring', 'tools'],
  work:     ['meeting', 'project', 'deadline', 'client', 'proposal', 'resume', 'interview', 'goals', 'feedback', 'contract', 'invoice', 'networking', 'training', 'performance', 'remote'],
  travel:   ['flights', 'hotel', 'itinerary', 'visa', 'packing', 'budget', 'passport', 'road trip', 'international', 'booking', 'insurance', 'tips', 'airbnb', 'car rental', 'activities'],
  learning: ['course', 'book', 'notes', 'summary', 'research', 'tutorial', 'podcast', 'article', 'certification', 'language', 'history', 'science', 'math', 'coding', 'philosophy'],
  ideas:    ['startup', 'feature', 'design', 'brainstorm', 'side project', 'app', 'business', 'creative', 'prototype', 'MVP', 'goal', 'vision', 'strategy', 'automation', 'content'],
  notes:    ['personal', 'journal', 'reminder', 'thought', 'dream', 'quote', 'reflection', 'list', 'plan', 'memory', 'mood', 'gratitude', 'weekly', 'daily', 'random'],
  photos:   ['portrait', 'landscape', 'screenshot', 'infographic', 'design', 'recipe', 'travel', 'family', 'nature', 'architecture', 'food', 'art', 'reference', 'inspiration', 'event']
};

const CAT_TAG_PLACEHOLDERS = {
  finance:  'e.g. budget, taxes, savings‚Ä¶',
  health:   'e.g. doctor, medication, diet‚Ä¶',
  recipes:  'e.g. dinner, vegan, quick‚Ä¶',
  home:     'e.g. repair, plumbing, garden‚Ä¶',
  work:     'e.g. project, client, deadline‚Ä¶',
  travel:   'e.g. flights, hotel, packing‚Ä¶',
  learning: 'e.g. book, course, notes‚Ä¶',
  ideas:    'e.g. startup, app, brainstorm‚Ä¶',
  notes:    'e.g. journal, reminder, daily‚Ä¶',
  photos:   'e.g. portrait, recipe, design‚Ä¶'
};

function renderSuggestedTags(cat) {
  const container = document.getElementById('suggested-tags');
  if (!container) return;
  const suggestions = CAT_SUGGESTED_TAGS[cat] || [];
  // Pick 6 suggestions
  const picks = suggestions.slice(0, 8);
  const currentTags = getCurrentTags();
  container.innerHTML = picks.map(t => {
    const used = currentTags.includes(t);
    return `<button type="button" class="suggested-tag${used ? ' used' : ''}" onclick="addSuggestedTag('${t}')">${t}</button>`;
  }).join('');
  // Update input placeholder to match category
  const input = document.getElementById('f-tags');
  if (input) input.placeholder = CAT_TAG_PLACEHOLDERS[cat] || 'add tags‚Ä¶';
}

function getCurrentTags() {
  return document.getElementById('f-tags').value
    .split(',').map(t => t.trim().toLowerCase()).filter(Boolean);
}

function addSuggestedTag(tag) {
  const input = document.getElementById('f-tags');
  const current = getCurrentTags();
  if (current.includes(tag.toLowerCase())) return;
  input.value = current.length > 0 ? current.join(', ') + ', ' + tag : tag;
  renderSuggestedTags(document.getElementById('f-cat').value);
}

// Temp attachment/link state for the form
let formAttachments = []; // [{name, size, type, data(base64)}]
let formLinks = [];       // [{url, label}]

function openFormModal(entry = null, isNew = false) {
  editingId = (!isNew && entry) ? entry.id : null;
  document.getElementById('form-title').textContent = editingId ? 'Edit Entry' : 'New Entry';
  document.getElementById('f-title').value = (!isNew && entry) ? (entry.title || '') : '';
  const cat = entry?.cat || (activeTab !== 'all' ? activeTab : 'notes');
  document.getElementById('f-cat').value = cat;
  document.getElementById('f-tags').value = (!isNew && entry) ? (entry?.tags||[]).join(', ') : '';
  renderSuggestedTags(cat);
  document.getElementById('f-summary').value = (!isNew && entry) ? (entry?.summary || '') : '';
  document.getElementById('f-content').value = (!isNew && entry) ? (entry?.content || '') : '';
  // Load folder select
  const entryFolder = entry?.folder || (isNew && activeFolder ? activeFolder : '');
  populateFolderSelect(entryFolder);
  document.getElementById('form-delete').style.display = entry ? 'block' : 'none';

  // Load existing attachments & links
  formAttachments = entry?.attachments ? JSON.parse(JSON.stringify(entry.attachments)) : [];
  formLinks = entry?.links ? JSON.parse(JSON.stringify(entry.links)) : [];
  renderFormAttachments();
  renderFormLinks();

  document.getElementById('f-link-url').value = '';
  document.getElementById('f-link-label').value = '';
  document.getElementById('attach-warning').textContent = '';

  document.getElementById('form-overlay').classList.add('show');
  document.getElementById('form-modal').classList.add('show');
  document.body.style.overflow = 'hidden';
  setTimeout(() => document.getElementById('f-title').focus(), 100);
}

function formatBytes(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024*1024) return (bytes/1024).toFixed(1) + ' KB';
  return (bytes/(1024*1024)).toFixed(1) + ' MB';
}

function previewAttachment(encodedData, type, name) {
  const data = decodeURIComponent(encodedData);
  const body = document.getElementById('viewer-body');
  document.getElementById('viewer-filename').textContent = name || 'File';
  body.innerHTML = '';

  if (type.startsWith('image/')) {
    const img = document.createElement('img');
    img.src = data;
    img.alt = name || 'Image';
    body.appendChild(img);

  } else if (type === 'application/pdf') {
    // Embed PDF using base64 data URI directly in iframe
    const iframe = document.createElement('iframe');
    iframe.src = data;
    iframe.title = name || 'PDF';
    body.style.background = '#fff';
    body.appendChild(iframe);

  } else if (type.startsWith('text/') || type === 'application/json') {
    // Decode and show as text
    const base64 = data.split(',')[1];
    const decoded = decodeURIComponent(escape(atob(base64)));
    const pre = document.createElement('div');
    pre.className = 'viewer-text';
    pre.textContent = decoded;
    body.style.background = 'var(--bg3)';
    body.appendChild(pre);

  } else if (type.startsWith('video/')) {
    const video = document.createElement('video');
    video.src = data;
    video.controls = true;
    video.style.cssText = 'max-width:100%;max-height:100%;border-radius:4px;';
    body.appendChild(video);

  } else if (type.startsWith('audio/')) {
    const audio = document.createElement('audio');
    audio.src = data;
    audio.controls = true;
    audio.style.cssText = 'width:100%;margin:auto;';
    body.appendChild(audio);

  } else {
    body.innerHTML = `<div class="viewer-unsupported">
      <span class="big">${fileIcon(type)}</span>
      This file type can't be previewed inline.<br/>Use ‚¨á Save to download it.
    </div>`;
  }

  document.getElementById('viewer-overlay').classList.add('show');
  document.getElementById('viewer-modal').classList.add('show');
}

function saveAttachment(encodedData, name) {
  const data = decodeURIComponent(encodedData);
  const byteString = atob(data.split(',')[1]);
  const mimeMatch = data.match(/^data:([^;]+);/);
  const mime = mimeMatch ? mimeMatch[1] : 'application/octet-stream';
  const ab = new ArrayBuffer(byteString.length);
  const ia = new Uint8Array(ab);
  for (let i = 0; i < byteString.length; i++) ia[i] = byteString.charCodeAt(i);
  const blob = new Blob([ab], { type: mime });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = name;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(url), 5000);
}

function canPreview(type) {
  if (!type) return false;
  // These types browsers can display natively in a new tab
  return type.startsWith('image/') ||
         type === 'application/pdf' ||
         type.startsWith('text/') ||
         type === 'application/json' ||
         type.startsWith('video/') ||
         type.startsWith('audio/');
}

function fileIcon(type) {
  if (!type) return 'üìÑ';
  if (type.startsWith('image/')) return 'üñºÔ∏è';
  if (type === 'application/pdf') return 'üìï';
  if (type.includes('word')) return 'üìù';
  if (type.includes('sheet') || type.includes('excel') || type.includes('csv')) return 'üìä';
  if (type.startsWith('video/')) return 'üé¨';
  if (type.startsWith('audio/')) return 'üéµ';
  return 'üìÑ';
}

function renderFormAttachments() {
  const list = document.getElementById('attach-list');
  list.innerHTML = formAttachments.map((a, i) => `
    <div class="attach-item">
      <span class="attach-icon">${fileIcon(a.type)}</span>
      <span class="attach-name" title="${esc(a.name)}">${esc(a.name)}</span>
      <span class="attach-size">${formatBytes(a.size)}</span>
      <button class="attach-remove" onclick="removeAttachment(${i})">‚úï</button>
    </div>
  `).join('');
}

function removeAttachment(i) {
  formAttachments.splice(i, 1);
  renderFormAttachments();
}

function renderFormLinks() {
  const list = document.getElementById('link-list');
  list.innerHTML = formLinks.map((l, i) => `
    <div class="attach-item">
      <span class="attach-icon">üîó</span>
      <span class="attach-name" title="${esc(l.url)}">${esc(l.label || l.url)}</span>
      <button class="attach-remove" onclick="removeLink(${i})">‚úï</button>
    </div>
  `).join('');
}

function removeLink(i) {
  formLinks.splice(i, 1);
  renderFormLinks();
}

function closeFormModal() {
  document.getElementById('form-overlay').classList.remove('show');
  document.getElementById('form-modal').classList.remove('show');
  document.body.style.overflow = '';
  editingId = null;
  formAttachments = [];
  formLinks = [];
  // Clear folder inputs
  const fn = document.getElementById('f-folder-new');
  if (fn) fn.value = '';
  const fs = document.getElementById('f-folder');
  if (fs) fs.value = '';
}

function openView(id) {
  const e = allEntries.find(x => x.id === id);
  if (!e) return;
  viewingId = id;
  document.getElementById('view-title').textContent = e.title || 'Untitled';
  document.getElementById('view-cat-badge').textContent = CAT_LABELS[e.cat]||e.cat;
  document.getElementById('view-cat-badge').className = `view-cat-badge ${getCatBadgeClass(e.cat)}`;
  document.getElementById('view-date').textContent = formatDate(e.created);
  document.getElementById('view-tags').innerHTML = (e.tags||[]).map(t=>`<span class="tag">${esc(t)}</span>`).join('');
  document.getElementById('view-summary').textContent = e.summary || '';
  document.getElementById('view-content').textContent = e.content || '';

  // Attachments
  const attachments = e.attachments || [];
  const attachSection = document.getElementById('view-attachments-section');
  const attachList = document.getElementById('view-attachments-list');
  if (attachments.length > 0) {
    attachSection.style.display = 'block';
    attachList.innerHTML = attachments.map(a => {
      const href = a.data; // base64 data URL
      return `<div class="view-attach-item">
        <span style="font-size:18px">${fileIcon(a.type)}</span>
        <span style="flex:1;font-size:12px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(a.name)}">${esc(a.name)}</span>
        <span style="font-family:var(--mono);font-size:10px;color:var(--text3);margin-right:8px">${formatBytes(a.size)}</span>
        <div class="attach-actions">
          <button class="view-attach-btn view-btn" onclick="previewAttachment('${encodeURIComponent(a.data)}', '${esc(a.type)}', '${esc(a.name)}')">üëÅ View</button>
          <button class="view-attach-btn" onclick="saveAttachment('${encodeURIComponent(a.data)}', '${esc(a.name)}')">‚¨á Save</button>
        </div>
      </div>`;
    }).join('');
  } else {
    attachSection.style.display = 'none';
  }

  // Links
  const links = e.links || [];
  const linksSection = document.getElementById('view-links-section');
  const linksList = document.getElementById('view-links-list');
  if (links.length > 0) {
    linksSection.style.display = 'block';
    linksList.innerHTML = links.map(l => `
      <div class="view-attach-item">
        <span style="font-size:18px">üîó</span>
        <a class="link-anchor" href="${esc(l.url)}" target="_blank" rel="noopener noreferrer">
          ${l.label ? `<span class="link-label-text">${esc(l.label)} ‚Äî</span>` : ''}${esc(l.url)}
        </a>
      </div>
    `).join('');
  } else {
    linksSection.style.display = 'none';
  }

  document.getElementById('view-overlay').classList.add('show');
  document.getElementById('view-modal').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeView() {
  document.getElementById('view-overlay').classList.remove('show');
  document.getElementById('view-modal').classList.remove('show');
  document.body.style.overflow = '';
  viewingId = null;
}

// ============================
// SAVE / DELETE
// ============================
async function saveEntry() {
  const title = document.getElementById('f-title').value.trim();
  if (!title) { showToast('Title is required'); return; }

  const tags = document.getElementById('f-tags').value
    .split(',').map(t => t.trim()).filter(Boolean);

  // Determine folder
  const folderSelect = document.getElementById('f-folder').value;
  const folderNew = document.getElementById('f-folder-new').value.trim();
  const cat = document.getElementById('f-cat').value;
  let folder = folderNew || folderSelect || null;
  if (folderNew) createFolder(cat, folderNew);

  const entry = {
    id: editingId || crypto.randomUUID(),
    title,
    cat,
    tags,
    folder: folder || null,
    summary: document.getElementById('f-summary').value.trim(),
    content: document.getElementById('f-content').value.trim(),
    attachments: formAttachments,
    links: formLinks,
    created: editingId
      ? allEntries.find(e=>e.id===editingId)?.created || Date.now()
      : Date.now(),
    updated: Date.now()
  };

  await dbPut(entry);
  allEntries = await dbAll();
  renderGrid();
  closeFormModal();
  showToast(editingId ? 'Entry updated' : 'Entry saved');
}

async function deleteEntry(btn) {
  if (!editingId) return;
  if (btn.dataset.confirming !== 'true') {
    btn.dataset.confirming = 'true';
    btn.textContent = 'Tap again to confirm';
    btn.style.background = '#ff4444';
    btn.style.color = '#fff';
    setTimeout(() => {
      btn.dataset.confirming = 'false';
      btn.textContent = 'Delete';
      btn.style.background = '';
      btn.style.color = '';
    }, 3000);
    return;
  }
  await dbDelete(editingId);
  allEntries = await dbAll();
  renderGrid();
  closeFormModal();
  showToast('Entry deleted');
}

// ============================
// EXPORT / IMPORT
// ============================
function exportJSON() {
  const blob = new Blob([JSON.stringify(allEntries, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `offstash-backup-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showToast(`Exported ${allEntries.length} entries`);
}

async function importJSON(file) {
  try {
    const text = await file.text();
    const data = JSON.parse(text);
    if (!Array.isArray(data)) throw new Error('Invalid format');
    for (const entry of data) {
      if (entry.id && entry.title) await dbPut(entry);
    }
    allEntries = await dbAll();
    renderGrid();
    showToast(`Imported ${data.length} entries`);
  } catch (err) {
    showToast('Import failed: ' + err.message);
  }
}

// ============================
// TOAST
// ============================
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2500);
}

// ============================
// OFFLINE DETECTION
// ============================
function updateOnlineStatus() {
  const banner = document.getElementById('offline-banner');
  if (navigator.onLine) {
    banner.classList.remove('show');
    console.log('[OffStash] Reconnected ‚Äî sync later');
  } else {
    banner.classList.add('show');
  }
}
window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);

// ============================
// EVENT LISTENERS
// ============================
// add-btn now handled by add-menu

document.getElementById('form-save').addEventListener('click', saveEntry);
document.getElementById('form-cancel').addEventListener('click', closeFormModal);
document.getElementById('form-delete').addEventListener('click', (e) => deleteEntry(e.target));

document.getElementById('view-close').addEventListener('click', closeView);
document.getElementById('view-edit').addEventListener('click', () => {
  const e = allEntries.find(x => x.id === viewingId);
  closeView();
  if (e) openFormModal(e);
});
document.getElementById('view-delete').addEventListener('click', async (e) => {
  if (!viewingId) return;
  const btn = e.target;
  if (btn.dataset.confirming !== 'true') {
    btn.dataset.confirming = 'true';
    btn.textContent = 'Tap again to confirm';
    btn.style.background = '#ff4444';
    btn.style.color = '#fff';
    setTimeout(() => {
      btn.dataset.confirming = 'false';
      btn.textContent = 'Delete';
      btn.style.background = '';
      btn.style.color = '';
    }, 3000);
    return;
  }
  const idToDelete = viewingId;
  closeView();
  await dbDelete(idToDelete);
  allEntries = await dbAll();
  renderGrid();
  showToast('Entry deleted');
});

document.getElementById('export-btn').addEventListener('click', exportJSON);

// ============================
// IMPORT FILES
// ============================
let pendingImportFiles = [];

function openImportFilesModal(files) {
  pendingImportFiles = Array.from(files);
  if (pendingImportFiles.length === 0) return;

  // Show preview list
  const preview = document.getElementById('import-files-preview');
  preview.innerHTML = pendingImportFiles.map(f => `
    <div class="attach-item">
      <span class="attach-icon">${fileIcon(f.type)}</span>
      <span class="attach-name">${esc(f.name)}</span>
      <span class="attach-size">${formatBytes(f.size)}</span>
    </div>
  `).join('');

  document.getElementById('import-files-tags').value = '';
  document.getElementById('import-files-overlay').classList.add('show');
  document.getElementById('import-files-modal').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeImportFilesModal() {
  document.getElementById('import-files-overlay').classList.remove('show');
  document.getElementById('import-files-modal').classList.remove('show');
  document.body.style.overflow = '';
  pendingImportFiles = [];
}

async function doImportFiles() {
  const cat = document.getElementById('import-files-cat').value;
  const tags = document.getElementById('import-files-tags').value
    .split(',').map(t => t.trim()).filter(Boolean);

  let count = 0;
  for (const file of pendingImportFiles) {
    if (file.size > 10 * 1024 * 1024) {
      showToast(`Skipped ${file.name} ‚Äî over 10MB`);
      continue;
    }
    const data = await new Promise((res, rej) => {
      const reader = new FileReader();
      reader.onload = () => res(reader.result);
      reader.onerror = rej;
      reader.readAsDataURL(file);
    });
    const entry = {
      id: crypto.randomUUID(),
      title: file.name.replace(/\.[^.]+$/, ''), // filename without extension
      cat,
      tags,
      summary: `Imported file: ${file.name}`,
      content: '',
      attachments: [{ name: file.name, size: file.size, type: file.type, data }],
      links: [],
      created: Date.now(),
      updated: Date.now()
    };
    await dbPut(entry);
    count++;
  }

  allEntries = await dbAll();
  renderGrid();
  closeImportFilesModal();
  showToast(`Imported ${count} file${count !== 1 ? 's' : ''}`);
}

document.getElementById('import-files-btn').addEventListener('click', () => {
  document.getElementById('import-files-input').click();
});
document.getElementById('import-files-input').addEventListener('change', e => {
  if (e.target.files.length > 0) openImportFilesModal(e.target.files);
  e.target.value = '';
});
document.getElementById('import-files-cancel').addEventListener('click', closeImportFilesModal);
document.getElementById('import-files-overlay').addEventListener('click', closeImportFilesModal);
document.getElementById('import-files-save').addEventListener('click', doImportFiles);

// ============================
// DRAG & DROP ON EMPTY STATE
// ============================
const emptyZone = document.getElementById('empty-drop-zone');

emptyZone.addEventListener('click', () => {
  document.getElementById('import-files-input').click();
});

['dragenter','dragover'].forEach(ev => {
  emptyZone.addEventListener(ev, e => {
    e.preventDefault();
    emptyZone.classList.add('drag-over');
  });
});
['dragleave','dragend'].forEach(ev => {
  emptyZone.addEventListener(ev, () => emptyZone.classList.remove('drag-over'));
});
emptyZone.addEventListener('drop', e => {
  e.preventDefault();
  emptyZone.classList.remove('drag-over');
  const files = e.dataTransfer.files;
  if (files.length > 0) openImportFilesModal(files);
});

// Also allow drag-drop anywhere on the main content area when entries exist
const contentArea = document.getElementById('grid');
let dragCounter = 0;

document.addEventListener('dragenter', e => {
  if (e.dataTransfer.types.includes('Files')) {
    dragCounter++;
    document.getElementById('drop-overlay-hint').style.display = 'flex';
  }
});
document.addEventListener('dragleave', () => {
  dragCounter--;
  if (dragCounter <= 0) {
    dragCounter = 0;
    document.getElementById('drop-overlay-hint').style.display = 'none';
  }
});
document.addEventListener('dragover', e => e.preventDefault());
document.addEventListener('drop', e => {
  e.preventDefault();
  dragCounter = 0;
  document.getElementById('drop-overlay-hint').style.display = 'none';
  const files = e.dataTransfer.files;
  if (files.length > 0) openImportFilesModal(files);
});
document.getElementById('import-btn').addEventListener('click', () => {
  document.getElementById('import-file').click();
});
document.getElementById('import-file').addEventListener('change', e => {
  if (e.target.files[0]) importJSON(e.target.files[0]);
  e.target.value = '';
});

document.getElementById('search').addEventListener('input', e => {
  searchQuery = e.target.value.trim();
  renderGrid();
});

// Mobile pill tabs
document.getElementById('tabs').addEventListener('click', e => {
  const btn = e.target.closest('.tab');
  if (!btn) return;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  activeTab = btn.dataset.cat;
  activeFolder = null;
  const dd = document.getElementById('cat-dropdown');
  if (dd) dd.value = activeTab;
  renderGrid();
});

// Desktop dropdown
document.getElementById('cat-dropdown').addEventListener('change', e => {
  activeTab = e.target.value;
  activeFolder = null;
  document.querySelectorAll('.tab').forEach(t => {
    t.classList.toggle('active', t.dataset.cat === activeTab);
  });
  renderGrid();
});

// Viewer close
function closeViewer() {
  document.getElementById('viewer-overlay').classList.remove('show');
  document.getElementById('viewer-modal').classList.remove('show');
  const body = document.getElementById('viewer-body');
  body.innerHTML = '';
  body.style.background = '#000';
}
document.getElementById('viewer-close').addEventListener('click', closeViewer);
document.getElementById('viewer-overlay').addEventListener('click', closeViewer);

// Close overlays on backdrop click
document.getElementById('form-overlay').addEventListener('click', () => closeFormModal());
document.getElementById('view-overlay').addEventListener('click', () => closeView());

// Keyboard shortcuts
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') { closeFormModal(); closeView(); }
});

// ============================
// ATTACHMENTS & LINKS HANDLERS
// ============================
// Update suggested tags + folder select when category changes
document.getElementById('f-cat').addEventListener('change', (e) => {
  renderSuggestedTags(e.target.value);
  populateFolderSelect('');
});

// Re-render suggestions when tags input is manually edited
document.getElementById('f-tags').addEventListener('input', () => {
  renderSuggestedTags(document.getElementById('f-cat').value);
});

document.getElementById('attach-file-input').addEventListener('change', async (e) => {
  const files = Array.from(e.target.files);
  const warn = document.getElementById('attach-warning');
  warn.textContent = '';
  for (const file of files) {
    if (file.size > 10 * 1024 * 1024) {
      warn.textContent = `‚ö† "${file.name}" is over 10MB and was skipped.`;
      continue;
    }
    if (file.size > 5 * 1024 * 1024) {
      warn.textContent = `‚ö† Large file (${formatBytes(file.size)}) ‚Äî export JSON may be slow.`;
    }
    const data = await new Promise((res, rej) => {
      const reader = new FileReader();
      reader.onload = () => res(reader.result);
      reader.onerror = rej;
      reader.readAsDataURL(file);
    });
    formAttachments.push({ name: file.name, size: file.size, type: file.type, data });
  }
  renderFormAttachments();
  e.target.value = '';
});

document.getElementById('add-link-btn').addEventListener('click', () => {
  const url = document.getElementById('f-link-url').value.trim();
  if (!url) { showToast('Enter a URL first'); return; }
  const label = document.getElementById('f-link-label').value.trim();
  // Auto-prefix https:// if missing
  const finalUrl = /^https?:\/\//i.test(url) ? url : 'https://' + url;
  formLinks.push({ url: finalUrl, label });
  document.getElementById('f-link-url').value = '';
  document.getElementById('f-link-label').value = '';
  renderFormLinks();
});

// Allow Enter key in link URL field to add link
document.getElementById('f-link-url').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') { e.preventDefault(); document.getElementById('add-link-btn').click(); }
});

// ============================
// CUSTOM CONFIRM DIALOG
// ============================
let confirmCallback = null;

function showConfirm(title, message, onOk, okLabel = 'Delete') {
  document.getElementById('confirm-title').textContent = title;
  document.getElementById('confirm-message').textContent = message;
  document.getElementById('confirm-ok-btn').textContent = okLabel;
  confirmCallback = onOk;
  document.getElementById('confirm-overlay').classList.add('show');
  document.getElementById('confirm-modal').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeConfirm() {
  document.getElementById('confirm-overlay').classList.remove('show');
  document.getElementById('confirm-modal').classList.remove('show');
  document.body.style.overflow = '';
  confirmCallback = null;
}

let renameCallback = null;
function showRenameModal(currentName, onRename) {
  document.getElementById('rename-input').value = currentName;
  renameCallback = onRename;
  document.getElementById('rename-overlay').classList.add('show');
  document.getElementById('rename-modal').classList.add('show');
  document.body.style.overflow = 'hidden';
  setTimeout(() => document.getElementById('rename-input').select(), 100);
}
function closeRenameModal() {
  document.getElementById('rename-overlay').classList.remove('show');
  document.getElementById('rename-modal').classList.remove('show');
  document.body.style.overflow = '';
  renameCallback = null;
}
document.getElementById('rename-ok-btn').addEventListener('click', () => {
  const val = document.getElementById('rename-input').value.trim();
  const cb = renameCallback;
  closeRenameModal();
  if (cb) cb(val);
});
document.getElementById('rename-cancel-btn').addEventListener('click', closeRenameModal);
document.getElementById('rename-overlay').addEventListener('click', closeRenameModal);
document.getElementById('rename-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') document.getElementById('rename-ok-btn').click();
  if (e.key === 'Escape') closeRenameModal();
});

document.getElementById('confirm-ok-btn').addEventListener('click', () => {
  const cb = confirmCallback;
  closeConfirm();
  if (cb) cb();
});
document.getElementById('confirm-cancel-btn').addEventListener('click', closeConfirm);
document.getElementById('confirm-overlay').addEventListener('click', closeConfirm);

// ============================
// FOLDER SYSTEM
// ============================
let activeFolder = null;
let allFolders = {}; // { cat: ['Smoothies','Dinners',...] }
let draggedEntryId = null;

function saveFolders() {
  localStorage.setItem('offstash_folders', JSON.stringify(allFolders));
}
function loadFolders() {
  try { allFolders = JSON.parse(localStorage.getItem('offstash_folders') || '{}'); }
  catch { allFolders = {}; }
}
function getFoldersForCat(cat) {
  const fromEntries = allEntries
    .filter(e => e.cat === cat && e.folder)
    .map(e => e.folder);
  const stored = allFolders[cat] || [];
  return [...new Set([...stored, ...fromEntries])].sort();
}
function getEntryCountInFolder(cat, folder) {
  return allEntries.filter(e => e.cat === cat && e.folder === folder).length;
}

function createFolder(cat, name) {
  name = name.trim();
  if (!name) return false;
  if (!allFolders[cat]) allFolders[cat] = [];
  if (!allFolders[cat].includes(name)) { allFolders[cat].push(name); saveFolders(); }
  return true;
}

function deleteFolderFromState(cat, name) {
  if (allFolders[cat]) {
    allFolders[cat] = allFolders[cat].filter(f => f !== name);
    saveFolders();
  }
  if (activeFolder === name) activeFolder = null;
}

function renderFolderRow() {
  const row = document.getElementById('folder-row');
  const pills = document.getElementById('folder-pills');
  if (!row || !pills) return;

  if (activeTab === 'all') { row.style.display = 'none'; return; }

  const folders = getFoldersForCat(activeTab);
  row.style.display = folders.length > 0 ? 'block' : 'none';

  pills.innerHTML = folders.map(f => {
    const count = getEntryCountInFolder(activeTab, f);
    const active = activeFolder === f ? ' active' : '';
    return `<button class="folder-pill${active}" data-folder="${esc(f)}"
      ondragover="folderPillDragOver(event,this)"
      ondragleave="this.classList.remove('drag-target')"
      ondrop="folderPillDrop(event,'${esc(f)}')">
      üìÅ ${esc(f)} <span style="opacity:.5;font-size:9px;">(${count})</span>
      <span class="folder-pill-del" data-delfolder="${esc(f)}" title="Delete folder">‚úï</span>
    </button>`;
  }).join('') +
  `<button class="btn-new-folder" id="btn-new-folder-inline">+ Folder</button>`;

  // bind inline new folder btn
  const inlineBtn = document.getElementById('btn-new-folder-inline');
  if (inlineBtn) inlineBtn.onclick = () => promptNewFolder(activeTab);
}

function promptNewFolder(cat) {
  // inline prompt via a small inline input
  const pills = document.getElementById('folder-pills');
  if (document.getElementById('new-folder-inline-input')) return;
  const wrap = document.createElement('div');
  wrap.style.cssText = 'display:flex;gap:6px;align-items:center;';
  wrap.innerHTML = `
    <input id="new-folder-inline-input" type="text" placeholder="Folder name‚Ä¶"
      style="height:28px;padding:0 10px;border-radius:20px;border:1px solid var(--accent);
      background:var(--input);color:var(--text);font-size:11px;font-family:var(--mono);outline:none;min-width:130px;" />
    <button id="new-folder-confirm" style="background:var(--accent);color:#000;border:none;height:28px;
      padding:0 10px;border-radius:20px;font-size:11px;font-family:var(--mono);cursor:pointer;">‚úì</button>
    <button id="new-folder-cancel" style="background:var(--bg3);color:var(--text2);border:1px solid var(--border);
      height:28px;padding:0 8px;border-radius:20px;font-size:11px;cursor:pointer;">‚úï</button>`;
  pills.appendChild(wrap);
  const input = document.getElementById('new-folder-inline-input');
  input.focus();
  const confirm = () => {
    const name = input.value.trim();
    if (name) { createFolder(cat, name); renderFolderRow(); renderGrid(); }
    else wrap.remove();
  };
  document.getElementById('new-folder-confirm').onclick = confirm;
  document.getElementById('new-folder-cancel').onclick = () => wrap.remove();
  input.onkeydown = e => { if (e.key === 'Enter') confirm(); if (e.key === 'Escape') wrap.remove(); };
}

function populateFolderSelect(entryFolder) {
  const select = document.getElementById('f-folder');
  if (!select) return;
  const cat = document.getElementById('f-cat').value;
  const folders = getFoldersForCat(cat);
  select.innerHTML = '<option value="">‚Äî No folder ‚Äî</option>' +
    folders.map(f => `<option value="${esc(f)}"${entryFolder===f?' selected':''}>${esc(f)}</option>`).join('');
}

// ‚îÄ‚îÄ Drag & drop entries into folders ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function folderPillDragOver(e, el) {
  e.preventDefault();
  el.classList.add('drag-target');
}
function folderPillDrop(e, folderName) {
  e.preventDefault();
  e.target.closest('.folder-pill')?.classList.remove('drag-target');
  if (!draggedEntryId) return;
  moveEntryToFolder(draggedEntryId, folderName);
}
async function moveEntryToFolder(id, folder) {
  const entry = allEntries.find(e => e.id === id);
  if (!entry) return;
  entry.folder = folder;
  entry.updated = Date.now();
  await dbPut(entry);
  allEntries = await dbAll();
  renderFolderRow();
  renderGrid();
  showToast(`Moved to üìÅ ${folder}`);
}

// ‚îÄ‚îÄ Folder card drag-drop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function folderCardDragOver(e, el) {
  e.preventDefault();
  el.classList.add('drag-target');
}
function folderCardDragLeave(el) {
  el.classList.remove('drag-target');
}
function folderCardDrop(e, folderName) {
  e.preventDefault();
  e.currentTarget?.classList.remove('drag-target');
  if (!draggedEntryId) return;
  moveEntryToFolder(draggedEntryId, folderName);
}

// ‚îÄ‚îÄ Folder card actions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openFolder(folderName) {
  activeFolder = folderName;
  renderFolderRow();
  renderGrid();
}

function deleteFolderAction(cat, folderName) {
  const count = getEntryCountInFolder(cat, folderName);
  const msg = count > 0
    ? `${count} entr${count===1?'y':'ies'} will be unassigned but not deleted.`
    : `This folder will be permanently removed.`;
  showConfirm(`Delete folder "${folderName}"?`, msg, async () => {
    deleteFolderFromState(cat, folderName);
    for (const entry of allEntries.filter(e => e.folder === folderName && e.cat === cat)) {
      entry.folder = null;
      entry.updated = Date.now();
      await dbPut(entry);
    }
    allEntries = await dbAll();
    renderFolderRow();
    renderGrid();
    showToast(`Folder "${folderName}" deleted`);
  });
}

function renameFolderAction(cat, oldName) {
  showRenameModal(oldName, async (trimmed) => {
    if (!trimmed || trimmed === oldName) return;
    if (allFolders[cat]) {
      const idx = allFolders[cat].indexOf(oldName);
      if (idx > -1) allFolders[cat][idx] = trimmed;
      saveFolders();
    }
    for (const entry of allEntries.filter(e => e.folder === oldName && e.cat === cat)) {
      entry.folder = trimmed;
      entry.updated = Date.now();
      await dbPut(entry);
    }
    if (activeFolder === oldName) activeFolder = trimmed;
    allEntries = await dbAll();
    renderFolderRow();
    renderGrid();
    showToast(`Renamed to "${trimmed}"`);
  });
}

// ‚îÄ‚îÄ Hook folder pill clicks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('folder-pills').addEventListener('click', e => {
  const delBtn = e.target.closest('[data-delfolder]');
  if (delBtn) {
    e.stopPropagation();
    const name = delBtn.dataset.delfolder;
    const count = getEntryCountInFolder(activeTab, name);
    const msg = count > 0
      ? `${count} entr${count===1?'y':'ies'} will be unassigned but not deleted.`
      : `This folder will be permanently removed.`;
    showConfirm(`Delete folder "${name}"?`, msg, async () => {
      deleteFolderFromState(activeTab, name);
      // Also unassign all entries in this folder
      for (const entry of allEntries.filter(e => e.folder === name && e.cat === activeTab)) {
        entry.folder = null;
        entry.updated = Date.now();
        await dbPut(entry);
      }
      allEntries = await dbAll();
      renderFolderRow(); renderGrid();
      showToast(`Folder "${name}" deleted`);
    });
    return;
  }
  const pill = e.target.closest('.folder-pill');
  if (pill && !e.target.classList.contains('folder-pill-del')) {
    const name = pill.dataset.folder;
    activeFolder = activeFolder === name ? null : name;
    renderFolderRow(); renderGrid();
  }
});

// ‚îÄ‚îÄ + Add menu ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('add-btn').addEventListener('click', (e) => {
  e.stopPropagation();
  const menu = document.getElementById('add-menu');
  const btn = document.getElementById('add-btn');
  const rect = btn.getBoundingClientRect();
  if (menu.style.display === 'none') {
    menu.style.display = 'block';
    // Position below button, aligned to right edge
    const menuHeight = menu.offsetHeight || 90;
    const spaceBelow = window.innerHeight - rect.bottom;
    // If not enough space below, flip above
    if (spaceBelow < menuHeight + 10) {
      menu.style.top = (rect.top - menuHeight - 6) + 'px';
    } else {
      menu.style.top = (rect.bottom + 6) + 'px';
    }
    menu.style.right = (window.innerWidth - rect.right) + 'px';
    menu.style.left = 'auto';
  } else {
    menu.style.display = 'none';
  }
});
document.addEventListener('click', () => {
  document.getElementById('add-menu').style.display = 'none';
});
document.getElementById('add-entry-btn').addEventListener('click', () => {
  document.getElementById('add-menu').style.display = 'none';
  // Pre-fill category and folder if one is active
  const entry = activeFolder ? { cat: activeTab !== 'all' ? activeTab : 'notes', folder: activeFolder } : null;
  openFormModal(entry, true);
});
document.getElementById('add-folder-btn').addEventListener('click', () => {
  document.getElementById('add-menu').style.display = 'none';
  if (activeTab === 'all') {
    showToast('Select a category first to add a folder');
    return;
  }
  promptNewFolder(activeTab);
  document.getElementById('folder-row').style.display = 'block';
});

// ============================================================
// INIT
// ============================================================
async function init() {
  await openDB();
  loadFolders();
  allEntries = await dbAll();
  renderGrid();
  renderFolderRow();
  updateOnlineStatus();

  // Register service worker
  if ('serviceWorker' in navigator) {
    try {
      const reg = await navigator.serviceWorker.register('sw.js');
      console.log('[OffStash] SW registered');
      // Listen for updates from new SW and reload to get fresh version
      navigator.serviceWorker.addEventListener('message', e => {
        if (e.data?.type === 'SW_UPDATED') {
          console.log('[OffStash] New version available, reloading‚Ä¶');
          window.location.reload();
        }
      });
      // Check for updates every time app is focused
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') reg.update();
      });
    } catch(e) {
      console.warn('[OffStash] SW registration failed', e);
    }
  }
}

init();
</script>
</body>
</html>
