<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="OffStash+" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192.svg" />
  <title>OffStash+</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,400&family=Space+Grotesk:wght@300;400;500;600;700&display=swap');

    :root {
      --bg: #0a0a0a;
      --bg2: #111111;
      --bg3: #1a1a1a;
      --border: #222222;
      --border2: #2a2a2a;
      --text: #e8e8e8;
      --text2: #888888;
      --text3: #444444;
      --accent: #c8ff00;
      --accent2: #ff6b35;
      --accent3: #00d4ff;
      --card: #111111;
      --input: #161616;
      --radius: 8px;
      --mono: 'DM Mono', monospace;
      --sans: 'Space Grotesk', sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--sans);
      min-height: 100vh;
      height: 100%;
      -webkit-font-smoothing: antialiased;
      overscroll-behavior-x: none;
      overflow-x: hidden;
      overflow-y: auto;
      max-width: 100vw;
    }

    /* ADD MENU */
    .add-menu-wrap { position: relative; }
    .add-menu {
      position: fixed; top: auto; right: 12px;
      background: var(--bg2); border: 1px solid var(--border2);
      border-radius: var(--radius); overflow: hidden;
      min-width: 180px; z-index: 9999;
      box-shadow: 0 8px 32px rgba(0,0,0,0.8);
    }
    .add-menu-item {
      display: block; width: 100%; background: none; border: none;
      color: var(--text); padding: 11px 16px; text-align: left;
      cursor: pointer; font-family: var(--sans); font-size: 13px;
      transition: background 0.12s;
    }
    .add-menu-item:hover { background: var(--bg3); color: var(--accent); }

    /* FOLDER ROW */
    .folder-row {
      padding: 8px 20px;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
    }
    .folder-row-inner {
      display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
    }
    .folder-row-label {
      font-family: var(--mono); font-size: 10px;
      letter-spacing: 0.08em; text-transform: uppercase;
      color: var(--text3); flex-shrink: 0;
    }
    .folder-pills {
      display: flex; gap: 6px; flex-wrap: wrap; align-items: center;
    }
    .folder-pill {
      background: transparent; border: 1px solid var(--border);
      color: var(--text2); padding: 4px 10px;
      border-radius: 20px; cursor: pointer;
      font-family: var(--mono); font-size: 11px;
      letter-spacing: 0.04em; transition: all 0.15s;
      display: flex; align-items: center; gap: 6px; white-space: nowrap;
    }
    .folder-pill:hover { color: var(--text); border-color: var(--border2); }
    .folder-pill.active { background: #1a1a00; color: var(--accent); border-color: var(--accent); }
    .folder-pill.drag-target { border-color: var(--accent); background: #1a2000; }
    .folder-pill-del {
      background: none; border: none; color: var(--text3);
      cursor: pointer; font-size: 11px; padding: 0; line-height: 1;
    }
    .folder-pill-del:hover { color: #ff4444; }
    .btn-new-folder {
      background: transparent; border: 1px dashed var(--border2);
      color: var(--text3); padding: 4px 10px; border-radius: 20px;
      cursor: pointer; font-family: var(--mono); font-size: 11px;
      letter-spacing: 0.04em; transition: all 0.15s; white-space: nowrap;
    }
    .btn-new-folder:hover { color: var(--accent); border-color: var(--accent); }

    /* FOLDER CARD in grid */
    .folder-card {
      background: var(--bg3); border: 1px solid var(--border);
      border-radius: 10px; padding: 16px; cursor: pointer;
      transition: all 0.15s; position: relative;
      display: flex; flex-direction: column; gap: 8px;
      min-height: 100px;
    }
    .folder-card.drag-target { border-color: var(--accent); background: #1a2000; }
    .folder-card:hover { border-color: var(--border2); background: #1c1c1c; }
    .folder-card-icon { font-size: 28px; }
    .folder-card-name {
      font-size: 14px; font-weight: 600; color: var(--text);
    }
    .folder-card-count {
      font-family: var(--mono); font-size: 10px;
      color: var(--text3); letter-spacing: 0.05em;
    }
    .folder-card-actions {
      position: absolute; top: 10px; right: 10px;
      display: flex; gap: 6px;
    }
    .folder-card-btn {
      background: var(--bg); border: 1px solid var(--border);
      color: var(--text3); width: 26px; height: 26px;
      border-radius: 4px; cursor: pointer; font-size: 12px;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.12s;
    }
    .folder-card-btn:hover { color: var(--text); border-color: var(--border2); }
    .folder-card-btn.del:hover { color: #ff4444; border-color: #ff4444; }

    /* Draggable entry cards */
    .card[draggable="true"] { cursor: grab; }
    .card[draggable="true"]:active { cursor: grabbing; }
    .card.dragging { opacity: 0.4; }

    /* Folder badge on entry cards */
    .card-folder-badge {
      font-family: var(--mono); font-size: 9px;
      letter-spacing: 0.06em; text-transform: uppercase;
      color: var(--accent); background: #1a1a00;
      border: 1px solid #2a2a00; padding: 2px 6px;
      border-radius: 4px; margin-bottom: 4px; display: inline-block;
    }

    @media (min-width: 900px) {
      .folder-row { padding: 8px 32px; }
    }

    /* OFFLINE BANNER */
    #offline-banner {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0;
      background: #1a1200;
      border-bottom: 1px solid #ff6b35;
      color: #ff6b35;
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: 0.08em;
      padding: 6px 16px;
      text-align: center;
      z-index: 9999;
    }
    #offline-banner.show { display: block; }

    /* LAYOUT */
    #app {
      max-width: 1200px;
      margin: 0 auto;
      padding: env(safe-area-inset-top, 0) env(safe-area-inset-right, 0) env(safe-area-inset-bottom, 0) env(safe-area-inset-left, 0);
      padding-top: calc(env(safe-area-inset-top, 0px) + 0px);
    }

    /* HEADER */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 20px 16px;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      background: var(--bg);
      z-index: 9998;
      gap: 12px;
      width: 100%;
      box-sizing: border-box;
      overflow: visible;
    }

    .logo {
      display: flex;
      align-items: baseline;
      gap: 4px;
      flex-shrink: 0;
    }

    .logo-text {
      font-family: var(--mono);
      font-size: 18px;
      font-weight: 500;
      color: var(--text);
      letter-spacing: -0.02em;
    }

    .logo-plus {
      font-family: var(--mono);
      font-size: 18px;
      color: var(--accent);
    }

    .header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-shrink: 0;
    }

    .icon-btn {
      background: var(--bg3);
      border: 1px solid var(--border);
      color: var(--text2);
      height: 36px;
      padding: 0 12px;
      border-radius: var(--radius);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.15s;
      font-size: 13px;
      font-family: var(--sans);
      flex-shrink: 0;
      white-space: nowrap;
    }
    .icon-btn:hover { color: var(--text); border-color: var(--border2); background: #222; }
    .icon-btn:active { transform: scale(0.95); }
    .icon-btn .btn-icon { font-size: 14px; }
    /* Hide labels on very small screens */
    /* Mobile header ‚Äî hide labels, shrink buttons */
    @media (max-width: 699px) {
      .icon-btn .btn-label { display: none; }
      .icon-btn { padding: 0; width: 34px; height: 34px; }
      .btn-add { padding: 0 10px; height: 34px; font-size: 12px; }
      .header-actions { gap: 5px; }
      header { padding: 10px 12px; }
    }
    @media (max-width: 380px) {
      .icon-btn { width: 30px; height: 30px; }
      .btn-add { padding: 0 8px; font-size: 11px; }
      .header-actions { gap: 4px; }
    }

    .btn-add {
      background: var(--accent);
      color: #000;
      border: none;
      height: 36px;
      padding: 0 14px;
      border-radius: var(--radius);
      cursor: pointer;
      font-family: var(--sans);
      font-weight: 600;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s;
      flex-shrink: 0;
    }
    .btn-add:hover { background: #d4ff00; }
    .btn-add:active { transform: scale(0.95); }

    /* SEARCH */
    .search-wrap {
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
    }

    .search-input {
      width: 100%;
      background: var(--input);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 14px 10px 38px;
      border-radius: var(--radius);
      font-family: var(--sans);
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s;
      position: relative;
    }
    .search-input:focus { border-color: var(--border2); }
    .search-input::placeholder { color: var(--text3); }

    .search-wrap .search-icon {
      position: absolute;
      left: 33px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text3);
      font-size: 15px;
      pointer-events: none;
    }
    .search-container { position: relative; }

    /* TABS ‚Äî mobile: scrollable pills, desktop: dropdown */
    .tabs-wrap {
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
      box-sizing: border-box;
      width: 100%;
      overflow: hidden;
      position: relative;
      z-index: 1;
    }

    /* Mobile pill tabs */
    .tabs-mobile {
      display: flex;
      gap: 6px;
      overflow-x: auto;
      scrollbar-width: none;
    }
    .tabs-mobile::-webkit-scrollbar { display: none; }

    .tab {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text2);
      padding: 6px 12px;
      border-radius: 20px;
      cursor: pointer;
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      transition: all 0.15s;
      white-space: nowrap;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .tab:hover { color: var(--text); border-color: var(--border2); }
    .tab.active {
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
      font-weight: 500;
    }
    .tab-count {
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      padding: 1px 6px;
      font-size: 9px;
      font-weight: 600;
      letter-spacing: 0;
    }
    .tab.active .tab-count { background: rgba(0,0,0,0.25); color: #000; }

    /* Hover preview tooltip */
    #hover-preview {
      position: fixed;
      z-index: 9990;
      background: var(--bg2);
      border: 1px solid var(--border2);
      border-radius: 12px;
      padding: 0;
      width: 300px;
      max-height: 420px;
      overflow: hidden;
      box-shadow: 0 12px 40px rgba(0,0,0,0.8);
      pointer-events: none;
      opacity: 0;
      transform: translateY(6px) scale(0.98);
      transition: opacity 0.18s, transform 0.18s;
      font-size: 12px;
      display: flex;
      flex-direction: column;
    }
    #hover-preview.show { opacity: 1; transform: translateY(0) scale(1); }

    /* Color bar at top */
    #hover-preview .hp-color-bar {
      height: 3px;
      background: var(--cat-color, var(--border));
      border-radius: 12px 12px 0 0;
      flex-shrink: 0;
    }
    #hover-preview .hp-inner {
      padding: 12px 14px;
      overflow-y: auto;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    #hover-preview .hp-header {
      display: flex; align-items: flex-start; justify-content: space-between; gap: 8px;
    }
    #hover-preview .hp-cat {
      font-family: var(--mono); font-size: 9px; letter-spacing: 0.08em;
      text-transform: uppercase; color: var(--cat-color, var(--text3));
      margin-bottom: 3px;
    }
    #hover-preview .hp-title {
      font-weight: 700; font-size: 13px; color: var(--text); line-height: 1.3;
    }
    #hover-preview .hp-folder {
      font-family: var(--mono); font-size: 9px; color: var(--text3); margin-top: 3px;
    }
    #hover-preview .hp-dates {
      font-family: var(--mono); font-size: 9px; color: var(--text3);
      display: flex; flex-direction: column; gap: 2px; text-align: right; flex-shrink: 0;
    }

    /* Content section */
    #hover-preview .hp-content {
      font-size: 11px; color: var(--text2); line-height: 1.55;
      white-space: pre-wrap; word-break: break-word;
      display: -webkit-box; -webkit-line-clamp: 5; -webkit-box-orient: vertical; overflow: hidden;
      background: var(--bg3); border-radius: 6px; padding: 8px 10px;
    }

    /* Tags */
    #hover-preview .hp-tags {
      display: flex; gap: 4px; flex-wrap: wrap;
    }
    #hover-preview .hp-tags .tag { font-size: 9px; padding: 1px 6px; }
    #hover-preview .hp-tags-more {
      font-family: var(--mono); font-size: 9px; color: var(--text3);
      padding: 1px 6px; background: var(--bg3); border-radius: 10px;
    }

    /* Attachments */
    #hover-preview .hp-attachments {
      display: flex; flex-direction: column; gap: 4px;
    }
    #hover-preview .hp-section-label {
      font-family: var(--mono); font-size: 9px; letter-spacing: 0.06em;
      text-transform: uppercase; color: var(--text3); margin-bottom: 2px;
    }
    #hover-preview .hp-attach-row {
      display: flex; align-items: center; gap: 8px;
      background: var(--bg3); border-radius: 6px; padding: 5px 8px;
    }
    #hover-preview .hp-attach-thumb {
      width: 36px; height: 36px; object-fit: cover;
      border-radius: 4px; flex-shrink: 0;
    }
    #hover-preview .hp-attach-icon {
      font-size: 20px; width: 36px; text-align: center; flex-shrink: 0;
    }
    #hover-preview .hp-attach-info { flex: 1; min-width: 0; }
    #hover-preview .hp-attach-name {
      font-size: 11px; color: var(--text2); overflow: hidden;
      text-overflow: ellipsis; white-space: nowrap;
    }
    #hover-preview .hp-attach-size {
      font-family: var(--mono); font-size: 9px; color: var(--text3);
    }

    /* Links */
    #hover-preview .hp-links { display: flex; flex-direction: column; gap: 3px; }
    #hover-preview .hp-link-row {
      display: flex; align-items: center; gap: 6px;
      background: var(--bg3); border-radius: 6px; padding: 5px 8px;
      font-size: 11px; color: var(--text2); overflow: hidden;
      text-overflow: ellipsis; white-space: nowrap;
    }

    /* Bulk select mode */
    .bulk-bar {
      display: none;
      align-items: center;
      gap: 10px;
      background: var(--bg2);
      border: 1px solid var(--accent);
      border-radius: 8px;
      padding: 8px 14px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .bulk-bar.show { display: flex; }
    .bulk-count {
      font-family: var(--mono); font-size: 11px; color: var(--accent);
      letter-spacing: 0.05em; flex: 1;
    }
    .bulk-btn {
      background: var(--bg3); border: 1px solid var(--border);
      color: var(--text2); padding: 5px 10px; border-radius: 6px;
      cursor: pointer; font-family: var(--mono); font-size: 10px;
      letter-spacing: 0.04em; transition: all 0.15s;
    }
    .bulk-btn:hover { border-color: var(--border2); color: var(--text); }
    .bulk-btn.danger { color: #ff6b35; }
    .bulk-btn.danger:hover { background: #220000; border-color: #ff6b35; }
    .bulk-toggle {
      background: var(--bg3); border: 1px solid var(--border);
      color: var(--text2); padding: 5px 10px; border-radius: 6px;
      cursor: pointer; font-family: var(--mono); font-size: 10px;
      letter-spacing: 0.04em; transition: all 0.15s; white-space: nowrap;
    }
    .bulk-toggle.active { background: #1a2000; color: var(--accent); border-color: var(--accent); }
    .bulk-toggle:hover { border-color: var(--border2); }

    /* Card checkbox overlay */
    .card-check {
      position: absolute; top: 10px; right: 10px;
      width: 18px; height: 18px;
      border: 2px solid var(--border2);
      border-radius: 4px; background: var(--bg2);
      display: none; align-items: center; justify-content: center;
      z-index: 2; transition: all 0.1s; cursor: pointer;
      font-size: 11px; color: transparent;
    }
    .bulk-mode .card-check { display: flex; }
    .bulk-mode .card { cursor: default; }
    .bulk-mode .card.selected { border-color: var(--accent); background: #0e1500; }
    .bulk-mode .card.selected .card-check {
      background: var(--accent); border-color: var(--accent); color: #000;
    }

    /* Bulk re-cat select */
    #bulk-recat-select {
      background: var(--bg3); border: 1px solid var(--border);
      color: var(--text2); padding: 5px 8px; border-radius: 6px;
      font-family: var(--mono); font-size: 10px; cursor: pointer;
      outline: none; display: none;
    }
    #bulk-recat-select.show { display: block; }

    /* Desktop dropdown */
    .tabs-desktop { display: none; align-items: center; gap: 10px; }

    .cat-dropdown {
      appearance: none;
      -webkit-appearance: none;
      background: var(--input);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 36px 8px 14px;
      border-radius: var(--radius);
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      cursor: pointer;
      outline: none;
      min-width: 220px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23666' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      transition: border-color 0.15s;
    }
    .cat-dropdown:focus { border-color: var(--accent); }
    .cat-dropdown option { background: var(--bg2); text-transform: uppercase; }

    .cat-dropdown-label {
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text3);
    }

    /* EMPTY DROP ZONE */
    .empty-drop-zone {
      border: 2px dashed var(--border2);
      border-radius: 16px;
      padding: 40px 30px;
      transition: all 0.2s;
      cursor: pointer;
    }
    .empty-drop-zone.drag-over {
      border-color: var(--accent);
      background: #1a2000;
    }
    .empty-drop-zone.drag-over .empty-icon { color: var(--accent); }
    .empty-drop-hint {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text3);
      margin-top: 10px;
      letter-spacing: 0.05em;
    }

    /* ATTACHMENTS & LINKS */
    .attach-zone {
      border: 1px dashed var(--border2);
      border-radius: var(--radius);
      padding: 14px;
      text-align: center;
      cursor: pointer;
      transition: all 0.15s;
      color: var(--text3);
      font-size: 12px;
      font-family: var(--mono);
      letter-spacing: 0.04em;
    }
    .attach-zone:hover { border-color: var(--accent); color: var(--accent); }

    .attach-list { display: flex; flex-direction: column; gap: 6px; margin-top: 8px; }
    .attach-item {
      display: flex; align-items: center; gap: 8px;
      background: var(--bg3); border: 1px solid var(--border);
      border-radius: 6px; padding: 8px 10px; font-size: 12px;
    }
    .attach-icon { font-size: 16px; flex-shrink: 0; }
    .attach-name { flex: 1; color: var(--text2); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .attach-size { font-family: var(--mono); font-size: 10px; color: var(--text3); flex-shrink: 0; }
    .attach-remove {
      background: none; border: none; color: var(--text3); cursor: pointer;
      font-size: 14px; padding: 0 2px; line-height: 1; flex-shrink: 0;
    }
    .attach-remove:hover { color: #ff4444; }
    .attach-warning { color: #ff6b35; font-family: var(--mono); font-size: 10px; margin-top: 4px; }

    .import-mode-btn {
      flex: 1; background: var(--bg3); border: 1px solid var(--border);
      color: var(--text2); padding: 8px 12px; border-radius: var(--radius);
      cursor: pointer; font-family: var(--mono); font-size: 11px;
      letter-spacing: 0.04em; transition: all 0.15s; text-align: center;
    }
    .import-mode-btn:hover { border-color: var(--border2); color: var(--text); }
    .import-mode-btn.active { background: #1a2000; color: var(--accent); border-color: var(--accent); }

    /* DESKTOP 2-COL FORM */
    .form-desktop-cols {
      display: flex;
      flex-direction: column;
      gap: 0;
    }
    .form-col { display: flex; flex-direction: column; }

    @media (min-width: 700px) {
      .form-desktop-cols {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0 16px;
        align-items: start;
      }
      /* Make right col content fill height */
      .form-col:last-child {
        display: flex;
        flex-direction: column;
      }
      .form-col:last-child .form-group:first-child {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .form-col:last-child .form-group:first-child textarea {
        flex: 1;
        height: auto;
        min-height: 100px;
      }
    }

    /* SUGGESTED TAGS ‚Äî always 2 rows of 4 */
    .suggested-tags {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 4px;
      margin-top: 4px;
    }
    .suggested-tag {
      background: transparent; border: 1px dashed var(--border2);
      color: var(--text3); padding: 3px 6px; border-radius: 20px;
      cursor: pointer; font-family: var(--mono); font-size: 10px;
      letter-spacing: 0.04em; transition: all 0.15s;
      text-align: center; overflow: hidden;
      text-overflow: ellipsis; white-space: nowrap;
    }
    .suggested-tag:hover { border-color: var(--accent); color: var(--accent); background: #1a2000; }
    .suggested-tag.used { opacity: 0.3; pointer-events: none; text-decoration: line-through; }

    .link-row { display: flex; gap: 8px; margin-bottom: 6px; }
    .link-row input { flex: 1; }
    .link-row input:first-child { flex: 2; }
    .btn-add-link {
      background: var(--bg3); border: 1px solid var(--border); color: var(--text2);
      padding: 0 12px; border-radius: var(--radius); cursor: pointer; font-size: 18px;
      transition: all 0.15s; flex-shrink: 0; height: 40px;
    }
    .btn-add-link:hover { color: var(--accent); border-color: var(--accent); }

    .link-list { display: flex; flex-direction: column; gap: 6px; margin-top: 4px; }
    .link-item {
      display: flex; align-items: center; gap: 8px;
      background: var(--bg3); border: 1px solid var(--border);
      border-radius: 6px; padding: 8px 10px;
    }
    .link-anchor {
      flex: 1; color: var(--accent3); font-size: 12px; text-decoration: none;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .link-anchor:hover { text-decoration: underline; }
    .link-label-text { font-size: 12px; color: var(--text2); margin-right: 4px; }

    /* View modal sections */
    .view-section-title {
      font-family: var(--mono); font-size: 10px; letter-spacing: 0.08em;
      text-transform: uppercase; color: var(--text3); margin: 18px 0 8px;
    }
    .view-attach-item {
      display: flex; align-items: center; gap: 10px;
      background: var(--bg3); border: 1px solid var(--border);
      border-radius: 6px; padding: 10px 12px; margin-bottom: 6px;
    }
    .view-attach-btn {
      background: var(--bg); border: 1px solid var(--border);
      color: var(--text2); padding: 4px 10px; border-radius: 4px;
      font-family: var(--mono); font-size: 10px; cursor: pointer;
      text-decoration: none; transition: all 0.15s; flex-shrink: 0;
      display: inline-block;
    }
    .view-attach-btn:hover { color: var(--accent); border-color: var(--accent); }
    .view-attach-btn.view-btn { color: var(--accent3); border-color: #002a30; }
    .view-attach-btn.view-btn:hover { background: #001a20; }
    .attach-actions { display: flex; gap: 6px; margin-left: auto; flex-shrink: 0; }

    /* INLINE VIEWER */
    #viewer-modal { border-radius: 16px; }
    #viewer-body img {
      max-width: 100%; max-height: 100%;
      width: auto; height: auto;
      object-fit: contain; border-radius: 4px;
      display: block;
    }
    #viewer-body iframe {
      width: 100%; height: 100%;
      border: none; border-radius: 4px; background: #fff;
    }
    #viewer-body .viewer-text {
      width: 100%; height: 100%; overflow: auto;
      font-family: var(--mono); font-size: 12px;
      color: var(--text2); white-space: pre-wrap;
      word-break: break-word; padding: 16px; line-height: 1.6;
    }
    #viewer-body .viewer-unsupported {
      text-align: center; color: var(--text3);
      font-family: var(--mono); font-size: 13px; padding: 40px;
    }
    #viewer-body .viewer-unsupported .big { font-size: 48px; display: block; margin-bottom: 16px; }

    /* HTML PREVIEW TOGGLE */
    #viewer-toggle-bar {
      display: none;
      gap: 4px;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 3px;
      margin-right: 10px;
    }
    #viewer-toggle-bar.show { display: flex; }
    .viewer-toggle-btn {
      background: transparent; border: none;
      color: var(--text3); padding: 4px 12px;
      border-radius: 5px; cursor: pointer;
      font-family: var(--mono); font-size: 11px;
      letter-spacing: 0.04em; transition: all 0.15s;
    }
    .viewer-toggle-btn.active {
      background: var(--bg); color: var(--accent);
      box-shadow: 0 1px 4px rgba(0,0,0,0.4);
    }
    .viewer-toggle-btn:not(.active):hover { color: var(--text); }

    /* CONTENT */
    .content {
      padding: 16px 20px;
      box-sizing: border-box;
      width: 100%;
    }

    /* STATS BAR */
    .stats-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      flex-wrap: nowrap;
    }
    .stats-count {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text3);
      letter-spacing: 0.05em;
      flex: 1;
      min-width: 0;
      white-space: nowrap;
    }
    .stats-controls {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: nowrap;
      flex-shrink: 0;
    }
    .sort-select {
      background: var(--bg3);
      border: 1px solid var(--border);
      color: var(--text2);
      padding: 5px 8px;
      border-radius: 6px;
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing: 0.04em;
      cursor: pointer;
      outline: none;
      transition: border-color 0.15s;
    }
    .sort-select:hover, .sort-select:focus { border-color: var(--border2); color: var(--text); }
    .view-toggle {
      display: flex;
      gap: 3px;
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 3px;
    }
    .view-btn {
      background: none;
      border: none;
      color: var(--text3);
      padding: 4px 7px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      line-height: 1;
      transition: all 0.15s;
    }
    .view-btn:hover { color: var(--text); background: var(--bg2); }
    .view-btn.active { background: var(--accent); color: #000; }

    /* GRID ‚Äî layout modes */
    .grid { display: grid; gap: 12px; }
    .grid.layout-normal { grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); }
    .grid.layout-compact { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 8px; }
    .grid.layout-list { grid-template-columns: 1fr; gap: 6px; }

    /* Compact card tweaks */
    .layout-compact .card { padding: 10px 12px; }
    .layout-compact .card-preview { -webkit-line-clamp: 2; font-size: 11px; }
    .layout-compact .card-title { font-size: 12px; -webkit-line-clamp: 1; }
    .layout-compact .card-cat { font-size: 9px; margin-bottom: 4px; }
    .layout-compact .card-footer { margin-top: 8px; }
    .layout-compact .card-tags { display: none; }

    /* List view card tweaks */
    .layout-list .card {
      display: grid;
      grid-template-columns: auto 1fr auto;
      grid-template-rows: auto auto;
      align-items: center;
      gap: 0 12px;
      padding: 10px 14px;
      border-radius: 8px;
    }
    .layout-list .card::before { width: 3px; height: 100%; top: 0; left: 0; right: auto; border-radius: 8px 0 0 8px; }
    .layout-list .card-cat { grid-column: 1; grid-row: 1; margin-bottom: 0; font-size: 9px; white-space: nowrap; }
    .layout-list .card-title { grid-column: 2; grid-row: 1; font-size: 13px; margin-bottom: 0; -webkit-line-clamp: 1; }
    .layout-list .card-preview { grid-column: 2; grid-row: 2; -webkit-line-clamp: 1; font-size: 11px; margin-top: 2px; }
    .layout-list .card-footer { grid-column: 3; grid-row: 1 / 3; flex-direction: column; align-items: flex-end; gap: 4px; margin-top: 0; }
    .layout-list .card-folder-badge { grid-column: 1 / 4; font-size: 9px; margin-bottom: 2px; }

    /* Mosaic layout ‚Äî variable height columns */
    /* Micro layout ‚Äî maximum density pill rows */
    .grid.layout-micro {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .grid.layout-micro .card {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 10px;
      border-radius: 6px;
      min-height: 0;
    }
    .grid.layout-micro .card::before { width: 3px; height: 100%; top: 0; left: 0; right: auto; border-radius: 6px 0 0 6px; }
    .grid.layout-micro .card-cat { font-size: 8px; white-space: nowrap; margin-bottom: 0; min-width: 54px; }
    .grid.layout-micro .card-title { font-size: 12px; flex: 1; margin-bottom: 0; -webkit-line-clamp: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
    .grid.layout-micro .card-preview { display: none; }
    .grid.layout-micro .card-footer { margin-top: 0; flex-shrink: 0; }
    .grid.layout-micro .card-tags { display: none; }
    .grid.layout-micro .card-date { font-size: 9px; }
    .grid.layout-micro .card-folder-badge { display: none; }

    /* CARD */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.15s;
      position: relative;
      overflow: hidden;
    }
    .card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 2px;
      background: var(--cat-color, var(--border));
    }
    .card:hover {
      border-color: var(--border2);
      background: #161616;
      transform: translateY(-1px);
    }
    .card:active { transform: scale(0.99); }

    .card-cat {
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--cat-color, var(--text3));
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 6px;
      line-height: 1.3;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .card-preview {
      font-size: 12px;
      color: var(--text2);
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .card-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 12px;
    }

    .card-date {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--text3);
    }

    .card-tags {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .tag {
      background: var(--bg3);
      border: 1px solid var(--border);
      color: var(--text3);
      font-family: var(--mono);
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 4px;
      letter-spacing: 0.04em;
    }

    /* EMPTY STATE */
    .empty {
      text-align: center;
      padding: 40px 16px;
      color: var(--text3);
      box-sizing: border-box;
      width: 100%;
      overflow: hidden;
    }
    .empty-icon { font-size: 40px; margin-bottom: 12px; }
    .empty-title {
      font-family: var(--mono);
      font-size: 13px;
      letter-spacing: 0.05em;
      margin-bottom: 6px;
      color: var(--text2);
    }
    .empty-sub { font-size: 12px; }

    /* MODAL OVERLAY */
    /* OVERLAY ‚Äî dim backdrop */
    .overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      z-index: 200;
    }
    .overlay.show { display: block; }

    /* MODAL ‚Äî fixed sheet anchored to bottom, never uses flexbox height tricks */
    /* Mobile: sheet from bottom */
    /* Modal ‚Äî auto height, scrolls only when content exceeds screen */
    .modal {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      z-index: 201;
      background: var(--bg2);
      border: 1px solid var(--border2);
      border-radius: 16px 16px 0 0;
      width: 100%;
      max-width: 680px;
      margin: 0 auto;
      height: 88vh;
      max-height: 88vh;
      display: none;
      flex-direction: column;
      overflow: hidden;
      box-sizing: border-box;
    }
    .overlay.show + .modal,
    .modal.show {
      display: flex;
    }
    /* Desktop: centered dialog */
    /* Mobile modal ‚Äî centered floating box, pushed below sticky header (~60px) */
    @media (max-width: 699px) {
      .modal {
        top: calc(50% + 30px);
        bottom: auto;
        left: 50%;
        transform: translate(-50%, calc(-50% + 30px));
        border-radius: 16px;
        border: 1px solid var(--border2);
        height: auto;
        max-height: calc(82vh - 90px);
        width: calc(100% - 32px);
        max-width: 480px;
        padding-bottom: 12px;
      }
      /* Single column form on mobile */
      .form-desktop-cols {
        display: flex !important;
        flex-direction: column !important;
        grid-template-columns: unset !important;
      }
      .form-col:last-child { order: 2; }
      .form-col:first-child { order: 1; }
      /* Smaller textarea on mobile */
      #f-content {
        height: 70px !important;
        min-height: 70px !important;
        flex: none !important;
      }
      /* Tighter form groups on mobile */
      .form-group { margin-bottom: 5px !important; }
      .modal-inner { padding: 0 16px 8px !important; }
      /* Hide drag handle on centered modal */
      .modal-handle { display: none; }
    }

    @media (min-width: 700px) {
      .modal {
        top: calc(50% + 35px);
        bottom: auto;
        left: 50%;
        transform: translate(-50%, -50%);
        border-radius: 16px;
        border: 1px solid var(--border2);
        height: auto;
        max-height: calc(92vh - 70px);
        width: calc(100% - 48px);
        max-width: 820px;
      }
    }
    .modal-inner {
      overflow-y: auto;
      overflow-x: hidden;
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
      padding: 0 20px 20px;
      flex: 1;
      min-height: 0;
    }
    .modal-header {
      padding: 6px 20px 4px;
      flex-shrink: 0;
    }

    .modal-handle {
      width: 36px;
      height: 4px;
      background: var(--border2);
      border-radius: 2px;
      margin: 0 auto 6px;
    }

    .modal-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 0;
    }

    .form-group {
      margin-bottom: 6px;
    }

    label {
      display: block;
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text2);
      margin-bottom: 4px;
    }

    input[type="text"], textarea, select {
      width: 100%;
      background: var(--input);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 6px 10px;
      border-radius: var(--radius);
      font-family: var(--sans);
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s;
    }
    input[type="text"]:focus,
    textarea:focus,
    select:focus { border-color: var(--accent); }
    textarea { resize: none; height: 90px; line-height: 1.5; }
    select option { background: var(--bg2); }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 6px;
      padding-bottom: 8px;
      flex-shrink: 0;
    }

    .btn-save {
      flex: 1;
      background: var(--accent);
      color: #000;
      border: none;
      height: 38px;
      border-radius: var(--radius);
      cursor: pointer;
      font-family: var(--sans);
      font-weight: 700;
      font-size: 14px;
      transition: all 0.15s;
    }
    .btn-save:hover { background: #d4ff00; }

    .btn-cancel {
      background: var(--bg3);
      color: var(--text2);
      border: 1px solid var(--border);
      height: 38px;
      padding: 0 20px;
      border-radius: var(--radius);
      cursor: pointer;
      font-family: var(--sans);
      font-size: 14px;
      transition: all 0.15s;
    }
    .btn-cancel:hover { color: var(--text); }

    .btn-danger {
      background: #1a0000;
      color: #ff4444;
      border: 1px solid #330000;
      height: 38px;
      padding: 0 20px;
      border-radius: var(--radius);
      cursor: pointer;
      font-family: var(--sans);
      font-size: 14px;
      transition: all 0.15s;
    }
    .btn-danger:hover { background: #220000; }

    /* VIEW MODAL */
    .view-content {
      font-size: 14px;
      line-height: 1.7;
      color: var(--text2);
      white-space: pre-wrap;
      word-break: break-word;
    }

    .view-meta {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      align-items: center;
    }

    .view-cat-badge {
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      padding: 4px 8px;
      border-radius: 4px;
    }

    /* CATEGORY COLORS */
    .cat-finance  { --cat-color: #c8ff00; }
    .cat-health   { --cat-color: #ff6b9d; }
    .cat-recipes  { --cat-color: #ff6b35; }
    .cat-home     { --cat-color: #ffd166; }
    .cat-work     { --cat-color: #00d4ff; }
    .cat-travel   { --cat-color: #06ffa5; }
    .cat-learning { --cat-color: #a78bfa; }
    .cat-ideas    { --cat-color: #f97316; }
    .cat-notes    { --cat-color: #94a3b8; }
    .cat-photos   { --cat-color: #f472b6; }
    .cat-music    { --cat-color: #e879f9; }

    .cat-badge-finance  { background: #1a2000; color: #c8ff00; border: 1px solid #2a3800; }
    .cat-badge-health   { background: #1a0010; color: #ff6b9d; border: 1px solid #2a0020; }
    .cat-badge-recipes  { background: #1a0e00; color: #ff6b35; border: 1px solid #2a1800; }
    .cat-badge-home     { background: #1a1600; color: #ffd166; border: 1px solid #2a2200; }
    .cat-badge-work     { background: #001a20; color: #00d4ff; border: 1px solid #002a30; }
    .cat-badge-travel   { background: #001a10; color: #06ffa5; border: 1px solid #002a18; }
    .cat-badge-learning { background: #130020; color: #a78bfa; border: 1px solid #1e0030; }
    .cat-badge-ideas    { background: #1a0800; color: #f97316; border: 1px solid #2a1200; }
    .cat-badge-notes    { background: #111620; color: #94a3b8; border: 1px solid #1a2030; }
    .cat-badge-photos   { background: #1a0015; color: #f472b6; border: 1px solid #2a0025; }
    .cat-badge-music    { background: #1a0020; color: #e879f9; border: 1px solid #2a0035; }

    /* TOAST */
    #toast {
      position: fixed;
      bottom: calc(20px + env(safe-area-inset-bottom, 0px));
      left: 50%;
      transform: translateX(-50%) translateY(80px);
      background: var(--bg3);
      border: 1px solid var(--border2);
      color: var(--text);
      padding: 10px 18px;
      border-radius: 20px;
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing: 0.04em;
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 9999;
      white-space: nowrap;
    }
    #toast.show { transform: translateX(-50%) translateY(0); }

    /* SCROLLBAR */
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

    @media (max-width: 480px) {
      .grid.layout-normal { grid-template-columns: 1fr; }
      .form-row { grid-template-columns: 1fr; }
    }
    @media (min-width: 700px) {
      .tabs-mobile { display: none; }
      .tabs-desktop { display: flex; }
    }
    @media (max-width: 699px) {
      .tabs-mobile { display: none; }
      .tabs-desktop { display: flex; }
    }
    @media (min-width: 900px) {
      .grid.layout-normal { grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); }
      header { padding: 20px 32px 16px; }
      .search-wrap { padding: 14px 32px; }
      .tabs-wrap { padding: 12px 32px; }
      .content { padding: 20px 32px; }
    }
  </style>
</head>
<body>

<!-- CONFIRM MODAL -->
<div class="overlay" id="confirm-overlay"></div>
<div class="modal" id="confirm-modal" style="max-width:420px;">
  <div class="modal-header" style="padding-bottom:8px;">
    <div class="modal-handle"></div>
    <div class="modal-title" id="confirm-title" style="font-size:15px;">Are you sure?</div>
  </div>
  <div class="modal-inner" style="padding-top:4px;">
    <div id="confirm-message" style="font-size:13px;color:var(--text2);line-height:1.6;margin-bottom:16px;"></div>
    <div class="modal-actions">
      <button class="btn-cancel" id="confirm-cancel-btn">Cancel</button>
      <button class="btn-danger" id="confirm-ok-btn" style="flex:1;">Delete</button>
    </div>
  </div>
</div>

<!-- RENAME MODAL -->
<div class="overlay" id="rename-overlay"></div>
<div class="modal" id="rename-modal" style="max-width:420px;">
  <div class="modal-header" style="padding-bottom:8px;">
    <div class="modal-handle"></div>
    <div class="modal-title" style="font-size:15px;">Rename Folder</div>
  </div>
  <div class="modal-inner" style="padding-top:4px;">
    <div class="form-group">
      <label>New name</label>
      <input type="text" id="rename-input" placeholder="Folder name‚Ä¶" />
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" id="rename-cancel-btn">Cancel</button>
      <button class="btn-save" id="rename-ok-btn">Rename</button>
    </div>
  </div>
</div>

<!-- Full-page drag hint -->
<div id="drop-overlay-hint" style="display:none;position:fixed;inset:0;z-index:9998;background:rgba(0,0,0,0.85);align-items:center;justify-content:center;flex-direction:column;gap:16px;pointer-events:none;">
  <div style="font-size:64px;">üìÇ</div>
  <div style="font-family:var(--mono);font-size:16px;color:var(--accent);letter-spacing:0.08em;">DROP FILES TO IMPORT</div>
  <div style="font-family:var(--mono);font-size:12px;color:var(--text2);">PDFs, images, docs ‚Äî any file type</div>
</div>

<div id="offline-banner">‚ö° Offline Mode ‚Äî Viewing cached stash</div>
<div id="toast"></div>

<div id="app">
  <header>
    <div class="logo">
      <span class="logo-text">OffStash</span>
      <span class="logo-plus">+</span>
    </div>
    <div class="header-actions">
      <button class="icon-btn" id="import-files-btn" title="Import Files (PDF, images, docs)">
        <span class="btn-icon">üìÅ</span><span class="btn-label">Import Files</span>
      </button>
      <button class="icon-btn" id="import-btn" title="Import JSON backup">
        <span class="btn-icon">‚¨Ü</span><span class="btn-label">Import JSON</span>
      </button>
      <button class="icon-btn" id="export-btn" title="Export JSON backup">
        <span class="btn-icon">‚¨á</span><span class="btn-label">Export JSON</span>
      </button>
      <div class="add-menu-wrap" id="add-menu-wrap">
      <button class="btn-add" id="add-btn">+ Add ‚ñæ</button>
      <div class="add-menu" id="add-menu" style="display:none">
        <button class="add-menu-item" id="add-entry-btn">üìù New Entry</button>
        <button class="add-menu-item" id="add-folder-btn">üìÅ New Folder</button>
      </div>
    </div>
    </div>
  </header>

  <div class="search-wrap">
    <div class="search-container">
      <span class="search-icon">‚åï</span>
      <input type="text" class="search-input" id="search" placeholder="Search titles, content, tags‚Ä¶" autocomplete="off" autocorrect="off" />
    </div>
  </div>

  <div class="tabs-wrap">
    <!-- Mobile: scrollable pills -->
    <div class="tabs-mobile" id="tabs">
      <button class="tab active" data-cat="all">All</button>
      <button class="tab" data-cat="finance">Finance & Money</button>
      <button class="tab" data-cat="health">Health & Medical</button>
      <button class="tab" data-cat="recipes">Recipes & Food</button>
      <button class="tab" data-cat="home">Home & DIY</button>
      <button class="tab" data-cat="work">Work & Career</button>
      <button class="tab" data-cat="travel">Travel</button>
      <button class="tab" data-cat="learning">Learning & Research</button>
      <button class="tab" data-cat="ideas">Ideas & Projects</button>
      <button class="tab" data-cat="notes">Personal Notes</button>
      <button class="tab" data-cat="photos">Photos & Images</button>
      <button class="tab" data-cat="music">Music</button>
    </div>
    <!-- Desktop: dropdown selector -->
    <div class="tabs-desktop">
      <span class="cat-dropdown-label">Category</span>
      <select class="cat-dropdown" id="cat-dropdown">
        <option value="all">All Categories</option>
        <option value="finance">Finance & Money</option>
        <option value="health">Health & Medical</option>
        <option value="recipes">Recipes & Food</option>
        <option value="home">Home & DIY</option>
        <option value="work">Work & Career</option>
        <option value="travel">Travel</option>
        <option value="learning">Learning & Research</option>
        <option value="ideas">Ideas & Projects</option>
        <option value="notes">Personal Notes</option>
        <option value="photos">Photos &amp; Images</option>
        <option value="music">Music</option>
      </select>
    </div>
  </div>

  <!-- FOLDER ROW -->
  <div class="folder-row" id="folder-row" style="display:none">
    <div class="folder-row-inner">
      <span class="folder-row-label">üìÅ Folders</span>
      <div class="folder-pills" id="folder-pills"></div>
    </div>
  </div>

  <!-- Hover preview tooltip -->
  <div id="hover-preview">
    <div class="hp-color-bar" id="hp-color-bar"></div>
    <div class="hp-inner">
      <div class="hp-header">
        <div>
          <div class="hp-cat" id="hp-cat"></div>
          <div class="hp-title" id="hp-title"></div>
          <div class="hp-folder" id="hp-folder"></div>
        </div>
        <div class="hp-dates" id="hp-dates"></div>
      </div>
      <div class="hp-tags" id="hp-tags"></div>
      <div class="hp-content" id="hp-content"></div>
      <div class="hp-attachments" id="hp-attachments"></div>
      <div class="hp-links" id="hp-links"></div>
    </div>
  </div>

  <div class="content">
    <div class="stats-bar">
      <span class="stats-count"><span id="count-text">0 entries</span><span id="filter-text"></span></span>
      <div class="stats-controls">
        <button class="bulk-toggle" id="bulk-toggle-btn" onclick="toggleBulkMode()">‚òê Select</button>
        <select class="sort-select" id="sort-select" onchange="activeSort=this.value;renderGrid()">
          <option value="newest">‚Üì Newest</option>
          <option value="oldest">‚Üë Oldest</option>
          <option value="az">A ‚Üí Z</option>
          <option value="za">Z ‚Üí A</option>
          <option value="cat">Category</option>
          <option value="updated">‚Üì Updated</option>
        </select>
        <div class="view-toggle">
          <button class="view-btn active" id="vbtn-normal" onclick="setLayout('normal')" title="Card">‚äû</button>
          <button class="view-btn" id="vbtn-compact" onclick="setLayout('compact')" title="Micro Card">‚äü</button>
          <button class="view-btn" id="vbtn-list" onclick="setLayout('list')" title="List">‚ò∞</button>
          <button class="view-btn" id="vbtn-micro" onclick="setLayout('micro')" title="Micro List">‚ãÆ‚ãÆ</button>
        </div>
      </div>
    </div>
    <!-- Bulk action bar -->
    <div class="bulk-bar" id="bulk-bar">
      <span class="bulk-count" id="bulk-count">0 selected</span>
      <button class="bulk-btn" onclick="bulkSelectAll()">Select All</button>
      <button class="bulk-btn" onclick="bulkSelectNone()">None</button>
      <select id="bulk-recat-select" class="bulk-btn">
        <option value="">Move to‚Ä¶</option>
        <option value="finance">Finance & Money</option>
        <option value="health">Health & Medical</option>
        <option value="recipes">Recipes & Food</option>
        <option value="home">Home & DIY</option>
        <option value="work">Work & Career</option>
        <option value="travel">Travel</option>
        <option value="learning">Learning & Research</option>
        <option value="ideas">Ideas & Projects</option>
        <option value="notes">Personal Notes</option>
        <option value="photos">Photos & Images</option>
        <option value="music">Music</option>
      </select>
      <button class="bulk-btn danger" onclick="bulkDelete()">üóë Delete</button>
      <button class="bulk-btn" onclick="toggleBulkMode()">‚úï Cancel</button>
    </div>
    <div class="grid" id="grid"></div>
    <div class="empty" id="empty" style="display:none">
      <div class="empty-drop-zone" id="empty-drop-zone">
        <div class="empty-icon" id="empty-icon">‚óª</div>
        <div class="empty-title" id="empty-title">Stash is empty</div>
        <div class="empty-sub">Tap <strong>+ Add</strong> to create an entry, or<br/>drop files here to import them</div>
        <div class="empty-drop-hint">üìÇ Drop PDFs, images, or any file</div>
      </div>
    </div>
  </div>
</div>

<!-- ADD/EDIT MODAL -->
<div class="overlay" id="form-overlay"></div>
<div class="modal" id="form-modal">
  <div class="modal-header">
    <div class="modal-handle"></div>
    <div class="modal-title" id="form-title">New Entry</div>
  </div>
  <div class="modal-inner">
    <!-- Title spans full width -->
    <div class="form-group">
      <label>Title</label>
      <input type="text" id="f-title" placeholder="Entry title‚Ä¶" />
    </div>
    <!-- Desktop 2-col layout -->
    <div class="form-desktop-cols">
      <!-- LEFT -->
      <div class="form-col">
        <div class="form-group">
          <label>Category</label>
          <select id="f-cat">
            <option value="finance">Finance &amp; Money</option>
            <option value="health">Health &amp; Medical</option>
            <option value="recipes">Recipes &amp; Food</option>
            <option value="home">Home &amp; DIY</option>
            <option value="work">Work &amp; Career</option>
            <option value="travel">Travel</option>
            <option value="learning">Learning &amp; Research</option>
            <option value="ideas">Ideas &amp; Projects</option>
            <option value="notes">Personal Notes</option>
            <option value="photos">Photos &amp; Images</option>
            <option value="music">Music</option>
          </select>
        </div>
        <div class="form-group">
          <label>Tags (comma separated)</label>
          <input type="text" id="f-tags" placeholder="add tags‚Ä¶" />
          <div class="suggested-tags" id="suggested-tags"></div>
        </div>
        <div class="form-group">
          <label>Summary / Preview</label>
          <input type="text" id="f-summary" placeholder="Short description‚Ä¶" />
        </div>
        <div class="form-group">
          <label>Folder (optional)</label>
          <div style="display:flex;gap:8px;align-items:center;">
            <select id="f-folder" style="flex:1;"><option value="">‚Äî No folder ‚Äî</option></select>
            <span style="color:var(--text3);font-size:12px;white-space:nowrap;">or new:</span>
            <input type="text" id="f-folder-new" placeholder="Type new folder name‚Ä¶" style="flex:1;" />
          </div>
        </div>
        <div class="form-group">
          <label>Links</label>
          <div class="link-row">
            <input type="text" id="f-link-url" placeholder="https://‚Ä¶" />
            <input type="text" id="f-link-label" placeholder="Label (optional)" />
            <button class="btn-add-link" id="add-link-btn" type="button">+</button>
          </div>
          <div class="link-list" id="link-list"></div>
        </div>
      </div>
      <!-- RIGHT -->
      <div class="form-col">
        <div class="form-group" style="display:flex;flex-direction:column;flex:1;">
          <label>Content / Notes</label>
          <textarea id="f-content" placeholder="Paste your full notes, guide, recipe steps‚Ä¶" style="flex:1;height:100%;min-height:120px;"></textarea>
        </div>
        <div class="form-group">
          <label>Attachments</label>
          <div class="attach-zone" id="attach-zone" onclick="document.getElementById('attach-file-input').click()">
            üìé Tap to attach files (PDF, images, docs‚Ä¶)
          </div>
          <input type="file" id="attach-file-input" multiple style="display:none" />
          <div class="attach-list" id="attach-list"></div>
          <div class="attach-warning" id="attach-warning"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-actions" style="padding:8px 20px 12px;flex-shrink:0;">
    <button class="btn-cancel" id="form-cancel">Cancel</button>
    <button class="btn-danger" id="form-delete" style="display:none">Delete</button>
    <button class="btn-save" id="form-save">Save Entry</button>
  </div>
</div>

<!-- VIEW MODAL -->
<div class="overlay" id="view-overlay"></div>
<div class="modal" id="view-modal">
  <div class="modal-header">
    <div class="modal-handle"></div>
    <div class="view-meta">
      <span class="view-cat-badge" id="view-cat-badge"></span>
      <span class="card-date" id="view-date"></span>
    </div>
    <div class="modal-title" id="view-title"></div>
  </div>
  <div class="modal-inner">
    <div id="view-tags" class="card-tags" style="margin-bottom:16px"></div>
    <div id="view-summary" style="font-size:13px;color:var(--text2);margin-bottom:16px;font-style:italic;"></div>
    <div class="view-content" id="view-content"></div>
    <div id="view-attachments-section" style="display:none">
      <div class="view-section-title">üìé Attachments</div>
      <div id="view-attachments-list"></div>
    </div>
    <div id="view-links-section" style="display:none">
      <div class="view-section-title">üîó Links</div>
      <div id="view-links-list"></div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" id="view-close">Close</button>
      <button class="btn-danger" id="view-delete">Delete</button>
      <button class="btn-save" id="view-edit">Edit</button>
    </div>
  </div>
</div>

<!-- FILE VIEWER MODAL -->
<div class="overlay" id="viewer-overlay"></div>
<div class="modal" id="viewer-modal" style="height:88vh;">
  <div class="modal-header" style="display:flex;align-items:center;justify-content:space-between;">
    <div style="font-family:var(--mono);font-size:12px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;margin-right:12px;" id="viewer-filename"></div>
    <div id="viewer-toggle-bar">
      <button class="viewer-toggle-btn active" id="viewer-code-btn" onclick="setViewerMode('code')">‚å® Code</button>
      <button class="viewer-toggle-btn" id="viewer-preview-btn" onclick="setViewerMode('preview')">üëÅ Preview</button>
    </div>
    <button class="btn-cancel" id="viewer-close" style="flex-shrink:0;">‚úï Close</button>
  </div>
  <div class="modal-inner" style="padding:0 12px 12px;display:flex;flex-direction:column;">
    <div id="viewer-body" style="flex:1;min-height:0;border-radius:6px;background:#000;display:flex;align-items:center;justify-content:center;overflow:auto;height:100%;"></div>
  </div>
</div>

<!-- Hidden import input -->
<input type="file" id="import-files-input" multiple accept="*/*" style="display:none" />

<!-- SAME CATEGORY PROMPT MODAL -->
<div class="overlay" id="same-cat-overlay"></div>
<div class="modal" id="same-cat-modal" style="max-width:480px;">
  <div class="modal-header" style="padding-bottom:8px;">
    <div class="modal-handle"></div>
    <div class="modal-title" style="font-size:15px;">Import Files</div>
  </div>
  <div class="modal-inner" style="padding-top:4px;">
    <div id="same-cat-file-list" style="margin-bottom:16px;display:flex;flex-direction:column;gap:6px;"></div>
    <div style="font-size:14px;color:var(--text);font-weight:600;margin-bottom:6px;">Are these files all the same category?</div>
    <div style="font-size:12px;color:var(--text2);margin-bottom:20px;line-height:1.5;">If yes, you can set one category for all files. If no, you'll set each file's category individually, one at a time.</div>
    <div class="modal-actions">
      <button class="btn-cancel" id="same-cat-no">No, set individually</button>
      <button class="btn-save" id="same-cat-yes">Yes, same category</button>
    </div>
  </div>
</div>

<!-- SINGLE FILE IMPORT MODAL (one-at-a-time flow) -->
<div class="overlay" id="single-import-overlay"></div>
<div class="modal" id="single-import-modal" style="max-width:480px;">
  <div class="modal-header" style="padding-bottom:8px;">
    <div class="modal-handle"></div>
    <div class="modal-title" id="single-import-title" style="font-size:15px;">Import File 1 of 3</div>
  </div>
  <div class="modal-inner" style="padding-top:4px;">
    <div id="single-import-file-info" style="margin-bottom:14px;"></div>
    <div class="form-group">
      <label>Category</label>
      <select id="single-import-cat">
        <option value="finance">Finance &amp; Money</option>
        <option value="health">Health &amp; Medical</option>
        <option value="recipes">Recipes &amp; Food</option>
        <option value="home">Home &amp; DIY</option>
        <option value="work">Work &amp; Career</option>
        <option value="travel">Travel</option>
        <option value="learning">Learning &amp; Research</option>
        <option value="ideas">Ideas &amp; Projects</option>
        <option value="notes">Personal Notes</option>
        <option value="photos">Photos &amp; Images</option>
        <option value="music">Music</option>
      </select>
    </div>
    <div class="form-group">
      <label>Tags (optional)</label>
      <input type="text" id="single-import-tags" placeholder="e.g. finance, 2026‚Ä¶" />
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" id="single-import-cancel">Cancel All</button>
      <button class="btn-save" id="single-import-next">Next ‚Üí</button>
    </div>
  </div>
</div>

<!-- IMPORT FILES MODAL -->
<div class="overlay" id="import-files-overlay"></div>
<div class="modal" id="import-files-modal">
  <div class="modal-header">
  </div>
  <div class="modal-inner">
    <div style="font-size:13px;color:var(--text2);margin-bottom:14px;" id="import-files-desc">Choose a category for the imported files.</div>
    <div id="import-files-preview" style="margin-bottom:14px;display:flex;flex-direction:column;gap:6px;"></div>
    <!-- Multi-file mode toggle (only shown when >1 file) -->
    <div id="import-mode-wrap" style="display:none;margin-bottom:14px;">
      <label style="font-size:11px;font-family:var(--mono);letter-spacing:0.06em;text-transform:uppercase;color:var(--text3);display:block;margin-bottom:8px;">Import as</label>
      <div style="display:flex;gap:8px;">
        <button id="import-mode-separate" class="import-mode-btn active" onclick="setImportMode('separate')">üìÑ Separate entries</button>
        <button id="import-mode-combined" class="import-mode-btn" onclick="setImportMode('combined')">üì¶ One combined entry</button>
      </div>
    </div>
    <div class="form-group">
      <label>Category</label>
      <select id="import-files-cat">
        <option value="finance">Finance &amp; Money</option>
        <option value="health">Health &amp; Medical</option>
        <option value="recipes">Recipes &amp; Food</option>
        <option value="home">Home &amp; DIY</option>
        <option value="work">Work &amp; Career</option>
        <option value="travel">Travel</option>
        <option value="learning">Learning &amp; Research</option>
        <option value="ideas">Ideas &amp; Projects</option>
        <option value="notes">Personal Notes</option>
        <option value="photos">Photos &amp; Images</option>
        <option value="music">Music</option>
      </select>
    </div>
    <div class="form-group">
      <label>Tags (optional)</label>
      <input type="text" id="import-files-tags" placeholder="e.g. smoothie, recipe, 2026‚Ä¶" />
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" id="import-files-cancel">Cancel</button>
      <button class="btn-save" id="import-files-save">Import All</button>
    </div>
  </div>
</div>
<input type="file" id="import-file" accept=".json" style="display:none" />

<script>
// ============================
// INDEXEDDB SETUP
// ============================
const DB_NAME = 'offstash_db';
const DB_VERSION = 1;
const STORE = 'entries';
let db;

function openDB() {
  return new Promise((res, rej) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = e => {
      const d = e.target.result;
      if (!d.objectStoreNames.contains(STORE)) {
        const store = d.createObjectStore(STORE, { keyPath: 'id' });
        store.createIndex('cat', 'cat', { unique: false });
      }
    };
    req.onsuccess = e => { db = e.target.result; res(db); };
    req.onerror = e => rej(e.target.error);
  });
}

function dbAll() {
  return new Promise((res, rej) => {
    const tx = db.transaction(STORE, 'readonly');
    const req = tx.objectStore(STORE).getAll();
    req.onsuccess = e => res(e.target.result);
    req.onerror = e => rej(e.target.error);
  });
}

function dbPut(entry) {
  return new Promise((res, rej) => {
    const tx = db.transaction(STORE, 'readwrite');
    const req = tx.objectStore(STORE).put(entry);
    req.onsuccess = () => res();
    req.onerror = e => rej(e.target.error);
  });
}

function dbDelete(id) {
  return new Promise((res, rej) => {
    const tx = db.transaction(STORE, 'readwrite');
    const req = tx.objectStore(STORE).delete(id);
    req.onsuccess = () => res();
    req.onerror = e => rej(e.target.error);
  });
}

// ============================
// STATE
// ============================
let allEntries = [];
let activeTab = 'all';
let searchQuery = '';
let editingId = null;
let viewingId = null;
let activeSort = 'newest';
let activeLayout = 'normal';

function setLayout(layout) {
  activeLayout = layout;
  ['normal','compact','list','micro'].forEach(l => {
    document.getElementById(`vbtn-${l}`).classList.toggle('active', l === layout);
  });
  renderGrid();
}

const CAT_LABELS = {
  finance:  'Finance & Money',
  health:   'Health & Medical',
  recipes:  'Recipes & Food',
  home:     'Home & DIY',
  work:     'Work & Career',
  travel:   'Travel',
  learning: 'Learning & Research',
  ideas:    'Ideas & Projects',
  notes:    'Personal Notes',
  photos:   'Photos & Images',
  music:    'Music'
};

// ============================
// RENDER
// ============================
function getCatClass(cat) {
  const map = { finance:'cat-finance', health:'cat-health', recipes:'cat-recipes', home:'cat-home', work:'cat-work', travel:'cat-travel', learning:'cat-learning', ideas:'cat-ideas', notes:'cat-notes', photos:'cat-photos', music:'cat-music' };
  return map[cat] || 'cat-notes';
}
function getCatBadgeClass(cat) {
  const map = { finance:'cat-badge-finance', health:'cat-badge-health', recipes:'cat-badge-recipes', home:'cat-badge-home', work:'cat-badge-work', travel:'cat-badge-travel', learning:'cat-badge-learning', ideas:'cat-badge-ideas', notes:'cat-badge-notes', photos:'cat-badge-photos', music:'cat-badge-music' };
  return map[cat] || 'cat-badge-notes';
}

function filteredEntries() {
  let list = [...allEntries];
  if (activeTab !== 'all') list = list.filter(e => e.cat === activeTab);
  if (activeFolder) list = list.filter(e => e.folder === activeFolder);
  if (searchQuery) {
    const q = searchQuery.toLowerCase();
    list = list.filter(e =>
      (e.title||'').toLowerCase().includes(q) ||
      (e.content||'').toLowerCase().includes(q) ||
      (e.summary||'').toLowerCase().includes(q) ||
      (e.tags||[]).some(t => t.toLowerCase().includes(q))
    );
  }
  switch (activeSort) {
    case 'newest':  list.sort((a,b) => (b.created||0) - (a.created||0)); break;
    case 'oldest':  list.sort((a,b) => (a.created||0) - (b.created||0)); break;
    case 'az':      list.sort((a,b) => (a.title||'').localeCompare(b.title||'')); break;
    case 'za':      list.sort((a,b) => (b.title||'').localeCompare(a.title||'')); break;
    case 'cat':     list.sort((a,b) => (a.cat||'').localeCompare(b.cat||'')); break;
    case 'updated': list.sort((a,b) => (b.updated||b.created||0) - (a.updated||a.created||0)); break;
  }
  return list;
}

function formatDate(ts) {
  if (!ts) return '';
  const d = new Date(ts);
  return d.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
}

function renderGrid() {
  const entries = filteredEntries();
  const grid = document.getElementById('grid');
  const empty = document.getElementById('empty');
  const countText = document.getElementById('count-text');
  const filterText = document.getElementById('filter-text');

  grid.className = `grid layout-${activeLayout}${bulkMode ? ' bulk-mode' : ''}`;

  countText.textContent = `${allEntries.length} entr${allEntries.length===1?'y':'ies'}`;
  filterText.textContent = (searchQuery || activeTab !== 'all' || activeFolder)
    ? ` ‚Äî showing ${entries.length}`
    : '';

  // Update category counts on tab pills
  document.querySelectorAll('.tab[data-cat]').forEach(btn => {
    const cat = btn.dataset.cat;
    const n = cat === 'all' ? allEntries.length : allEntries.filter(e => e.cat === cat).length;
    const existing = btn.querySelector('.tab-count');
    if (existing) existing.remove();
    if (n > 0) {
      const badge = document.createElement('span');
      badge.className = 'tab-count';
      badge.textContent = n;
      btn.appendChild(badge);
    }
  });
  // Update desktop dropdown counts
  document.querySelectorAll('#cat-dropdown option').forEach(opt => {
    const cat = opt.value;
    const n = cat === 'all' ? allEntries.length : allEntries.filter(e => e.cat === cat).length;
    const label = cat === 'all' ? 'All Categories' : (CAT_LABELS[cat]||cat);
    opt.textContent = n > 0 ? `${label} (${n})` : label;
  });

  const showFolderCards = activeTab !== 'all' && !activeFolder && !searchQuery;
  const folders = showFolderCards ? getFoldersForCat(activeTab) : [];

  renderFolderRow();

  if (entries.length === 0 && folders.length === 0) {
    grid.innerHTML = '';
    empty.style.display = 'block';
    const isFiltered = searchQuery || activeTab !== 'all' || activeFolder;
    const iconEl = document.getElementById('empty-icon');
    const titleEl = document.getElementById('empty-title');
    const subEl = empty.querySelector('.empty-sub');
    const hintEl = empty.querySelector('.empty-drop-hint');
    const dropZone = document.getElementById('empty-drop-zone');
    if (isFiltered) {
      iconEl.textContent = 'üîç';
      titleEl.textContent = searchQuery ? `No results for "${searchQuery}"` : 'Nothing in this category yet';
      subEl.innerHTML = searchQuery
        ? `Try a different search term, or <button onclick="event.stopPropagation();document.getElementById('search').value='';searchQuery='';renderGrid();" style="background:none;border:none;color:var(--accent);cursor:pointer;padding:0;font-size:inherit;text-decoration:underline;">clear the search</button>`
        : 'Add an entry to this category or switch to another';
      hintEl.style.display = 'none';
      dropZone.style.borderStyle = 'solid';
      dropZone.style.borderColor = 'var(--border)';
    } else {
      iconEl.textContent = '‚óª';
      titleEl.textContent = 'Stash is empty';
      subEl.innerHTML = 'Tap <strong>+ Add</strong> to create an entry, or<br/>drop files here to import them';
      hintEl.style.display = '';
      dropZone.style.borderStyle = '';
      dropZone.style.borderColor = '';
    }
    return;
  }
  empty.style.display = 'none';

  const folderCards = folders.map(f => {
    const count = getEntryCountInFolder(activeTab, f);
    return `<div class="folder-card" data-folder="${esc(f)}"
      ondragover="folderCardDragOver(event,this)"
      ondragleave="folderCardDragLeave(this)"
      ondrop="folderCardDrop(event,'${esc(f)}')"
      ondblclick="openFolder('${esc(f)}')">
      <div class="folder-card-actions">
        <button class="folder-card-btn" onclick="event.stopPropagation();renameFolderAction('${activeTab}','${esc(f)}')" title="Rename">‚úè</button>
        <button class="folder-card-btn del" onclick="event.stopPropagation();deleteFolderAction('${activeTab}','${esc(f)}')" title="Delete">‚úï</button>
      </div>
      <div class="folder-card-icon">üìÅ</div>
      <div class="folder-card-name">${esc(f)}</div>
      <div class="folder-card-count">${count} entr${count===1?'y':'ies'} ‚Äî double-click to open</div>
    </div>`;
  }).join('');

  const makeCard = e => `
    <div class="card ${getCatClass(e.cat)}${selectedIds.has(e.id)?' selected':''}" data-id="${e.id}"
      draggable="${bulkMode?'false':'true'}"
      ondragstart="if(!bulkMode){draggedEntryId='${e.id}';event.dataTransfer.effectAllowed='move';this.classList.add('dragging')}"
      ondragend="draggedEntryId=null;this.classList.remove('dragging')"
      onclick="${bulkMode ? `toggleSelect('${e.id}',this)` : `openView('${e.id}')`}"
      onmouseenter="${bulkMode ? '' : `showHoverPreview(event,'${e.id}')`}"
      onmouseleave="hideHoverPreview()">
      <div class="card-check">‚úì</div>
      ${e.folder ? `<div class="card-folder-badge">üìÅ ${esc(e.folder)}</div>` : ''}
      <div class="card-cat">${CAT_LABELS[e.cat]||e.cat}</div>
      <div class="card-title">${esc(e.title||'Untitled')}</div>
      <div class="card-preview">${esc(e.summary||e.content||'No content')}</div>
      <div class="card-footer">
        <div class="card-date">${formatDate(e.created)}</div>
        <div class="card-tags">${(e.tags||[]).slice(0,3).map(t=>`<span class="tag">${esc(t)}</span>`).join('')}</div>
      </div>
    </div>`;

  grid.className = `grid layout-${activeLayout}${bulkMode ? ' bulk-mode' : ''}`;
  grid.innerHTML = folderCards + entries.map(makeCard).join('');
  updateBulkCount();
}

// ============================
// HOVER PREVIEW
// ============================
let _hoverTimer = null;
function showHoverPreview(event, id) {
  clearTimeout(_hoverTimer);
  _hoverTimer = setTimeout(() => {
    const e = allEntries.find(x => x.id === id);
    if (!e) return;
    const el = document.getElementById('hover-preview');

    // Color bar
    const colorBar = document.getElementById('hp-color-bar');
    colorBar.className = `hp-color-bar ${getCatClass(e.cat)}`;
    colorBar.style.background = 'var(--cat-color, var(--border))';

    // Cat + title + folder
    const catEl = document.getElementById('hp-cat');
    catEl.className = `hp-cat ${getCatClass(e.cat)}`;
    catEl.textContent = CAT_LABELS[e.cat] || e.cat;
    document.getElementById('hp-title').textContent = e.title || 'Untitled';
    const folderEl = document.getElementById('hp-folder');
    folderEl.textContent = e.folder ? `üìÅ ${e.folder}` : '';

    // Dates ‚Äî show both created and modified if different
    const datesEl = document.getElementById('hp-dates');
    const created = formatDate(e.created);
    const updated = e.updated && e.updated !== e.created ? formatDate(e.updated) : null;
    datesEl.innerHTML = `
      <span>üìÖ ${created}</span>
      ${updated ? `<span style="color:var(--accent);font-size:8px;">‚úè ${updated}</span>` : ''}
    `;

    // All tags (not just 3)
    const tagsEl = document.getElementById('hp-tags');
    const tags = e.tags || [];
    if (tags.length) {
      tagsEl.innerHTML = tags.map(t => `<span class="tag">${esc(t)}</span>`).join('');
      tagsEl.style.display = 'flex';
    } else {
      tagsEl.innerHTML = ''; tagsEl.style.display = 'none';
    }

    // Full content (not summary ‚Äî the actual notes field)
    const contentEl = document.getElementById('hp-content');
    const fullText = e.content || '';
    if (fullText.trim()) {
      contentEl.textContent = fullText;
      contentEl.style.display = 'block';
    } else {
      contentEl.style.display = 'none';
    }

    // Attachments with thumbnails
    const attachEl = document.getElementById('hp-attachments');
    const attachments = e.attachments || [];
    if (attachments.length) {
      const MAX_SHOW = 3;
      const shown = attachments.slice(0, MAX_SHOW);
      attachEl.innerHTML = `<div class="hp-section-label">üìé ${attachments.length} Attachment${attachments.length!==1?'s':''}</div>` +
        shown.map(a => {
          const isImg = a.type && a.type.startsWith('image/');
          const thumb = isImg
            ? `<img class="hp-attach-thumb" src="${a.data}" alt="${esc(a.name)}" />`
            : `<div class="hp-attach-icon">${fileIcon(a.type)}</div>`;
          return `<div class="hp-attach-row">
            ${thumb}
            <div class="hp-attach-info">
              <div class="hp-attach-name">${esc(a.name)}</div>
              <div class="hp-attach-size">${formatBytes(a.size||0)}</div>
            </div>
          </div>`;
        }).join('') +
        (attachments.length > MAX_SHOW ? `<div style="font-family:var(--mono);font-size:9px;color:var(--text3);padding:3px 4px;">+${attachments.length - MAX_SHOW} more</div>` : '');
      attachEl.style.display = 'flex';
    } else {
      attachEl.innerHTML = ''; attachEl.style.display = 'none';
    }

    // Links
    const linksEl = document.getElementById('hp-links');
    const links = e.links || [];
    if (links.length) {
      linksEl.innerHTML = `<div class="hp-section-label">üîó ${links.length} Link${links.length!==1?'s':''}</div>` +
        links.slice(0, 3).map(l => `
          <div class="hp-link-row">
            <span>üîó</span>
            <span style="overflow:hidden;text-overflow:ellipsis;">${esc(l.label || l.url)}</span>
          </div>`).join('') +
        (links.length > 3 ? `<div style="font-family:var(--mono);font-size:9px;color:var(--text3);padding:3px 4px;">+${links.length-3} more</div>` : '');
      linksEl.style.display = 'flex';
    } else {
      linksEl.innerHTML = ''; linksEl.style.display = 'none';
    }

    // Position tooltip
    const w = 300, pad = 16;
    let x = event.clientX + 16;
    let y = event.clientY - 20;
    if (x + w + pad > window.innerWidth) x = event.clientX - w - 16;
    if (y + 440 > window.innerHeight) y = Math.max(8, window.innerHeight - 440);
    el.style.left = x + 'px';
    el.style.top = y + 'px';
    el.classList.add('show');
  }, 350);
}
function hideHoverPreview() {
  clearTimeout(_hoverTimer);
  document.getElementById('hover-preview').classList.remove('show');
}

// ============================
// BULK SELECT
// ============================
let bulkMode = false;
let selectedIds = new Set();

function toggleBulkMode() {
  bulkMode = !bulkMode;
  selectedIds.clear();
  document.getElementById('bulk-toggle-btn').classList.toggle('active', bulkMode);
  document.getElementById('bulk-bar').classList.toggle('show', bulkMode);
  renderGrid();
}

function toggleSelect(id, cardEl) {
  if (selectedIds.has(id)) {
    selectedIds.delete(id);
    cardEl.classList.remove('selected');
  } else {
    selectedIds.add(id);
    cardEl.classList.add('selected');
  }
  updateBulkCount();
}

function bulkSelectAll() {
  filteredEntries().forEach(e => selectedIds.add(e.id));
  document.querySelectorAll('.grid .card').forEach(c => c.classList.add('selected'));
  updateBulkCount();
}

function bulkSelectNone() {
  selectedIds.clear();
  document.querySelectorAll('.grid .card').forEach(c => c.classList.remove('selected'));
  updateBulkCount();
}

function updateBulkCount() {
  const n = selectedIds.size;
  document.getElementById('bulk-count').textContent = `${n} selected`;
  const recatSel = document.getElementById('bulk-recat-select');
  recatSel.style.display = n > 0 ? 'block' : 'none';
}

async function bulkDelete() {
  if (selectedIds.size === 0) return;
  if (!confirm(`Delete ${selectedIds.size} entr${selectedIds.size===1?'y':'ies'}? This cannot be undone.`)) return;
  for (const id of selectedIds) await dbDelete(id);
  allEntries = await dbAll();
  selectedIds.clear();
  renderGrid();
  showToast(`Deleted ${selectedIds.size || '...'} entries`);
}

document.getElementById('bulk-recat-select').addEventListener('change', async function() {
  const newCat = this.value;
  if (!newCat || selectedIds.size === 0) return;
  for (const id of selectedIds) {
    const entry = allEntries.find(e => e.id === id);
    if (entry) { entry.cat = newCat; entry.updated = Date.now(); await dbPut(entry); }
  }
  allEntries = await dbAll();
  selectedIds.clear();
  this.value = '';
  renderGrid();
  showToast(`Moved to ${CAT_LABELS[newCat]||newCat}`);
});

function esc(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ============================
// MODALS
// ============================
// ============================
// SUGGESTED TAGS PER CATEGORY
// ============================
const CAT_SUGGESTED_TAGS = {
  finance:  ['budget', 'invoice', 'taxes', 'savings', 'expense', 'income', 'investment', 'debt', 'insurance', 'crypto', 'banking', 'loan', 'receipt', 'payroll', 'stocks'],
  health:   ['medication', 'appointment', 'symptoms', 'doctor', 'insurance', 'diet', 'exercise', 'mental health', 'prescription', 'allergy', 'surgery', 'lab results', 'vitals', 'therapy', 'emergency'],
  recipes:  ['breakfast', 'dinner', 'lunch', 'vegetarian', 'vegan', 'gluten-free', 'quick', 'meal prep', 'dessert', 'snack', 'baking', 'grilling', 'instant pot', 'slow cooker', 'healthy'],
  home:     ['repair', 'maintenance', 'plumbing', 'electrical', 'painting', 'cleaning', 'garden', 'HVAC', 'appliance', 'renovation', 'furniture', 'pest control', 'roof', 'flooring', 'tools'],
  work:     ['meeting', 'project', 'deadline', 'client', 'proposal', 'resume', 'interview', 'goals', 'feedback', 'contract', 'invoice', 'networking', 'training', 'performance', 'remote'],
  travel:   ['flights', 'hotel', 'itinerary', 'visa', 'packing', 'budget', 'passport', 'road trip', 'international', 'booking', 'insurance', 'tips', 'airbnb', 'car rental', 'activities'],
  learning: ['course', 'book', 'notes', 'summary', 'research', 'tutorial', 'podcast', 'article', 'certification', 'language', 'history', 'science', 'math', 'coding', 'philosophy'],
  ideas:    ['startup', 'feature', 'design', 'brainstorm', 'side project', 'app', 'business', 'creative', 'prototype', 'MVP', 'goal', 'vision', 'strategy', 'automation', 'content'],
  notes:    ['personal', 'journal', 'reminder', 'thought', 'dream', 'quote', 'reflection', 'list', 'plan', 'memory', 'mood', 'gratitude', 'weekly', 'daily', 'random'],
  photos:   ['portrait', 'landscape', 'screenshot', 'infographic', 'design', 'recipe', 'travel', 'family', 'nature', 'architecture', 'food', 'art', 'reference', 'inspiration', 'event'],
  music:    ['playlist', 'album', 'artist', 'lyrics', 'chords', 'tabs', 'theory', 'practice', 'setlist', 'gear', 'recording', 'mix', 'genre', 'concert', 'inspiration']
};

const CAT_TAG_PLACEHOLDERS = {
  finance:  'e.g. budget, taxes, savings‚Ä¶',
  health:   'e.g. doctor, medication, diet‚Ä¶',
  recipes:  'e.g. dinner, vegan, quick‚Ä¶',
  home:     'e.g. repair, plumbing, garden‚Ä¶',
  work:     'e.g. project, client, deadline‚Ä¶',
  travel:   'e.g. flights, hotel, packing‚Ä¶',
  learning: 'e.g. book, course, notes‚Ä¶',
  ideas:    'e.g. startup, app, brainstorm‚Ä¶',
  notes:    'e.g. journal, reminder, daily‚Ä¶',
  photos:   'e.g. portrait, recipe, design‚Ä¶',
  music:    'e.g. playlist, chords, album‚Ä¶'
};

function renderSuggestedTags(cat) {
  const container = document.getElementById('suggested-tags');
  if (!container) return;
  const suggestions = CAT_SUGGESTED_TAGS[cat] || [];
  // Pick 6 suggestions
  const picks = suggestions.slice(0, 8);
  const currentTags = getCurrentTags();
  container.innerHTML = picks.map(t => {
    const used = currentTags.includes(t);
    return `<button type="button" class="suggested-tag${used ? ' used' : ''}" onclick="addSuggestedTag('${t}')">${t}</button>`;
  }).join('');
  // Update input placeholder to match category
  const input = document.getElementById('f-tags');
  if (input) input.placeholder = CAT_TAG_PLACEHOLDERS[cat] || 'add tags‚Ä¶';
}

function getCurrentTags() {
  return document.getElementById('f-tags').value
    .split(',').map(t => t.trim().toLowerCase()).filter(Boolean);
}

function addSuggestedTag(tag) {
  const input = document.getElementById('f-tags');
  const current = getCurrentTags();
  if (current.includes(tag.toLowerCase())) return;
  input.value = current.length > 0 ? current.join(', ') + ', ' + tag : tag;
  renderSuggestedTags(document.getElementById('f-cat').value);
}

// Temp attachment/link state for the form
let formAttachments = []; // [{name, size, type, data(base64)}]
let formLinks = [];       // [{url, label}]

function openFormModal(entry = null, isNew = false) {
  editingId = (!isNew && entry) ? entry.id : null;
  document.getElementById('form-title').textContent = editingId ? 'Edit Entry' : 'New Entry';
  document.getElementById('f-title').value = (!isNew && entry) ? (entry.title || '') : '';
  const cat = entry?.cat || (activeTab !== 'all' ? activeTab : 'notes');
  document.getElementById('f-cat').value = cat;
  document.getElementById('f-tags').value = (!isNew && entry) ? (entry?.tags||[]).join(', ') : '';
  renderSuggestedTags(cat);
  document.getElementById('f-summary').value = (!isNew && entry) ? (entry?.summary || '') : '';
  document.getElementById('f-content').value = (!isNew && entry) ? (entry?.content || '') : '';
  // Load folder select
  const entryFolder = entry?.folder || (isNew && activeFolder ? activeFolder : '');
  populateFolderSelect(entryFolder);
  document.getElementById('form-delete').style.display = entry ? 'block' : 'none';

  // Load existing attachments & links
  formAttachments = entry?.attachments ? JSON.parse(JSON.stringify(entry.attachments)) : [];
  formLinks = entry?.links ? JSON.parse(JSON.stringify(entry.links)) : [];
  renderFormAttachments();
  renderFormLinks();

  document.getElementById('f-link-url').value = '';
  document.getElementById('f-link-label').value = '';
  document.getElementById('attach-warning').textContent = '';

  document.getElementById('form-overlay').classList.add('show');
  document.getElementById('form-modal').classList.add('show');
  document.body.style.overflow = 'hidden';
  setTimeout(() => document.getElementById('f-title').focus(), 100);
}

function formatBytes(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024*1024) return (bytes/1024).toFixed(1) + ' KB';
  return (bytes/(1024*1024)).toFixed(1) + ' MB';
}

// ‚îÄ‚îÄ HTML viewer toggle state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _viewerHtmlSource = null; // stores decoded HTML string when viewing an HTML file

function _setImageViewMode(mode) {
  const img = document.getElementById('viewer-img');
  const body = document.getElementById('viewer-body');
  const codeBtn = document.getElementById('viewer-code-btn');
  const previewBtn = document.getElementById('viewer-preview-btn');
  if (!img) return;
  if (mode === 'fill') {
    img.style.cssText = 'width:100%;height:100%;object-fit:contain;border-radius:4px;display:block;transition:all 0.2s;cursor:zoom-out;image-rendering:auto;';
    body.style.cursor = 'zoom-out';
    codeBtn.classList.remove('active');
    previewBtn.classList.add('active');
  } else {
    img.style.cssText = 'max-width:100%;max-height:100%;width:auto;height:auto;object-fit:contain;border-radius:4px;display:block;transition:all 0.2s;cursor:zoom-in;';
    body.style.cursor = 'zoom-in';
    codeBtn.classList.add('active');
    previewBtn.classList.remove('active');
  }
}

function setViewerMode(mode) {
  // Image fit/fill toggle
  if (document.getElementById('viewer-img')) {
    _setImageViewMode(mode === 'code' ? 'fit' : 'fill');
    return;
  }
  if (!_viewerHtmlSource) return;
  const body = document.getElementById('viewer-body');
  const codeBtn = document.getElementById('viewer-code-btn');
  const previewBtn = document.getElementById('viewer-preview-btn');
  body.innerHTML = '';
  if (mode === 'preview') {
    codeBtn.classList.remove('active');
    previewBtn.classList.add('active');
    const iframe = document.createElement('iframe');
    iframe.style.cssText = 'width:100%;height:100%;border:none;border-radius:4px;background:#fff;';
    iframe.title = 'HTML Preview';
    body.style.background = '#fff';
    body.appendChild(iframe);
    // Write HTML into sandboxed iframe
    iframe.contentDocument.open();
    iframe.contentDocument.write(_viewerHtmlSource);
    iframe.contentDocument.close();
  } else {
    codeBtn.classList.add('active');
    previewBtn.classList.remove('active');
    const pre = document.createElement('div');
    pre.className = 'viewer-text';
    pre.textContent = _viewerHtmlSource;
    body.style.background = 'var(--bg3)';
    body.appendChild(pre);
  }
}

function previewAttachment(encodedData, type, name) {
  const data = decodeURIComponent(encodedData);
  _showViewer(data, type, name);
}

function previewAttachmentByIndex(i) {
  const entry = allEntries.find(x => x.id === viewingId);
  if (!entry) return;
  const a = entry.attachments[i];
  if (!a) return;
  _showViewer(a.data, a.type, a.name);
}

function saveAttachmentByIndex(i) {
  const entry = allEntries.find(x => x.id === viewingId);
  if (!entry) return;
  const a = entry.attachments[i];
  if (!a) return;
  saveAttachment(encodeURIComponent(a.data), a.name);
}

function _showViewer(data, type, name) {
  const body = document.getElementById('viewer-body');
  document.getElementById('viewer-filename').textContent = name || 'File';
  body.innerHTML = '';
  _viewerHtmlSource = null;

  // Revoke any previous blob URLs
  body.querySelectorAll('[data-blob-url]').forEach(el => URL.revokeObjectURL(el.dataset.blobUrl));

  const toggleBar = document.getElementById('viewer-toggle-bar');
  const isHtml = type === 'text/html' || (name && name.toLowerCase().endsWith('.html'));
  toggleBar.classList.toggle('show', isHtml);
  document.getElementById('viewer-code-btn').classList.add('active');
  document.getElementById('viewer-preview-btn').classList.remove('active');

  // Helper: base64 data URI ‚Üí Blob URL
  // Helper: data URI ‚Üí Blob URL using fetch (async, handles large files safely)
  async function toBlobUrl(dataUri) {
    const res = await fetch(dataUri);
    const blob = await res.blob();
    return URL.createObjectURL(blob);
  }

  if (type.startsWith('image/')) {
    body.style.background = '#000';
    body.style.cursor = 'zoom-in';
    // Show image fit/fill toggle in header
    const toggleBar = document.getElementById('viewer-toggle-bar');
    toggleBar.classList.add('show');
    document.getElementById('viewer-code-btn').textContent = '‚ä° Fit';
    document.getElementById('viewer-code-btn').classList.add('active');
    document.getElementById('viewer-preview-btn').textContent = '‚õ∂ Fill';
    document.getElementById('viewer-preview-btn').classList.remove('active');
    const img = document.createElement('img');
    img.src = data;
    img.alt = name || 'Image';
    img.id = 'viewer-img';
    img.style.cssText = 'max-width:100%;max-height:100%;width:auto;height:auto;object-fit:contain;border-radius:4px;display:block;transition:all 0.2s;';
    img.onclick = () => {
      const isFill = img.style.width === '100%';
      _setImageViewMode(isFill ? 'fit' : 'fill');
    };
    body.appendChild(img);

  } else if (type === 'application/pdf') {
    body.style.background = 'var(--bg3)';
    const wrapper = document.createElement('div');
    wrapper.style.cssText = 'width:100%;height:100%;overflow-y:auto;overflow-x:hidden;display:flex;flex-direction:column;align-items:center;gap:8px;padding:12px 0;box-sizing:border-box;';
    body.appendChild(wrapper);
    const loadPdfJs = () => new Promise((resolve, reject) => {
      if (window.pdfjsLib) { resolve(window.pdfjsLib); return; }
      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
      script.onload = () => { window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js'; resolve(window.pdfjsLib); };
      script.onerror = reject;
      document.head.appendChild(script);
    });
    const b64 = data.split(',')[1];
    const raw = atob(b64);
    const byteArr = new Uint8Array(raw.length);
    for (let i = 0; i < raw.length; i++) byteArr[i] = raw.charCodeAt(i);
    const loadingMsg = document.createElement('div');
    loadingMsg.style.cssText = 'color:var(--text3);font-family:var(--mono);font-size:12px;padding:40px;';
    loadingMsg.textContent = 'Loading PDF‚Ä¶';
    wrapper.appendChild(loadingMsg);
    loadPdfJs().then(pdfjsLib => pdfjsLib.getDocument({ data: byteArr }).promise).then(async pdf => {
      wrapper.innerHTML = '';
      const info = document.createElement('div');
      info.style.cssText = 'font-family:var(--mono);font-size:10px;color:var(--text3);letter-spacing:0.06em;margin-bottom:4px;';
      info.textContent = `${pdf.numPages} page${pdf.numPages !== 1 ? 's' : ''}`;
      wrapper.appendChild(info);
      for (let p = 1; p <= pdf.numPages; p++) {
        const page = await pdf.getPage(p);
        const scale = Math.min((body.clientWidth - 32) / page.getViewport({ scale: 1 }).width, 2);
        const viewport = page.getViewport({ scale });
        const canvas = document.createElement('canvas');
        canvas.width = viewport.width; canvas.height = viewport.height;
        canvas.style.cssText = 'border-radius:4px;box-shadow:0 2px 12px rgba(0,0,0,0.5);max-width:100%;';
        wrapper.appendChild(canvas);
        await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
      }
    }).catch(err => {
      wrapper.innerHTML = `<div style="color:#ff6b35;font-family:var(--mono);font-size:12px;padding:40px;text-align:center;">Failed to render PDF.<br/><span style="color:var(--text3);font-size:10px;">${err.message}</span></div>`;
    });

  } else if (type.startsWith('text/') || type === 'application/json') {
    const b64 = data.split(',')[1];
    const decoded = decodeURIComponent(escape(atob(b64)));
    if (isHtml) {
      _viewerHtmlSource = decoded;
      const pre = document.createElement('div');
      pre.className = 'viewer-text';
      pre.textContent = decoded;
      body.style.background = 'var(--bg3)';
      body.appendChild(pre);
    } else {
      const pre = document.createElement('div');
      pre.className = 'viewer-text';
      pre.textContent = decoded;
      body.style.background = 'var(--bg3)';
      body.appendChild(pre);
    }

  } else if (type.startsWith('video/')) {
    body.style.background = '#000';
    const video = document.createElement('video');
    video.src = data;
    video.controls = true;
    video.style.cssText = 'max-width:100%;max-height:100%;border-radius:4px;';
    body.appendChild(video);

  } else if (type.startsWith('audio/')) {
    body.style.background = 'var(--bg2)';
    const wrap = document.createElement('div');
    wrap.style.cssText = 'display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;width:100%;gap:24px;padding:32px;box-sizing:border-box;';
    const icon = document.createElement('div');
    icon.textContent = 'üéµ';
    icon.style.cssText = 'font-size:64px;line-height:1;';
    const trackName = document.createElement('div');
    trackName.textContent = name || 'Audio File';
    trackName.style.cssText = 'font-family:var(--sans);font-size:16px;font-weight:600;color:var(--text);text-align:center;max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;';
    const audio = document.createElement('audio');
    audio.src = data;
    audio.controls = true;
    audio.style.cssText = 'width:100%;max-width:500px;';
    wrap.appendChild(icon);
    wrap.appendChild(trackName);
    wrap.appendChild(audio);
    body.appendChild(wrap);

  } else {
    body.innerHTML = `<div class="viewer-unsupported">
      <span class="big">${fileIcon(type)}</span>
      This file type can't be previewed inline.<br/>Use ‚¨á Save to download it.
    </div>`;
  }

  document.getElementById('viewer-overlay').classList.add('show');
  document.getElementById('viewer-modal').classList.add('show');
}

function saveAttachment(encodedData, name) {
  const data = decodeURIComponent(encodedData);
  const byteString = atob(data.split(',')[1]);
  const mimeMatch = data.match(/^data:([^;]+);/);
  const mime = mimeMatch ? mimeMatch[1] : 'application/octet-stream';
  const ab = new ArrayBuffer(byteString.length);
  const ia = new Uint8Array(ab);
  for (let i = 0; i < byteString.length; i++) ia[i] = byteString.charCodeAt(i);
  const blob = new Blob([ab], { type: mime });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = name;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(url), 5000);
}


function canPreview(type) {
  if (!type) return false;
  // These types browsers can display natively in a new tab
  return type.startsWith('image/') ||
         type === 'application/pdf' ||
         type.startsWith('text/') ||
         type === 'application/json' ||
         type.startsWith('video/') ||
         type.startsWith('audio/');
}

function fileIcon(type) {
  if (!type) return 'üìÑ';
  if (type.startsWith('image/')) return 'üñºÔ∏è';
  if (type === 'application/pdf') return 'üìï';
  if (type.includes('word')) return 'üìù';
  if (type.includes('sheet') || type.includes('excel') || type.includes('csv')) return 'üìä';
  if (type.startsWith('video/')) return 'üé¨';
  if (type.startsWith('audio/')) return 'üéµ';
  return 'üìÑ';
}

function renderFormAttachments() {
  const list = document.getElementById('attach-list');
  list.innerHTML = formAttachments.map((a, i) => `
    <div class="attach-item">
      <span class="attach-icon">${fileIcon(a.type)}</span>
      <span class="attach-name" title="${esc(a.name)}">${esc(a.name)}</span>
      <span class="attach-size">${formatBytes(a.size)}</span>
      <button class="attach-remove" onclick="removeAttachment(${i})">‚úï</button>
    </div>
  `).join('');
}

function removeAttachment(i) {
  formAttachments.splice(i, 1);
  renderFormAttachments();
}

function renderFormLinks() {
  const list = document.getElementById('link-list');
  list.innerHTML = formLinks.map((l, i) => `
    <div class="attach-item">
      <span class="attach-icon">üîó</span>
      <span class="attach-name" title="${esc(l.url)}">${esc(l.label || l.url)}</span>
      <button class="attach-remove" onclick="removeLink(${i})">‚úï</button>
    </div>
  `).join('');
}

function removeLink(i) {
  formLinks.splice(i, 1);
  renderFormLinks();
}

function closeFormModal() {
  document.getElementById('form-overlay').classList.remove('show');
  document.getElementById('form-modal').classList.remove('show');
  document.body.style.overflow = '';
  editingId = null;
  formAttachments = [];
  formLinks = [];
  // Clear folder inputs
  const fn = document.getElementById('f-folder-new');
  if (fn) fn.value = '';
  const fs = document.getElementById('f-folder');
  if (fs) fs.value = '';
}

function openView(id) {
  const e = allEntries.find(x => x.id === id);
  if (!e) return;
  viewingId = id;
  document.getElementById('view-title').textContent = e.title || 'Untitled';
  document.getElementById('view-cat-badge').textContent = CAT_LABELS[e.cat]||e.cat;
  document.getElementById('view-cat-badge').className = `view-cat-badge ${getCatBadgeClass(e.cat)}`;
  document.getElementById('view-date').textContent = formatDate(e.created);
  document.getElementById('view-tags').innerHTML = (e.tags||[]).map(t=>`<span class="tag">${esc(t)}</span>`).join('');
  document.getElementById('view-summary').textContent = e.summary || '';
  document.getElementById('view-content').textContent = e.content || '';

  // Attachments
  const attachments = e.attachments || [];
  const attachSection = document.getElementById('view-attachments-section');
  const attachList = document.getElementById('view-attachments-list');
  if (attachments.length > 0) {
    attachSection.style.display = 'block';
    attachList.innerHTML = attachments.map((a, i) => {
      return `<div class="view-attach-item">
        <span style="font-size:18px">${fileIcon(a.type)}</span>
        <span style="flex:1;font-size:12px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(a.name)}">${esc(a.name)}</span>
        <span style="font-family:var(--mono);font-size:10px;color:var(--text3);margin-right:8px">${formatBytes(a.size)}</span>
        <div class="attach-actions">
          <button class="view-attach-btn view-btn" onclick="previewAttachmentByIndex(${i})">üëÅ View</button>
          <button class="view-attach-btn" onclick="saveAttachmentByIndex(${i})">‚¨á Save</button>
        </div>
      </div>`;
    }).join('');
  } else {
    attachSection.style.display = 'none';
  }

  // Links
  const links = e.links || [];
  const linksSection = document.getElementById('view-links-section');
  const linksList = document.getElementById('view-links-list');
  if (links.length > 0) {
    linksSection.style.display = 'block';
    linksList.innerHTML = links.map(l => `
      <div class="view-attach-item">
        <span style="font-size:18px">üîó</span>
        <a class="link-anchor" href="${esc(l.url)}" target="_blank" rel="noopener noreferrer">
          ${l.label ? `<span class="link-label-text">${esc(l.label)} ‚Äî</span>` : ''}${esc(l.url)}
        </a>
      </div>
    `).join('');
  } else {
    linksSection.style.display = 'none';
  }

  document.getElementById('view-overlay').classList.add('show');
  document.getElementById('view-modal').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeView() {
  document.getElementById('view-overlay').classList.remove('show');
  document.getElementById('view-modal').classList.remove('show');
  document.body.style.overflow = '';
  viewingId = null;
}

// ============================
// SAVE / DELETE
// ============================
async function saveEntry() {
  const title = document.getElementById('f-title').value.trim();
  if (!title) { showToast('Title is required'); return; }

  const tags = document.getElementById('f-tags').value
    .split(',').map(t => t.trim()).filter(Boolean);

  // Determine folder
  const folderSelect = document.getElementById('f-folder').value;
  const folderNew = document.getElementById('f-folder-new').value.trim();
  const cat = document.getElementById('f-cat').value;
  let folder = folderNew || folderSelect || null;
  if (folderNew) createFolder(cat, folderNew);

  const entry = {
    id: editingId || crypto.randomUUID(),
    title,
    cat,
    tags,
    folder: folder || null,
    summary: document.getElementById('f-summary').value.trim(),
    content: document.getElementById('f-content').value.trim(),
    attachments: formAttachments,
    links: formLinks,
    created: editingId
      ? allEntries.find(e=>e.id===editingId)?.created || Date.now()
      : Date.now(),
    updated: Date.now()
  };

  await dbPut(entry);
  allEntries = await dbAll();
  renderGrid();
  closeFormModal();
  showToast(editingId ? 'Entry updated' : 'Entry saved');
}

async function deleteEntry(btn) {
  if (!editingId) return;
  if (btn.dataset.confirming !== 'true') {
    btn.dataset.confirming = 'true';
    btn.textContent = 'Tap again to confirm';
    btn.style.background = '#ff4444';
    btn.style.color = '#fff';
    setTimeout(() => {
      btn.dataset.confirming = 'false';
      btn.textContent = 'Delete';
      btn.style.background = '';
      btn.style.color = '';
    }, 3000);
    return;
  }
  await dbDelete(editingId);
  allEntries = await dbAll();
  renderGrid();
  closeFormModal();
  showToast('Entry deleted');
}

// ============================
// EXPORT / IMPORT
// ============================
function exportJSON() {
  const blob = new Blob([JSON.stringify(allEntries, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `offstash-backup-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showToast(`Exported ${allEntries.length} entries`);
}

async function importJSON(file) {
  try {
    const text = await file.text();
    const data = JSON.parse(text);
    if (!Array.isArray(data)) throw new Error('Invalid format');
    for (const entry of data) {
      if (entry.id && entry.title) await dbPut(entry);
    }
    allEntries = await dbAll();
    renderGrid();
    showToast(`Imported ${data.length} entries`);
  } catch (err) {
    showToast('Import failed: ' + err.message);
  }
}

// ============================
// TOAST
// ============================
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2500);
}

// ============================
// OFFLINE DETECTION
// ============================
function updateOnlineStatus() {
  const banner = document.getElementById('offline-banner');
  if (navigator.onLine) {
    banner.classList.remove('show');
    console.log('[OffStash] Reconnected ‚Äî sync later');
  } else {
    banner.classList.add('show');
  }
}
window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);

// ============================
// EVENT LISTENERS
// ============================
// add-btn now handled by add-menu

document.getElementById('form-save').addEventListener('click', saveEntry);
document.getElementById('form-cancel').addEventListener('click', closeFormModal);
document.getElementById('form-delete').addEventListener('click', (e) => deleteEntry(e.target));

document.getElementById('view-close').addEventListener('click', closeView);
document.getElementById('view-edit').addEventListener('click', () => {
  const e = allEntries.find(x => x.id === viewingId);
  closeView();
  if (e) openFormModal(e);
});
document.getElementById('view-delete').addEventListener('click', async (e) => {
  if (!viewingId) return;
  const btn = e.target;
  if (btn.dataset.confirming !== 'true') {
    btn.dataset.confirming = 'true';
    btn.textContent = 'Tap again to confirm';
    btn.style.background = '#ff4444';
    btn.style.color = '#fff';
    setTimeout(() => {
      btn.dataset.confirming = 'false';
      btn.textContent = 'Delete';
      btn.style.background = '';
      btn.style.color = '';
    }, 3000);
    return;
  }
  const idToDelete = viewingId;
  closeView();
  await dbDelete(idToDelete);
  allEntries = await dbAll();
  renderGrid();
  showToast('Entry deleted');
});

document.getElementById('export-btn').addEventListener('click', exportJSON);

// ============================
// IMPORT FILES
// ============================
let pendingImportFiles = [];
let importMode = 'separate'; // 'separate' or 'combined'

// ‚îÄ‚îÄ One-at-a-time flow state ‚îÄ‚îÄ
let _oneAtATime = [];
let _oneAtATimeIndex = 0;

function setImportMode(mode) {
  importMode = mode;
  document.getElementById('import-mode-separate').classList.toggle('active', mode === 'separate');
  document.getElementById('import-mode-combined').classList.toggle('active', mode === 'combined');
  document.getElementById('import-files-desc').textContent = mode === 'separate'
    ? 'Each file will become its own entry.'
    : 'All files will be attachments in one combined entry.';
}

function openImportFilesModal(files) {
  pendingImportFiles = Array.from(files);
  if (pendingImportFiles.length === 0) return;

  if (pendingImportFiles.length > 1) {
    // Show same-category prompt first
    _showSameCatPrompt();
    return;
  }

  // Single file ‚Äî go straight to import modal
  _openBatchImportModal();
}

// ‚îÄ‚îÄ Same-category prompt ‚îÄ‚îÄ
function _showSameCatPrompt() {
  const list = document.getElementById('same-cat-file-list');
  list.innerHTML = pendingImportFiles.map(f => `
    <div class="attach-item">
      <span class="attach-icon">${fileIcon(f.type)}</span>
      <span class="attach-name">${esc(f.name)}</span>
      <span class="attach-size">${formatBytes(f.size)}</span>
    </div>`).join('');
  document.getElementById('same-cat-overlay').classList.add('show');
  document.getElementById('same-cat-modal').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function _closeSameCatPrompt() {
  document.getElementById('same-cat-overlay').classList.remove('show');
  document.getElementById('same-cat-modal').classList.remove('show');
}

document.getElementById('same-cat-yes').addEventListener('click', () => {
  _closeSameCatPrompt();
  _openBatchImportModal();
});

document.getElementById('same-cat-no').addEventListener('click', () => {
  _closeSameCatPrompt();
  _startOneAtATime();
});

document.getElementById('same-cat-overlay').addEventListener('click', () => {
  _closeSameCatPrompt();
  pendingImportFiles = [];
  document.body.style.overflow = '';
});

// ‚îÄ‚îÄ Batch import modal (same category for all) ‚îÄ‚îÄ
function _openBatchImportModal() {
  const modeWrap = document.getElementById('import-mode-wrap');
  if (pendingImportFiles.length > 1) {
    modeWrap.style.display = 'block';
    setImportMode('separate');
  } else {
    modeWrap.style.display = 'none';
    importMode = 'separate';
    document.getElementById('import-files-desc').textContent = 'The file will be imported as a new entry.';
  }
  const preview = document.getElementById('import-files-preview');
  preview.innerHTML = pendingImportFiles.map(f => `
    <div class="attach-item">
      <span class="attach-icon">${fileIcon(f.type)}</span>
      <span class="attach-name">${esc(f.name)}</span>
      <span class="attach-size">${formatBytes(f.size)}</span>
    </div>`).join('');
  document.getElementById('import-files-tags').value = '';
  document.getElementById('import-files-overlay').classList.add('show');
  document.getElementById('import-files-modal').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeImportFilesModal() {
  document.getElementById('import-files-overlay').classList.remove('show');
  document.getElementById('import-files-modal').classList.remove('show');
  document.body.style.overflow = '';
  pendingImportFiles = [];
}

async function doImportFiles() {
  const cat = document.getElementById('import-files-cat').value;
  const tags = document.getElementById('import-files-tags').value
    .split(',').map(t => t.trim()).filter(Boolean);

  const loaded = [];
  for (const file of pendingImportFiles) {
    if (file.size > 10 * 1024 * 1024) { showToast(`Skipped ${file.name} ‚Äî over 10MB`); continue; }
    const data = await new Promise((res, rej) => {
      const reader = new FileReader();
      reader.onload = () => res(reader.result);
      reader.onerror = rej;
      reader.readAsDataURL(file);
    });
    loaded.push({ file, data });
  }

  if (loaded.length === 0) { closeImportFilesModal(); return; }

  if (importMode === 'combined') {
    const title = loaded.length === 1
      ? loaded[0].file.name.replace(/\.[^.]+$/, '')
      : `${loaded.length} files`;
    const entry = {
      id: crypto.randomUUID(),
      title, cat, tags,
      summary: loaded.map(l => l.file.name).join(', '),
      content: '',
      attachments: loaded.map(l => ({ name: l.file.name, size: l.file.size, type: l.file.type, data: l.data })),
      links: [],
      created: Date.now(),
      updated: Date.now()
    };
    await dbPut(entry);
    allEntries = await dbAll();
    renderGrid();
    closeImportFilesModal();
    showToast(`Imported ${loaded.length} file${loaded.length !== 1 ? 's' : ''} into one entry`);
  } else {
    for (const { file, data } of loaded) {
      const entry = {
        id: crypto.randomUUID(),
        title: file.name.replace(/\.[^.]+$/, ''),
        cat, tags,
        summary: `Imported file: ${file.name}`,
        content: '',
        attachments: [{ name: file.name, size: file.size, type: file.type, data }],
        links: [],
        created: Date.now(),
        updated: Date.now()
      };
      await dbPut(entry);
    }
    allEntries = await dbAll();
    renderGrid();
    closeImportFilesModal();
    showToast(`Imported ${loaded.length} file${loaded.length !== 1 ? 's' : ''} as separate entries`);
  }
}

// ‚îÄ‚îÄ One-at-a-time flow ‚îÄ‚îÄ
function _startOneAtATime() {
  _oneAtATime = Array.from(pendingImportFiles);
  _oneAtATimeIndex = 0;
  _showOneAtATime();
}

function _showOneAtATime() {
  const file = _oneAtATime[_oneAtATimeIndex];
  const total = _oneAtATime.length;
  const num = _oneAtATimeIndex + 1;

  document.getElementById('single-import-title').textContent = `Import File ${num} of ${total}`;
  document.getElementById('single-import-file-info').innerHTML = `
    <div class="attach-item">
      <span class="attach-icon">${fileIcon(file.type)}</span>
      <span class="attach-name">${esc(file.name)}</span>
      <span class="attach-size">${formatBytes(file.size)}</span>
    </div>`;

  // Smart-guess category
  const sel = document.getElementById('single-import-cat');
  if (file.type.startsWith('audio/')) sel.value = 'music';
  else if (file.type.startsWith('image/')) sel.value = 'photos';
  else if (file.type === 'application/pdf') sel.value = 'notes';
  else if (file.type.startsWith('video/')) sel.value = 'ideas';
  else sel.value = 'notes';

  document.getElementById('single-import-tags').value = '';
  document.getElementById('single-import-next').textContent = num === total ? '‚úì Finish' : `Next ‚Üí`;

  document.getElementById('single-import-overlay').classList.add('show');
  document.getElementById('single-import-modal').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function _closeOneAtATime() {
  document.getElementById('single-import-overlay').classList.remove('show');
  document.getElementById('single-import-modal').classList.remove('show');
  document.body.style.overflow = '';
  _oneAtATime = [];
  _oneAtATimeIndex = 0;
  pendingImportFiles = [];
}

document.getElementById('single-import-next').addEventListener('click', async () => {
  const file = _oneAtATime[_oneAtATimeIndex];
  const cat = document.getElementById('single-import-cat').value;
  const tags = document.getElementById('single-import-tags').value
    .split(',').map(t => t.trim()).filter(Boolean);

  if (file.size > 10 * 1024 * 1024) {
    showToast(`Skipped ${file.name} ‚Äî over 10MB`);
  } else {
    const data = await new Promise((res, rej) => {
      const reader = new FileReader();
      reader.onload = () => res(reader.result);
      reader.onerror = rej;
      reader.readAsDataURL(file);
    });
    const entry = {
      id: crypto.randomUUID(),
      title: file.name.replace(/\.[^.]+$/, ''),
      cat, tags,
      summary: `Imported file: ${file.name}`,
      content: '',
      attachments: [{ name: file.name, size: file.size, type: file.type, data }],
      links: [],
      created: Date.now(),
      updated: Date.now()
    };
    await dbPut(entry);
  }

  _oneAtATimeIndex++;
  if (_oneAtATimeIndex >= _oneAtATime.length) {
    allEntries = await dbAll();
    renderGrid();
    _closeOneAtATime();
    showToast(`Imported ${_oneAtATime.length} file${_oneAtATime.length !== 1 ? 's' : ''}`);
  } else {
    _showOneAtATime();
  }
});

document.getElementById('single-import-cancel').addEventListener('click', () => {
  _closeOneAtATime();
  showToast('Import cancelled');
});

document.getElementById('single-import-overlay').addEventListener('click', () => {
  _closeOneAtATime();
});



document.getElementById('import-files-btn').addEventListener('click', () => {
  document.getElementById('import-files-input').click();
});
document.getElementById('import-files-input').addEventListener('change', e => {
  if (e.target.files.length > 0) openImportFilesModal(e.target.files);
  e.target.value = '';
});
document.getElementById('import-files-cancel').addEventListener('click', closeImportFilesModal);
document.getElementById('import-files-overlay').addEventListener('click', closeImportFilesModal);
document.getElementById('import-files-save').addEventListener('click', doImportFiles);

// ============================
// DRAG & DROP ON EMPTY STATE
// ============================
const emptyZone = document.getElementById('empty-drop-zone');

emptyZone.addEventListener('click', (e) => {
  // Don't trigger if clicking a link inside the empty state (e.g. "clear the search")
  if (e.target.tagName === 'A') return;
  // Only open file picker when stash is truly empty, not when filtered/searched
  if (searchQuery || activeTab !== 'all' || activeFolder) return;
  document.getElementById('import-files-input').click();
});

['dragenter','dragover'].forEach(ev => {
  emptyZone.addEventListener(ev, e => {
    e.preventDefault();
    emptyZone.classList.add('drag-over');
  });
});
['dragleave','dragend'].forEach(ev => {
  emptyZone.addEventListener(ev, () => emptyZone.classList.remove('drag-over'));
});
emptyZone.addEventListener('drop', e => {
  e.preventDefault();
  emptyZone.classList.remove('drag-over');
  const files = e.dataTransfer.files;
  if (files.length > 0) openImportFilesModal(files);
});

// Also allow drag-drop anywhere on the main content area when entries exist
const contentArea = document.getElementById('grid');
let dragCounter = 0;

document.addEventListener('dragenter', e => {
  if (e.dataTransfer.types.includes('Files')) {
    dragCounter++;
    document.getElementById('drop-overlay-hint').style.display = 'flex';
  }
});
document.addEventListener('dragleave', () => {
  dragCounter--;
  if (dragCounter <= 0) {
    dragCounter = 0;
    document.getElementById('drop-overlay-hint').style.display = 'none';
  }
});
document.addEventListener('dragover', e => e.preventDefault());
document.addEventListener('drop', e => {
  e.preventDefault();
  dragCounter = 0;
  document.getElementById('drop-overlay-hint').style.display = 'none';
  const files = e.dataTransfer.files;
  if (files.length > 0) openImportFilesModal(files);
});
document.getElementById('import-btn').addEventListener('click', () => {
  document.getElementById('import-file').click();
});
document.getElementById('import-file').addEventListener('change', e => {
  if (e.target.files[0]) importJSON(e.target.files[0]);
  e.target.value = '';
});

document.getElementById('search').addEventListener('input', e => {
  searchQuery = e.target.value.trim();
  renderGrid();
});

function updateSearchPlaceholder() {
  const input = document.getElementById('search');
  if (activeTab === 'all') {
    input.placeholder = 'Search all categories‚Ä¶';
  } else {
    input.placeholder = `Search in ${CAT_LABELS[activeTab] || activeTab}‚Ä¶`;
  }
}

// Mobile pill tabs
document.getElementById('tabs').addEventListener('click', e => {
  const btn = e.target.closest('.tab');
  if (!btn) return;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  activeTab = btn.dataset.cat;
  activeFolder = null;
  const dd = document.getElementById('cat-dropdown');
  if (dd) dd.value = activeTab;
  updateSearchPlaceholder();
  renderGrid();
});

// Desktop dropdown
document.getElementById('cat-dropdown').addEventListener('change', e => {
  activeTab = e.target.value;
  activeFolder = null;
  document.querySelectorAll('.tab').forEach(t => {
    t.classList.toggle('active', t.dataset.cat === activeTab);
  });
  updateSearchPlaceholder();
  renderGrid();
});

// Viewer close
function closeViewer() {
  document.getElementById('viewer-overlay').classList.remove('show');
  document.getElementById('viewer-modal').classList.remove('show');
  document.getElementById('viewer-toggle-bar').classList.remove('show');
  // Reset toggle button labels back to HTML defaults
  document.getElementById('viewer-code-btn').textContent = '‚å® Code';
  document.getElementById('viewer-preview-btn').textContent = 'üëÅ Preview';
  _viewerHtmlSource = null;
  const body = document.getElementById('viewer-body');
  body.querySelectorAll('[data-blob-url]').forEach(el => URL.revokeObjectURL(el.dataset.blobUrl));
  body.innerHTML = '';
  body.style.background = '#000';
  body.style.cursor = '';
}
document.getElementById('viewer-close').addEventListener('click', closeViewer);
document.getElementById('viewer-overlay').addEventListener('click', closeViewer);

// Close overlays on backdrop click
document.getElementById('form-overlay').addEventListener('click', () => closeFormModal());
document.getElementById('view-overlay').addEventListener('click', () => closeView());

// Keyboard shortcuts
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') { closeFormModal(); closeView(); }
});

// ============================
// ATTACHMENTS & LINKS HANDLERS
// ============================
// Update suggested tags + folder select when category changes
document.getElementById('f-cat').addEventListener('change', (e) => {
  renderSuggestedTags(e.target.value);
  populateFolderSelect('');
});

// Re-render suggestions when tags input is manually edited
document.getElementById('f-tags').addEventListener('input', () => {
  renderSuggestedTags(document.getElementById('f-cat').value);
});

document.getElementById('attach-file-input').addEventListener('change', async (e) => {
  const files = Array.from(e.target.files);
  const warn = document.getElementById('attach-warning');
  warn.textContent = '';
  for (const file of files) {
    if (file.size > 10 * 1024 * 1024) {
      warn.textContent = `‚ö† "${file.name}" is over 10MB and was skipped.`;
      continue;
    }
    if (file.size > 5 * 1024 * 1024) {
      warn.textContent = `‚ö† Large file (${formatBytes(file.size)}) ‚Äî export JSON may be slow.`;
    }
    const data = await new Promise((res, rej) => {
      const reader = new FileReader();
      reader.onload = () => res(reader.result);
      reader.onerror = rej;
      reader.readAsDataURL(file);
    });
    formAttachments.push({ name: file.name, size: file.size, type: file.type, data });
  }
  renderFormAttachments();
  e.target.value = '';
});

document.getElementById('add-link-btn').addEventListener('click', () => {
  const url = document.getElementById('f-link-url').value.trim();
  if (!url) { showToast('Enter a URL first'); return; }
  const label = document.getElementById('f-link-label').value.trim();
  // Auto-prefix https:// if missing
  const finalUrl = /^https?:\/\//i.test(url) ? url : 'https://' + url;
  formLinks.push({ url: finalUrl, label });
  document.getElementById('f-link-url').value = '';
  document.getElementById('f-link-label').value = '';
  renderFormLinks();
});

// Allow Enter key in link URL field to add link
document.getElementById('f-link-url').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') { e.preventDefault(); document.getElementById('add-link-btn').click(); }
});

// ============================
// CUSTOM CONFIRM DIALOG
// ============================
let confirmCallback = null;

function showConfirm(title, message, onOk, okLabel = 'Delete') {
  document.getElementById('confirm-title').textContent = title;
  document.getElementById('confirm-message').textContent = message;
  document.getElementById('confirm-ok-btn').textContent = okLabel;
  confirmCallback = onOk;
  document.getElementById('confirm-overlay').classList.add('show');
  document.getElementById('confirm-modal').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeConfirm() {
  document.getElementById('confirm-overlay').classList.remove('show');
  document.getElementById('confirm-modal').classList.remove('show');
  document.body.style.overflow = '';
  confirmCallback = null;
}

let renameCallback = null;
function showRenameModal(currentName, onRename) {
  document.getElementById('rename-input').value = currentName;
  renameCallback = onRename;
  document.getElementById('rename-overlay').classList.add('show');
  document.getElementById('rename-modal').classList.add('show');
  document.body.style.overflow = 'hidden';
  setTimeout(() => document.getElementById('rename-input').select(), 100);
}
function closeRenameModal() {
  document.getElementById('rename-overlay').classList.remove('show');
  document.getElementById('rename-modal').classList.remove('show');
  document.body.style.overflow = '';
  renameCallback = null;
}
document.getElementById('rename-ok-btn').addEventListener('click', () => {
  const val = document.getElementById('rename-input').value.trim();
  const cb = renameCallback;
  closeRenameModal();
  if (cb) cb(val);
});
document.getElementById('rename-cancel-btn').addEventListener('click', closeRenameModal);
document.getElementById('rename-overlay').addEventListener('click', closeRenameModal);
document.getElementById('rename-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') document.getElementById('rename-ok-btn').click();
  if (e.key === 'Escape') closeRenameModal();
});

document.getElementById('confirm-ok-btn').addEventListener('click', () => {
  const cb = confirmCallback;
  closeConfirm();
  if (cb) cb();
});
document.getElementById('confirm-cancel-btn').addEventListener('click', closeConfirm);
document.getElementById('confirm-overlay').addEventListener('click', closeConfirm);

// ============================
// FOLDER SYSTEM
// ============================
let activeFolder = null;
let allFolders = {}; // { cat: ['Smoothies','Dinners',...] }
let draggedEntryId = null;

function saveFolders() {
  localStorage.setItem('offstash_folders', JSON.stringify(allFolders));
}
function loadFolders() {
  try { allFolders = JSON.parse(localStorage.getItem('offstash_folders') || '{}'); }
  catch { allFolders = {}; }
}
function getFoldersForCat(cat) {
  const fromEntries = allEntries
    .filter(e => e.cat === cat && e.folder)
    .map(e => e.folder);
  const stored = allFolders[cat] || [];
  return [...new Set([...stored, ...fromEntries])].sort();
}
function getEntryCountInFolder(cat, folder) {
  return allEntries.filter(e => e.cat === cat && e.folder === folder).length;
}

function createFolder(cat, name) {
  name = name.trim();
  if (!name) return false;
  if (!allFolders[cat]) allFolders[cat] = [];
  if (!allFolders[cat].includes(name)) { allFolders[cat].push(name); saveFolders(); }
  return true;
}

function deleteFolderFromState(cat, name) {
  if (allFolders[cat]) {
    allFolders[cat] = allFolders[cat].filter(f => f !== name);
    saveFolders();
  }
  if (activeFolder === name) activeFolder = null;
}

function renderFolderRow() {
  const row = document.getElementById('folder-row');
  const pills = document.getElementById('folder-pills');
  if (!row || !pills) return;

  if (activeTab === 'all') { row.style.display = 'none'; return; }

  const folders = getFoldersForCat(activeTab);
  row.style.display = folders.length > 0 ? 'block' : 'none';

  pills.innerHTML = folders.map(f => {
    const count = getEntryCountInFolder(activeTab, f);
    const active = activeFolder === f ? ' active' : '';
    return `<button class="folder-pill${active}" data-folder="${esc(f)}"
      ondragover="folderPillDragOver(event,this)"
      ondragleave="this.classList.remove('drag-target')"
      ondrop="folderPillDrop(event,'${esc(f)}')">
      üìÅ ${esc(f)} <span style="opacity:.5;font-size:9px;">(${count})</span>
      <span class="folder-pill-del" data-delfolder="${esc(f)}" title="Delete folder">‚úï</span>
    </button>`;
  }).join('') +
  `<button class="btn-new-folder" id="btn-new-folder-inline">+ Folder</button>`;

  // bind inline new folder btn
  const inlineBtn = document.getElementById('btn-new-folder-inline');
  if (inlineBtn) inlineBtn.onclick = () => promptNewFolder(activeTab);
}

function promptNewFolder(cat) {
  // inline prompt via a small inline input
  const pills = document.getElementById('folder-pills');
  if (document.getElementById('new-folder-inline-input')) return;
  const wrap = document.createElement('div');
  wrap.style.cssText = 'display:flex;gap:6px;align-items:center;';
  wrap.innerHTML = `
    <input id="new-folder-inline-input" type="text" placeholder="Folder name‚Ä¶"
      style="height:28px;padding:0 10px;border-radius:20px;border:1px solid var(--accent);
      background:var(--input);color:var(--text);font-size:11px;font-family:var(--mono);outline:none;min-width:130px;" />
    <button id="new-folder-confirm" style="background:var(--accent);color:#000;border:none;height:28px;
      padding:0 10px;border-radius:20px;font-size:11px;font-family:var(--mono);cursor:pointer;">‚úì</button>
    <button id="new-folder-cancel" style="background:var(--bg3);color:var(--text2);border:1px solid var(--border);
      height:28px;padding:0 8px;border-radius:20px;font-size:11px;cursor:pointer;">‚úï</button>`;
  pills.appendChild(wrap);
  const input = document.getElementById('new-folder-inline-input');
  input.focus();
  const confirm = () => {
    const name = input.value.trim();
    if (name) { createFolder(cat, name); renderFolderRow(); renderGrid(); }
    else wrap.remove();
  };
  document.getElementById('new-folder-confirm').onclick = confirm;
  document.getElementById('new-folder-cancel').onclick = () => wrap.remove();
  input.onkeydown = e => { if (e.key === 'Enter') confirm(); if (e.key === 'Escape') wrap.remove(); };
}

function populateFolderSelect(entryFolder) {
  const select = document.getElementById('f-folder');
  if (!select) return;
  const cat = document.getElementById('f-cat').value;
  const folders = getFoldersForCat(cat);
  select.innerHTML = '<option value="">‚Äî No folder ‚Äî</option>' +
    folders.map(f => `<option value="${esc(f)}"${entryFolder===f?' selected':''}>${esc(f)}</option>`).join('');
}

// ‚îÄ‚îÄ Drag & drop entries into folders ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function folderPillDragOver(e, el) {
  e.preventDefault();
  el.classList.add('drag-target');
}
function folderPillDrop(e, folderName) {
  e.preventDefault();
  e.target.closest('.folder-pill')?.classList.remove('drag-target');
  if (!draggedEntryId) return;
  moveEntryToFolder(draggedEntryId, folderName);
}
async function moveEntryToFolder(id, folder) {
  const entry = allEntries.find(e => e.id === id);
  if (!entry) return;
  entry.folder = folder;
  entry.updated = Date.now();
  await dbPut(entry);
  allEntries = await dbAll();
  renderFolderRow();
  renderGrid();
  showToast(`Moved to üìÅ ${folder}`);
}

// ‚îÄ‚îÄ Folder card drag-drop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function folderCardDragOver(e, el) {
  e.preventDefault();
  el.classList.add('drag-target');
}
function folderCardDragLeave(el) {
  el.classList.remove('drag-target');
}
function folderCardDrop(e, folderName) {
  e.preventDefault();
  e.currentTarget?.classList.remove('drag-target');
  if (!draggedEntryId) return;
  moveEntryToFolder(draggedEntryId, folderName);
}

// ‚îÄ‚îÄ Folder card actions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openFolder(folderName) {
  activeFolder = folderName;
  renderFolderRow();
  renderGrid();
}

function deleteFolderAction(cat, folderName) {
  const count = getEntryCountInFolder(cat, folderName);
  const msg = count > 0
    ? `${count} entr${count===1?'y':'ies'} will be unassigned but not deleted.`
    : `This folder will be permanently removed.`;
  showConfirm(`Delete folder "${folderName}"?`, msg, async () => {
    deleteFolderFromState(cat, folderName);
    for (const entry of allEntries.filter(e => e.folder === folderName && e.cat === cat)) {
      entry.folder = null;
      entry.updated = Date.now();
      await dbPut(entry);
    }
    allEntries = await dbAll();
    renderFolderRow();
    renderGrid();
    showToast(`Folder "${folderName}" deleted`);
  });
}

function renameFolderAction(cat, oldName) {
  showRenameModal(oldName, async (trimmed) => {
    if (!trimmed || trimmed === oldName) return;
    if (allFolders[cat]) {
      const idx = allFolders[cat].indexOf(oldName);
      if (idx > -1) allFolders[cat][idx] = trimmed;
      saveFolders();
    }
    for (const entry of allEntries.filter(e => e.folder === oldName && e.cat === cat)) {
      entry.folder = trimmed;
      entry.updated = Date.now();
      await dbPut(entry);
    }
    if (activeFolder === oldName) activeFolder = trimmed;
    allEntries = await dbAll();
    renderFolderRow();
    renderGrid();
    showToast(`Renamed to "${trimmed}"`);
  });
}

// ‚îÄ‚îÄ Hook folder pill clicks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('folder-pills').addEventListener('click', e => {
  const delBtn = e.target.closest('[data-delfolder]');
  if (delBtn) {
    e.stopPropagation();
    const name = delBtn.dataset.delfolder;
    const count = getEntryCountInFolder(activeTab, name);
    const msg = count > 0
      ? `${count} entr${count===1?'y':'ies'} will be unassigned but not deleted.`
      : `This folder will be permanently removed.`;
    showConfirm(`Delete folder "${name}"?`, msg, async () => {
      deleteFolderFromState(activeTab, name);
      // Also unassign all entries in this folder
      for (const entry of allEntries.filter(e => e.folder === name && e.cat === activeTab)) {
        entry.folder = null;
        entry.updated = Date.now();
        await dbPut(entry);
      }
      allEntries = await dbAll();
      renderFolderRow(); renderGrid();
      showToast(`Folder "${name}" deleted`);
    });
    return;
  }
  const pill = e.target.closest('.folder-pill');
  if (pill && !e.target.classList.contains('folder-pill-del')) {
    const name = pill.dataset.folder;
    activeFolder = activeFolder === name ? null : name;
    renderFolderRow(); renderGrid();
  }
});

// ‚îÄ‚îÄ + Add menu ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('add-btn').addEventListener('click', (e) => {
  e.stopPropagation();
  const menu = document.getElementById('add-menu');
  const btn = document.getElementById('add-btn');
  const rect = btn.getBoundingClientRect();
  if (menu.style.display === 'none') {
    menu.style.display = 'block';
    // Position below button, aligned to right edge
    const menuHeight = menu.offsetHeight || 90;
    const spaceBelow = window.innerHeight - rect.bottom;
    // If not enough space below, flip above
    if (spaceBelow < menuHeight + 10) {
      menu.style.top = (rect.top - menuHeight - 6) + 'px';
    } else {
      menu.style.top = (rect.bottom + 6) + 'px';
    }
    menu.style.right = (window.innerWidth - rect.right) + 'px';
    menu.style.left = 'auto';
  } else {
    menu.style.display = 'none';
  }
});
document.addEventListener('click', () => {
  document.getElementById('add-menu').style.display = 'none';
});
document.getElementById('add-entry-btn').addEventListener('click', () => {
  document.getElementById('add-menu').style.display = 'none';
  // Pre-fill category and folder if one is active
  const entry = activeFolder ? { cat: activeTab !== 'all' ? activeTab : 'notes', folder: activeFolder } : null;
  openFormModal(entry, true);
});
document.getElementById('add-folder-btn').addEventListener('click', () => {
  document.getElementById('add-menu').style.display = 'none';
  if (activeTab === 'all') {
    showToast('Select a category first to add a folder');
    return;
  }
  promptNewFolder(activeTab);
  document.getElementById('folder-row').style.display = 'block';
});

// ============================================================
// INIT
// ============================================================
async function init() {
  await openDB();
  loadFolders();
  allEntries = await dbAll();
  updateSearchPlaceholder();
  renderGrid();
  renderFolderRow();
  updateOnlineStatus();

  // Register service worker
  if ('serviceWorker' in navigator) {
    try {
      const reg = await navigator.serviceWorker.register('sw.js');
      console.log('[OffStash] SW registered');
      // Listen for updates from new SW and reload to get fresh version
      navigator.serviceWorker.addEventListener('message', e => {
        if (e.data?.type === 'SW_UPDATED') {
          console.log('[OffStash] New version available, reloading‚Ä¶');
          window.location.reload();
        }
      });
      // Check for updates every time app is focused
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') reg.update();
      });
    } catch(e) {
      console.warn('[OffStash] SW registration failed', e);
    }
  }
}

init();
</script>
</body>
</html>
